<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Clase de EspaÃ±ol</title>
<link rel="stylesheet" href="style.css">
<script src="https://cdn.jsdelivr.net/npm/appwrite@13.0.0"></script>
<script src="config.js"></script>
</head>
<body>
<div id="login-screen">
<h2>SELECCIONA TU NOMBRE</h2>
<div id="names-grid" class="grid"></div>
</div>

<div id="wait-screen" class="hidden connected-screen">
<h1 class="connected-text">CONECTADO/A</h1>
<p style="margin-top: 20px; font-size: 14px; opacity: 0.7;">Espera tu turno...</p>

<div id="record-btn-container" class="hidden" style="margin-top: 40px;">
<button id="mic-btn-wait" class="mystery-btn">ðŸŽ¤</button>
<p id="status-text-wait" style="margin-top: 15px; font-size: 16px; color: #58a6ff; font-weight: bold;">ES TU TURNO - Pulsa para hablar</p>
</div>
</div>

<script>
const API_KEY = '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';
let myDocId = null;
let mediaRecorder;
let audioChunks = [];
let isRecording = false;
let wakeLock = null;

async function requestWakeLock() {
try {
if ('wakeLock' in navigator) {
wakeLock = await navigator.wakeLock.request('screen');
console.log('Wake Lock active');
}
} catch (err) {
console.error(`${err.name}, ${err.message}`);
}
}

async function loadStudents() {
try {
const response = await databases.listDocuments(CLIENT_CONFIG.databaseId, CLIENT_CONFIG.collectionId);
const grid = document.getElementById('names-grid');
response.documents.forEach(doc => {
const btn = document.createElement('button');
btn.className = 'btn';
btn.innerText = doc.name;
if(doc.status === 'online') btn.disabled = true;
btn.onclick = () => login(doc.$id);
grid.appendChild(btn);
});
} catch (e) { console.error(e); }
}
loadStudents();

async function login(id) {
myDocId = id;
await requestWakeLock();

document.getElementById('login-screen').classList.add('hidden');
document.getElementById('wait-screen').classList.remove('hidden');

await databases.updateDocument(CLIENT_CONFIG.databaseId, CLIENT_CONFIG.collectionId, myDocId, {
status: 'online', is_turn: false
});

startListeners();
}

function startListeners() {
client.subscribe(`databases.${CLIENT_CONFIG.databaseId}.collections.${CLIENT_CONFIG.collectionId}.documents.${myDocId}`, response => {
const data = response.payload;
if (data.is_turn) {
document.getElementById('record-btn-container').classList.remove('hidden');
document.body.style.backgroundColor = '#1f2428';
} else {
document.getElementById('record-btn-container').classList.add('hidden');
document.body.style.backgroundColor = '#0d1117';
const btn = document.getElementById('mic-btn-wait');
btn.classList.remove('recording');
btn.innerText = "ðŸŽ¤";
}
});
}

const micBtn = document.getElementById('mic-btn-wait');
const statusText = document.getElementById('status-text-wait');

micBtn.onclick = async () => {
if (!isRecording) {
try {
const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
const mimeType = MediaRecorder.isTypeSupported("audio/webm") ? "audio/webm" : "audio/mp4";
mediaRecorder = new MediaRecorder(stream, { mimeType });
audioChunks = [];
mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
mediaRecorder.start();
isRecording = true;
micBtn.classList.add('recording');
micBtn.innerText = "â¹";
statusText.innerText = "GRABANDO... (Habla ahora)";
} catch (e) { alert("Error de micrÃ³fono"); }
} else {
mediaRecorder.stop();
mediaRecorder.onstop = async () => {
const blob = new Blob(audioChunks, { type: mediaRecorder.mimeType });
micBtn.classList.remove('recording');
micBtn.innerText = "â³";
statusText.innerText = "PROCESANDO...";
await sendToAI(blob);
isRecording = false;
statusText.innerText = "Â¡ENVIADO!";
micBtn.innerText = "âœ“";
mediaRecorder.stream.getTracks().forEach(t => t.stop());
};
}
};

async function sendToAI(blob) {
const formData = new FormData();
const ext = blob.type.includes("mp4") ? "m4a" : "webm";
formData.append("file", blob, `recording.${ext}`);
formData.append("model", "whisper-large-v3");
formData.append("language", "es");
formData.append("temperature", "0");
formData.append("prompt", "Una frase en espaÃ±ol.");

try {
const res = await fetch("https://api.groq.com/openai/v1/audio/transcriptions", {
method: "POST",
headers: { "Authorization": `Bearer ${API_KEY}` },
body: formData
});
const data = await res.json();
if (data.text) {
await databases.updateDocument(CLIENT_CONFIG.databaseId, CLIENT_CONFIG.collectionId, myDocId, {
transcript: data.text
});
}
} catch (e) {}
}
</script>
</body>
</html>