<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clase de EspaÃ±ol</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/appwrite@13.0.0"></script>
    <script src="config.js"></script>
</head>
<body>

    <div id="login-screen">
        <h2>IDENTIFÃCATE (Ø¹Ø±Ù Ø¨Ù†ÙØ³Ùƒ)</h2>
        <div id="names-grid" class="grid">
            </div>
    </div>

    <div id="game-screen" class="hidden">
        <h3 id="status-display">CONECTADO (Ù…ØªØµÙ„)</h3>
        <p style="font-size: 12px; color: gray;">No salgas de esta pantalla...</p>
        
        <div id="play-area" class="hidden" style="margin-top: 50px;">
            <div id="unified-view">
                <p style="font-size: 20px; font-weight: bold;">Â¡Es tu turno! (Ø¯ÙˆØ±Ùƒ)</p>
                
                <button id="mic-btn" class="mic-btn">ğŸ™ï¸</button>
                
                <p id="transcript-preview" style="margin-top: 15px; color: #58a6ff;">Ø§Ø¶ØºØ· Ù„Ø¨Ø¯Ø¡ Ø§Ù„ØªØ³Ø¬ÙŠÙ„...</p>
            </div>
        </div>
    </div>

    <div id="busted-screen" class="hidden busted" style="height: 100vh; display: flex; align-items: center; justify-content: center; flex-direction: column;">
        <h1 style="font-size: 50px;">Â¡TE VI! ğŸ˜¡</h1>
        <p>Has salido del sistema.</p>
    </div>

    <script>
        let myDocId = null;
        let myOS = 'other';
        let mediaRecorder;
        let audioChunks = [];
        let isRecording = false;

        // âš ï¸ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ (Groq API Key)
        const API_KEY = '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';

        // ÙƒØ´Ù Ù†ÙˆØ¹ Ø§Ù„Ø¬Ù‡Ø§Ø² (ÙÙ‚Ø· Ù„Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª)
        const ua = navigator.userAgent.toLowerCase();
        if (ua.indexOf("android") > -1) myOS = 'android';
        else if (ua.indexOf("iphone") > -1 || ua.indexOf("ipad") > -1) myOS = 'ios';

        // 1. Ø¬Ù„Ø¨ Ø§Ù„Ø£Ø³Ù…Ø§Ø¡
        async function loadStudents() {
            try {
                const response = await databases.listDocuments(CLIENT_CONFIG.databaseId, CLIENT_CONFIG.collectionId);
                const grid = document.getElementById('names-grid');
                
                response.documents.forEach(doc => {
                    const btn = document.createElement('button');
                    btn.className = 'btn';
                    btn.innerText = doc.name;
                    if(doc.status === 'online') btn.disabled = true;
                    btn.onclick = () => login(doc.$id);
                    grid.appendChild(btn);
                });
            } catch (error) {
                console.error("Error loading students:", error);
            }
        }
        loadStudents();

        // 2. Ø§Ù„Ø¯Ø®ÙˆÙ„
        async function login(id) {
            myDocId = id;
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('game-screen').classList.remove('hidden');

            await databases.updateDocument(CLIENT_CONFIG.databaseId, CLIENT_CONFIG.collectionId, myDocId, {
                status: 'online',
                os_type: myOS,
                cheated: false,
                is_turn: false
            });

            startRealtimeListener();
            activateTrap();
        }

        // 3. Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ù„Ø£ÙˆØ§Ù…Ø± (Realtime)
        function startRealtimeListener() {
            client.subscribe(`databases.${CLIENT_CONFIG.databaseId}.collections.${CLIENT_CONFIG.collectionId}.documents.${myDocId}`, response => {
                const data = response.payload;
                
                if (data.is_turn) {
                    // Ø¥Ø¸Ù‡Ø§Ø± ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„ØªØ³Ø¬ÙŠÙ„
                    document.getElementById('play-area').classList.remove('hidden');
                    document.body.style.backgroundColor = '#161b22';
                } else {
                    // Ø¥Ø®ÙØ§Ø¡ ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„ØªØ³Ø¬ÙŠÙ„
                    document.getElementById('play-area').classList.add('hidden');
                    document.body.style.backgroundColor = '#0d1117';
                }
            });
        }

        // 4. Ù…Ù†Ø·Ù‚ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø°ÙƒÙŠ (Groq AI)
        const micBtn = document.getElementById('mic-btn');
        const transcriptPreview = document.getElementById('transcript-preview');

        micBtn.onclick = async () => {
            if (!isRecording) {
                await startRecording();
            } else {
                await stopRecordingAndTranscribe();
            }
        };

        async function startRecording() {
            transcriptPreview.innerText = "Ø¬Ø§Ø±ÙŠ ÙØªØ­ Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ†...";
            
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                
                // Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ØµÙŠØºØ© Ø§Ù„Ù…Ù†Ø§Ø³Ø¨Ø© (mp4 Ù„Ù„Ø£ÙŠÙÙˆÙ†ØŒ webm Ù„Ù„Ø£Ù†Ø¯Ø±ÙˆÙŠØ¯)
                const mimeType = MediaRecorder.isTypeSupported("audio/webm") ? "audio/webm" : "audio/mp4";
                mediaRecorder = new MediaRecorder(stream, { mimeType });
                audioChunks = [];

                mediaRecorder.ondataavailable = event => {
                    audioChunks.push(event.data);
                };

                mediaRecorder.start();
                isRecording = true;

                // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
                micBtn.innerText = "â¹ï¸";
                micBtn.style.backgroundColor = "red";
                micBtn.style.animation = "pulse 1s infinite";
                transcriptPreview.innerText = "Listening... (Ø¬Ø§Ø± Ø§Ù„ØªØ³Ø¬ÙŠÙ„)";

            } catch (err) {
                console.error(err);
                alert("Error: Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ† Ù…Ø±ÙÙˆØ¶. ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„ÙˆØµÙˆÙ„ ÙÙŠ Ø§Ù„Ù…ØªØµÙØ­.");
                transcriptPreview.innerText = "Microphone Access Denied";
            }
        }

        async function stopRecordingAndTranscribe() {
            return new Promise(resolve => {
                mediaRecorder.onstop = async () => {
                    const audioBlob = new Blob(audioChunks, { type: mediaRecorder.mimeType });
                    
                    // Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ØªØ³Ø¬ÙŠÙ„ ÙÙŠ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
                    micBtn.innerText = "â³";
                    micBtn.style.animation = "none";
                    micBtn.style.backgroundColor = "#e67e22"; // Ø¨Ø±ØªÙ‚Ø§Ù„ÙŠ
                    transcriptPreview.innerText = "Processing AI... (ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ù†Øµ)";
                    
                    // Ø¥Ø±Ø³Ø§Ù„ Ù„Ù€ Groq
                    await sendToAI(audioBlob);
                    
                    isRecording = false;
                    micBtn.innerText = "ğŸ™ï¸";
                    micBtn.style.backgroundColor = "#1f6feb";
                    resolve();
                };
                
                mediaRecorder.stop();
                // Ø¥Ø·ÙØ§Ø¡ Ø¶ÙˆØ¡ Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ†
                mediaRecorder.stream.getTracks().forEach(track => track.stop());
            });
        }

        async function sendToAI(blob) {
            const formData = new FormData();
            
            const ext = blob.type.includes("mp4") ? "m4a" : "webm";
            formData.append("file", blob, `recording.${ext}`);
            formData.append("model", "whisper-large-v3");
            
            // âœ… 1. Ø§Ù„ÙØ±Ø¶ Ø§Ù„ØµØ§Ø±Ù… Ù„Ù„ØºØ© (Ù‡Ø°Ø§ Ù‡Ùˆ Ø§Ù„Ø£Ù‡Ù…)
            formData.append("language", "es"); 
            
            // âœ… 2. Ø§Ù„Ø¯Ù‚Ø© Ø§Ù„Ù‚ØµÙˆÙ‰ (Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø¹Ø´ÙˆØ§Ø¦ÙŠØ©)
            formData.append("temperature", "0");

            // âœ… 3. Ø³ÙŠØ§Ù‚ Ø¹Ø§Ù… Ø¬Ø¯Ø§Ù‹ (Ø¨Ù„Ø§ Ø£ÙØ¹Ø§Ù„ Ù…Ø­Ø¯Ø¯Ø©)
            // Ù‡Ø°Ø§ ÙÙ‚Ø· ÙƒÙŠÙ‚ÙˆÙ„ Ù„Ù„Ù…ÙˆØ¯Ù„: "Ø±Ø§Ù‡ Ø­Ù†Ø§ ÙØ¯Ø±Ø³ Ø¥Ø³Ø¨Ø§Ù†ÙŠØ©"ØŒ Ø¨Ø§Ø´ ÙŠØ±ÙƒØ² Ø¹Ù„Ù‰ Ø§Ù„Ø¥Ù…Ù„Ø§Ø¡ Ø§Ù„ØµØ­ÙŠØ­
            formData.append("prompt", "Una frase completa en espaÃ±ol.");

            try {
                const response = await fetch("https://api.groq.com/openai/v1/audio/transcriptions", {
                    method: "POST",
                    headers: {
                        "Authorization": `Bearer ${API_KEY}`
                    },
                    body: formData
                });

                const data = await response.json();
                
                if (data.text) {
                    const text = data.text;
                    transcriptPreview.innerText = "Transcribed: " + text;
                    transcriptPreview.style.color = "#0f0";

                    await databases.updateDocument(CLIENT_CONFIG.databaseId, CLIENT_CONFIG.collectionId, myDocId, {
                        transcript: text
                    });
                } else {
                    transcriptPreview.innerText = "Error: ØµÙˆØª ØºÙŠØ± Ù…Ø³Ù…ÙˆØ¹";
                    console.error(data);
                }

            } catch (error) {
                transcriptPreview.innerText = "Error: " + error.message;
            }
        }


        
        // 5. Ø§Ù„Ù…ØµÙŠØ¯Ø© (Anti-Cheat)
        function activateTrap() {
            document.addEventListener("visibilitychange", () => {
                if (document.hidden) {
                    document.getElementById('game-screen').classList.add('hidden');
                    document.getElementById('busted-screen').classList.remove('hidden');
                    
                    databases.updateDocument(CLIENT_CONFIG.databaseId, CLIENT_CONFIG.collectionId, myDocId, {
                        cheated: true,
                        status: 'cheated'
                    });
                }
            });
        }
    </script>
</body>
</html>