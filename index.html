<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Clase</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/appwrite@13.0.0"></script>
    <script src="config.js"></script>
</head>
<body>

    <div id="login-screen">
        <h2>IDENTIFÃCATE (Ø¹Ø±Ù Ø¨Ù†ÙØ³Ùƒ)</h2>
        <div id="names-grid" class="grid">
            </div>
    </div>

    <div id="game-screen" class="hidden">
        <h3 id="status-display">CONECTADO (Ù…ØªØµÙ„)</h3>
        <p style="font-size: 12px; color: gray;">No salgas de esta pantalla...</p>
        
        <div id="play-area" class="hidden" style="margin-top: 50px;">
            
            <div id="android-view" class="hidden">
                <p>Â¡Es tu turno! (Ø¯ÙˆØ±Ùƒ)</p>
                <button id="mic-btn" class="mic-btn">ğŸ™ï¸</button>
                <p id="transcript-preview">Ø§Ø¶ØºØ· ÙˆØªØ­Ø¯Ø«...</p>
            </div>

            <div id="ios-view" class="hidden">
                <h1>ğŸ—£ï¸ Â¡HABLA!</h1>
                <p>System listening manually...</p>
            </div>
        </div>
    </div>

    <div id="busted-screen" class="hidden busted" style="height: 100vh; display: flex; align-items: center; justify-content: center; flex-direction: column;">
        <h1 style="font-size: 50px;">Â¡TE VI! ğŸ˜¡</h1>
        <p>Has salido del sistema.</p>
    </div>

    <script>
        let myDocId = null;
        let myOS = 'other';

        // 1. ØªØ­Ø¯ÙŠØ¯ Ù†ÙˆØ¹ Ø§Ù„Ø¬Ù‡Ø§Ø²
        const ua = navigator.userAgent.toLowerCase();
        if (ua.indexOf("android") > -1) myOS = 'android';
        else if (ua.indexOf("iphone") > -1 || ua.indexOf("ipad") > -1) myOS = 'ios';

        // 2. Ø¬Ù„Ø¨ Ø§Ù„Ø£Ø³Ù…Ø§Ø¡
        async function loadStudents() {
            const response = await databases.listDocuments(CLIENT_CONFIG.databaseId, CLIENT_CONFIG.collectionId);
            const grid = document.getElementById('names-grid');
            
            response.documents.forEach(doc => {
                const btn = document.createElement('button');
                btn.className = 'btn';
                btn.innerText = doc.name;
                // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø´ÙŠ Ø­Ø¯ Ø¯ÙŠØ¬Ø§ Ø¯Ø§Ø®Ù„ Ø¨Ù‡Ø§Ø¯ Ø§Ù„Ø³Ù…ÙŠØ©ØŒ Ø¯ÙŠØ²Ø§ÙƒØªÙŠÙÙŠÙ‡Ø§
                if(doc.status === 'online') btn.disabled = true;
                
                btn.onclick = () => login(doc.$id);
                grid.appendChild(btn);
            });
        }
        loadStudents();

        // 3. Ø§Ù„Ø¯Ø®ÙˆÙ„
        async function login(id) {
            myDocId = id;
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('game-screen').classList.remove('hidden');

            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¯Ø§ØªØ§Ø¨ÙŠØ²
            await databases.updateDocument(CLIENT_CONFIG.databaseId, CLIENT_CONFIG.collectionId, myDocId, {
                status: 'online',
                os_type: myOS,
                cheated: false,
                is_turn: false
            });

            // ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø© Realtime (Ø¨Ø§Ø´ Ù†Ø¹Ø±ÙÙˆ ÙˆØ§Ø´ Ù†ÙˆØ¨ØªÙŠ)
            startRealtimeListener();
            // ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù…ØµÙŠØ¯Ø©
            activateTrap();
        }

        // 4. Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ù„Ø£ÙˆØ§Ù…Ø± (Realtime)
        function startRealtimeListener() {
            client.subscribe(`databases.${CLIENT_CONFIG.databaseId}.collections.${CLIENT_CONFIG.collectionId}.documents.${myDocId}`, response => {
                const data = response.payload;
                
                if (data.is_turn) {
                    // Ø¬Ø§Øª Ù†ÙˆØ¨ØªÙŠ!
                    document.getElementById('play-area').classList.remove('hidden');
                    document.body.style.backgroundColor = '#161b22'; // Ù„ÙˆÙ† ØªÙ†Ø¨ÙŠÙ‡ Ø®ÙÙŠÙ
                    
                    if (myOS === 'android') {
                        document.getElementById('android-view').classList.remove('hidden');
                    } else {
                        document.getElementById('ios-view').classList.remove('hidden');
                    }
                } else {
                    // Ø³Ø§Ù„Ø§Øª Ù†ÙˆØ¨ØªÙŠ
                    document.getElementById('play-area').classList.add('hidden');
                    document.getElementById('android-view').classList.add('hidden');
                    document.getElementById('ios-view').classList.add('hidden');
                }
            });
        }

        // 5. Speech to Text (Android Only)
        const micBtn = document.getElementById('mic-btn');
        if ('webkitSpeechRecognition' in window) {
            const recognition = new webkitSpeechRecognition();
            recognition.lang = 'es-ES';
            recognition.continuous = false;

            micBtn.onclick = () => {
                recognition.start();
                document.getElementById('transcript-preview').innerText = "Escuchando...";
            };

            recognition.onresult = (event) => {
                const text = event.results[0][0].transcript;
                document.getElementById('transcript-preview').innerText = text;
                
                // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù†Øµ Ù„Ù„Ø£Ø³ØªØ§Ø°
                databases.updateDocument(CLIENT_CONFIG.databaseId, CLIENT_CONFIG.collectionId, myDocId, {
                    transcript: text
                });
            };
        }

        // 6. Ø§Ù„Ù…ØµÙŠØ¯Ø© (Anti-Cheat)
        function activateTrap() {
            document.addEventListener("visibilitychange", () => {
                if (document.hidden) {
                    // Ø§Ù„Ø·Ø§Ù„Ø¨ Ø®Ø±Ø¬
                    document.getElementById('game-screen').classList.add('hidden');
                    document.getElementById('busted-screen').classList.remove('hidden'); // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø´Ø§Ø´Ø© Ø§Ù„Ø­Ù…Ø±Ø§Ø¡ Ù…Ø­Ù„ÙŠØ§Ù‹
                    
                    // Ø¥Ø®Ø¨Ø§Ø± Ø§Ù„Ø£Ø³ØªØ§Ø°
                    databases.updateDocument(CLIENT_CONFIG.databaseId, CLIENT_CONFIG.collectionId, myDocId, {
                        cheated: true,
                        status: 'cheated'
                    });
                }
            });
        }
    </script>
</body>
</html>