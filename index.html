<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Acceso de Estudiante</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/appwrite@13.0.0"></script>
    <script src="config.js"></script>
    <style>
        /* --- 0. Global Reset & Fonts --- */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body {
            background-color: #0d1117;
            color: #c9d1d9;
            font-family: 'Poppins', sans-serif;
            text-align: center;
            margin: 0; padding: 20px;
            min-height: 100vh;
            display: flex; flex-direction: column; align-items: center;
            overflow-x: hidden;
        }

        /* --- 1. ÿ≤ÿ± ÿßŸÑÿ™ÿ≠ÿØŸäÿ´ (Responsive) --- */
        .refresh-btn {
            position: fixed; top: 15px; right: 15px;
            background: rgba(22, 27, 34, 0.95);
            border: 1px solid #30363d; color: #58a6ff;
            padding: 8px 14px; border-radius: 20px;
            font-size: 13px; font-weight: 600; cursor: pointer; z-index: 1000;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            backdrop-filter: blur(4px);
        }

        /* --- 2. ÿ¥ÿ®ŸÉÿ© ÿßŸÑÿ£ÿ≥ŸÖÿßÿ° (Responsive Grid) --- */
        #login-screen { width: 100%; max-width: 600px; margin-top: 40px; }
        
        #names-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(130px, 1fr)); 
            gap: 12px;
            padding-bottom: 40px;
        }

        .name-card {
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 16px;
            padding: 15px 10px;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            cursor: pointer;
            transition: transform 0.2s, border-color 0.2s;
            position: relative;
            overflow: hidden;
            animation: slideUp 0.4s ease backwards;
        }
        
        .name-card:active { transform: scale(0.96); background: #1f2428; }
        
        .avatar-circle {
            width: 45px; height: 45px;
            background: linear-gradient(135deg, #1f6feb, #0d419d);
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 18px; font-weight: bold; color: white;
            margin-bottom: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .student-name {
            font-size: 14px; font-weight: 600; color: #e6edf3;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 100%;
        }

        .name-card.disabled {
            background: #0d1117; border-color: #21262d; opacity: 0.5; pointer-events: none;
        }
        .name-card.disabled::after {
            content: 'üîí'; position: absolute; top: 8px; right: 8px; font-size: 12px;
        }

        /* --- 3. ÿ¥ÿßÿ¥ÿ© ÿßŸÑŸÖÿßŸäŸÉÿ±ŸàŸÅŸàŸÜ (Responsive Mic) --- */
        #game-screen {
            width: 100%; height: 100vh;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }

        .big-mic-circle {
            width: min(220px, 55vw); 
            height: min(220px, 55vw);
            border-radius: 50%;
            background: linear-gradient(145deg, #1f6feb, #112f55);
            border: 6px solid rgba(255,255,255,0.1); color: white;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            box-shadow: 0 10px 40px rgba(31, 111, 235, 0.3);
            transition: all 0.3s; cursor: pointer; user-select: none;
        }
        
        .mic-icon { font-size: clamp(30px, 8vw, 40px); margin-bottom: 5px; } 
        .mic-text { font-size: clamp(14px, 4vw, 18px); font-weight: bold; letter-spacing: 1px; }

        .big-mic-circle:active { transform: scale(0.95); }
        
        .big-mic-circle.recording {
            background: linear-gradient(145deg, #da3633, #8a1c1c);
            animation: pulse-red 1.5s infinite; border-color: rgba(255,0,0,0.3);
        }

        /* --- 4. ÿ¥ÿßÿ¥ÿßÿ™ ÿ£ÿÆÿ±Ÿâ & Animations --- */
        .hidden { display: none !important; }
        
        @keyframes slideUp { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes pulse-red { 0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(218, 54, 51, 0.7); } 70% { transform: scale(1.05); box-shadow: 0 0 0 20px rgba(218, 54, 51, 0); } 100% { transform: scale(1); } }

        /* Media Queries ŸÑŸÑŸáŸàÿßÿ™ŸÅ ÿßŸÑÿµÿ∫Ÿäÿ±ÿ© ÿ¨ÿØÿßŸã */
        @media (max-width: 360px) {
            #names-grid { grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); }
            .avatar-circle { width: 35px; height: 35px; font-size: 16px; }
            h2 { font-size: 1.2em; }
        }
    </style>
</head>
<body>

    <button onclick="checkMyStatus()" class="refresh-btn">üîÑ</button>

    <div id="login-screen">
        <h2 style="margin-bottom: 5px; color:#58a6ff;">Bienvenido</h2>
        <p style="color: gray; font-size: 14px; margin-bottom: 25px;">Selecciona tu nombre</p>
        <div id="names-grid">
            <p style="color:gray; font-size:14px;">Cargando...</p>
        </div>
    </div>

    <div id="wait-screen" class="hidden" style="margin-top: 30vh;">
        <h1 style="color: #3fb950; font-size: clamp(2em, 5vw, 3em);">Conectado</h1>
        <p style="margin-top: 10px; opacity: 0.6; font-size: 14px;">Espera la se√±al...</p>
        <div style="margin-top: 30px; font-size: 3em;" id="pulse-dot">üü¢</div>
    </div>

    <div id="game-screen" class="hidden">
        <h2 style="color: #58a6ff; margin-bottom: 40px; text-transform: uppercase; letter-spacing: 2px; font-size: clamp(1.2em, 5vw, 1.8em);">¬°Es tu turno!</h2>
        
        <button id="mic-btn" class="big-mic-circle">
            <span class="mic-icon">üé§</span>
            <span class="mic-text">HABLAR</span>
        </button>
        
        <p id="status-text" style="margin-top: 30px; color: #8b949e; font-size: 14px;">Toca el c√≠rculo para hablar</p>
    </div>

    <div id="busted-screen" class="hidden busted" style="height: 100vh; display: flex; align-items: center; justify-content: center; flex-direction: column;">
        <h1 style="font-size: clamp(2.5em, 10vw, 4em);">¬°TE VI! üò°</h1>
        <p style="font-size: 16px;">Saliste de la aplicaci√≥n</p>
    </div>

    <script>
        // --- LOGIC (UNTOUCHED) ---
        const API_KEY = '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';
        let myDocId = null;
        let mediaRecorder;
        let audioChunks = [];
        let isRecording = false;

        async function loadStudents() {
            try {
                const response = await databases.listDocuments(CLIENT_CONFIG.databaseId, CLIENT_CONFIG.collectionId);
                const grid = document.getElementById('names-grid');
                grid.innerHTML = '';
                
                // Sort Alphabetically
                const sortedDocs = response.documents.sort((a, b) => a.name.localeCompare(b.name));

                sortedDocs.forEach((doc, index) => {
                    const card = document.createElement('div');
                    const isTaken = doc.status === 'online';
                    card.className = `name-card ${isTaken ? 'disabled' : ''}`;
                    card.style.animationDelay = `${index * 0.03}s`; // Faster anim

                    const initial = doc.name.charAt(0).toUpperCase();

                    card.innerHTML = `
                        <div class="avatar-circle">${initial}</div>
                        <div class="student-name">${doc.name}</div>
                    `;

                    if(!isTaken) card.onclick = () => login(doc.$id);
                    grid.appendChild(card);
                });
            } catch (e) { 
                document.getElementById('names-grid').innerHTML = '<p style="color:#da3633;">‚ö†Ô∏è Error de conexi√≥n</p>';
            }
        }
        loadStudents();

        async function login(id) {
            myDocId = id;
            try { if ('wakeLock' in navigator) await navigator.wakeLock.request('screen'); } catch (err) {}
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('wait-screen').classList.remove('hidden');
            await databases.updateDocument(CLIENT_CONFIG.databaseId, CLIENT_CONFIG.collectionId, myDocId, {
                status: 'online', cheated: false, is_turn: false, transcript: "" 
            });
            startListeners();
            activateTrap();
        }

        function startListeners() {
            client.subscribe(`databases.${CLIENT_CONFIG.databaseId}.collections.${CLIENT_CONFIG.collectionId}.documents.${myDocId}`, response => {
                handleStatusChange(response.payload);
            });
        }

        async function checkMyStatus() {
            if(!myDocId) {
                loadStudents();
                const btn = document.querySelector('.refresh-btn');
                btn.style.transform = "rotate(360deg)";
                setTimeout(() => btn.style.transform = "rotate(0deg)", 500);
                return;
            }
            try {
                const doc = await databases.getDocument(CLIENT_CONFIG.databaseId, CLIENT_CONFIG.collectionId, myDocId);
                handleStatusChange(doc);
            } catch(e) {}
        }

        function handleStatusChange(data) {
            if (data.cheated) { showScreen('busted-screen'); return; }
            if (data.is_turn === true) {
                showScreen('game-screen');
                document.body.style.backgroundColor = '#0d1117';
            } else {
                showScreen('wait-screen');
                resetMicButton();
            }
        }

        function showScreen(screenId) {
            ['login-screen', 'wait-screen', 'game-screen', 'busted-screen'].forEach(id => {
                document.getElementById(id).classList.add('hidden');
            });
            document.getElementById(screenId).classList.remove('hidden');
        }

        const micBtn = document.getElementById('mic-btn');
        const statusText = document.getElementById('status-text');

        micBtn.onclick = async () => {
            if (!isRecording) {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    const mimeType = MediaRecorder.isTypeSupported("audio/webm") ? "audio/webm" : "audio/mp4";
                    mediaRecorder = new MediaRecorder(stream, { mimeType });
                    audioChunks = [];
                    mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
                    mediaRecorder.start();
                    isRecording = true;
                    micBtn.classList.add('recording');
                    micBtn.innerHTML = '<span class="mic-icon">üî¥</span><span class="mic-text">Escuchando...</span>';
                    statusText.innerText = "Toca para terminar";
                } catch (e) { alert("Error de Micr√≥fono"); }
            } else {
                if(mediaRecorder) {
                    mediaRecorder.stop();
                    mediaRecorder.onstop = async () => {
                        const blob = new Blob(audioChunks, { type: mediaRecorder.mimeType });
                        micBtn.classList.remove('recording');
                        micBtn.style.opacity = "0.7";
                        micBtn.innerHTML = '<span class="mic-icon">‚è≥</span><span class="mic-text">Enviando...</span>';
                        statusText.innerText = "Procesando...";
                        await sendToAI(blob);
                        isRecording = false;
                        mediaRecorder.stream.getTracks().forEach(t => t.stop());
                    };
                }
            }
        };

        function resetMicButton() {
            micBtn.className = 'big-mic-circle';
            micBtn.style.opacity = "1";
            micBtn.innerHTML = '<span class="mic-icon">üé§</span><span class="mic-text">HABLAR</span>';
            statusText.innerText = "Toca el c√≠rculo para hablar";
            isRecording = false;
        }

        async function sendToAI(blob) {
            const formData = new FormData();
            const ext = blob.type.includes("mp4") ? "m4a" : "webm";
            formData.append("file", blob, `recording.${ext}`);
            formData.append("model", "whisper-large-v3");
            formData.append("language", "es"); 
            formData.append("temperature", "0");

            try {
                const res = await fetch("https://api.groq.com/openai/v1/audio/transcriptions", {
                    method: "POST", headers: { "Authorization": `Bearer ${API_KEY}` }, body: formData
                });
                const data = await res.json();
                if (data.text) {
                    micBtn.innerHTML = '<span class="mic-icon">‚úì</span><span class="mic-text">Listo</span>';
                    statusText.innerText = "¬°Enviado!";
                    await databases.updateDocument(CLIENT_CONFIG.databaseId, CLIENT_CONFIG.collectionId, myDocId, { transcript: data.text });
                }
            } catch (e) { statusText.innerText = "Error"; }
        }

        function activateTrap() {
            document.addEventListener("visibilitychange", () => {
                if (document.hidden) {
                    databases.updateDocument(CLIENT_CONFIG.databaseId, CLIENT_CONFIG.collectionId, myDocId, { cheated: true, status: 'cheated' });
                    showScreen('busted-screen');
                }
            });
        }
        setInterval(() => { if(myDocId && !document.hidden) checkMyStatus(); }, 5000);
    </script>
</body>
</html>