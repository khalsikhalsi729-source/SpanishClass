<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Clase</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/appwrite@13.0.0"></script>
    <script src="config.js"></script>
</head>
<body>

    <div id="login-screen">
        <h2>IDENTIFÃCATE (Ø¹Ø±Ù Ø¨Ù†ÙØ³Ùƒ)</h2>
        <div id="names-grid" class="grid">
            </div>
    </div>

    <div id="game-screen" class="hidden">
        <h3 id="status-display">CONECTADO (Ù…ØªØµÙ„)</h3>
        <p style="font-size: 12px; color: gray;">No salgas de esta pantalla...</p>
        
        <div id="play-area" class="hidden" style="margin-top: 50px;">
            
            <div id="android-view" class="hidden">
                <p>Â¡Es tu turno! (Ø¯ÙˆØ±Ùƒ)</p>
                <button id="mic-btn" class="mic-btn">ğŸ™ï¸</button>
                <p id="transcript-preview">Ø§Ø¶ØºØ· ÙˆØªØ­Ø¯Ø«...</p>
            </div>

            <div id="ios-view" class="hidden">
                <h1>ğŸ—£ï¸ Â¡HABLA!</h1>
            </div>
        </div>
    </div>

    <div id="busted-screen" class="hidden busted" style="height: 100vh; display: flex; align-items: center; justify-content: center; flex-direction: column;">
        <h1 style="font-size: 50px;">Â¡TE VI! ğŸ˜¡</h1>
        <p>Has salido del sistema.</p>
    </div>

    <script>
        let myDocId = null;
        let myOS = 'other';
        let isRecording = false; // Ø¨Ø§Ø´ Ù†Ø¹Ø±ÙÙˆ ÙˆØ§Ø´ Ø§Ù„Ù…ÙŠÙƒØ±Ùˆ Ø®Ø¯Ø§Ù…

        const ua = navigator.userAgent.toLowerCase();
        if (ua.indexOf("android") > -1) myOS = 'android';
        else if (ua.indexOf("iphone") > -1 || ua.indexOf("ipad") > -1) myOS = 'ios';

        // 1. Ø¬Ù„Ø¨ Ø§Ù„Ø£Ø³Ù…Ø§Ø¡
        async function loadStudents() {
            try {
                const response = await databases.listDocuments(CLIENT_CONFIG.databaseId, CLIENT_CONFIG.collectionId);
                const grid = document.getElementById('names-grid');
                
                response.documents.forEach(doc => {
                    const btn = document.createElement('button');
                    btn.className = 'btn';
                    btn.innerText = doc.name;
                    if(doc.status === 'online') btn.disabled = true;
                    btn.onclick = () => login(doc.$id);
                    grid.appendChild(btn);
                });
            } catch (error) {
                console.error("Error:", error);
            }
        }
        loadStudents();

        // 2. Ø§Ù„Ø¯Ø®ÙˆÙ„
        async function login(id) {
            myDocId = id;
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('game-screen').classList.remove('hidden');

            await databases.updateDocument(CLIENT_CONFIG.databaseId, CLIENT_CONFIG.collectionId, myDocId, {
                status: 'online',
                os_type: myOS,
                cheated: false,
                is_turn: false
            });

            startRealtimeListener();
            activateTrap();
        }

        // 3. Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ (Realtime)
        function startRealtimeListener() {
            client.subscribe(`databases.${CLIENT_CONFIG.databaseId}.collections.${CLIENT_CONFIG.collectionId}.documents.${myDocId}`, response => {
                const data = response.payload;
                
                if (data.is_turn) {
                    document.getElementById('play-area').classList.remove('hidden');
                    document.body.style.backgroundColor = '#161b22';
                    document.getElementById('android-view').classList.remove('hidden');
                    document.getElementById('ios-view').classList.add('hidden');
                } else {
                    document.getElementById('play-area').classList.add('hidden');
                    document.getElementById('android-view').classList.add('hidden');
                    document.body.style.backgroundColor = '#0d1117';
                }
            });
        }

        // 4. Speech to Text (Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ù…ØµØ­Ø­ Ù„Ù„Ø£ÙŠÙÙˆÙ†)
        const micBtn = document.getElementById('mic-btn');
        const transcriptPreview = document.getElementById('transcript-preview');

        if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            const recognition = new SpeechRecognition();
            
            recognition.lang = 'es-ES';
            recognition.continuous = false;
            recognition.interimResults = false;

            // Ø£Ø­Ø¯Ø§Ø« Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ†
            recognition.onstart = () => {
                isRecording = true;
                micBtn.innerText = "â¹ï¸"; // ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø©
                micBtn.style.animation = "pulse 1s infinite";
                transcriptPreview.innerText = "Escuchando... (ØªØ­Ø¯Ø« Ø§Ù„Ø¢Ù†)";
                micBtn.style.backgroundColor = "red"; // Ù„ÙˆÙ† Ø£Ø­Ù…Ø± Ø¨Ø§Ø´ ÙŠØ¨Ø§Ù† Ø®Ø¯Ø§Ù…
            };

            recognition.onend = () => {
                isRecording = false;
                micBtn.innerText = "ğŸ™ï¸";
                micBtn.style.animation = "none";
                micBtn.style.backgroundColor = "#1f6feb"; // Ø±Ø¬ÙˆØ¹ Ù„Ù„ÙˆÙ† Ø§Ù„Ø£ØµÙ„ÙŠ
            };

            recognition.onresult = (event) => {
                const text = event.results[0][0].transcript;
                transcriptPreview.innerText = "Grave: " + text;
                
                databases.updateDocument(CLIENT_CONFIG.databaseId, CLIENT_CONFIG.collectionId, myDocId, {
                    transcript: text
                });
            };

            recognition.onerror = (event) => {
                // Ù‡Ù†Ø§ ÙƒÙ†Ø­Ø¨Ø³Ùˆ Ø§Ù„Ù…ÙŠÙƒØ±Ùˆ Ø¨Ù„Ø§ Ù…Ø§ Ù†Ø·Ù„Ø¹Ùˆ Alert Ù…Ø²Ø¹Ø¬Ø©
                recognition.stop();
                transcriptPreview.innerText = "Ø®Ø·Ø£ Ø¨Ø³ÙŠØ·ØŒ Ø§Ø¶ØºØ· Ù…Ø¬Ø¯Ø¯Ø§Ù‹.";
            };

            // Ø§Ù„Ø²Ø± Ø§Ù„Ø³Ø­Ø±ÙŠ (Toggle)
            micBtn.onclick = () => {
                if (isRecording) {
                    recognition.stop(); // Ø¥Ù„Ø§ ÙƒØ§Ù† Ø®Ø¯Ø§Ù…ØŒ Ø·ÙÙŠÙ‡
                } else {
                    try {
                        recognition.start(); // Ø¥Ù„Ø§ ÙƒØ§Ù† Ø·Ø§ÙÙŠØŒ Ø´Ø¹Ù„Ùˆ
                    } catch (e) {
                        recognition.stop(); // ÙÙŠ Ø­Ø§Ù„Ø© Ø§Ù„ØªØ¨Ù„ÙˆÙƒØŒ Ø±ÙŠØ³ØªØ§Ø±Øª
                    }
                }
            };

        } else {
            transcriptPreview.innerText = "Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ¯Ø¹Ù… Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ†";
        }

        // 5. Ø§Ù„Ù…ØµÙŠØ¯Ø©
        function activateTrap() {
            document.addEventListener("visibilitychange", () => {
                if (document.hidden) {
                    document.getElementById('game-screen').classList.add('hidden');
                    document.getElementById('busted-screen').classList.remove('hidden');
                    
                    databases.updateDocument(CLIENT_CONFIG.databaseId, CLIENT_CONFIG.collectionId, myDocId, {
                        cheated: true
                    });
                }
            });
        }
    </script>
</body>
</html>