<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Panel de Profesor</title>
<link rel="stylesheet" href="style.css">
<script src="https://cdn.jsdelivr.net/npm/appwrite@13.0.0"></script>
<script src="config.js"></script>
<style>
.control-bar { display: flex; justify-content: space-between; background: #161b22; padding: 15px; border-bottom: 2px solid #30363d; }
.mode-title { color: #58a6ff; font-weight: bold; font-size: 24px; text-transform: uppercase; }
.current-turn-box { text-align: center; margin: 20px auto; padding: 30px; border: 3px solid #58a6ff; border-radius: 15px; background: #0d1117; width: 60%; box-shadow: 0 0 20px rgba(88, 166, 255, 0.2); }
.active-speaker { font-size: 3.5em; color: #58a6ff; margin: 10px 0; font-weight: bold; min-height: 1.2em; }
.history-btn { background: #e3b341; color: #000; font-weight: bold; margin-left: 10px; }
#history-modal { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 60%; max-height: 70vh; background: #161b22; border: 2px solid #58a6ff; border-radius: 10px; z-index: 1000; overflow-y: auto; padding: 20px; box-shadow: 0 0 50px rgba(0,0,0,0.8); }
.history-item { border-bottom: 1px solid #30363d; padding: 10px; display: flex; justify-content: space-between; color: #c9d1d9; }
.history-item span { font-weight: bold; color: #58a6ff; }
.close-hist { float: right; color: red; cursor: pointer; font-size: 20px; }
#grouping-canvas { position: relative; height: 60vh; width: 100%; margin-top: 20px; }
.group-box { position: absolute; width: 30%; height: 80%; border: 2px solid; border-radius: 10px; padding: 10px; overflow-y: auto; background: rgba(22, 27, 34, 0.8); }
.group-1 { left: 2%; border-color: #d2a8ff; } .group-2 { left: 35%; border-color: #79c0ff; } .group-3 { right: 2%; border-color: #56d364; }
.floating-name { position: absolute; padding: 10px; background: #238636; color: white; border-radius: 20px; transition: all 1s ease; }
.transcript-revealed { color: #e3b341; font-size: 1.5em; font-weight: bold; margin-top: 20px; }
</style>
</head>
<body>

<div class="control-bar">
    <div class="mode-title" id="mode-title">MODO: MONITOR</div>
    <div>
        <button class="btn btn-action" onclick="switchMode('monitor')">üìä MONITOR</button>
        <button class="btn btn-action" onclick="switchMode('turn')">üé∞ RULETA</button>
        <button class="btn btn-action" onclick="switchMode('group')">üß© GRUPOS</button>
        <button class="btn btn-action history-btn" onclick="toggleHistory()">üìú HISTORIAL</button>
        <button class="btn btn-danger" onclick="resetAll()" style="width: auto;">üîÑ RESET</button>
    </div>
</div>

<div id="history-modal">
    <span class="close-hist" onclick="toggleHistory()">‚úñ</span>
    <h2 style="text-align: center; color: white;">HISTORIAL</h2>
    <div id="history-content"></div>
</div>

<div id="monitor-view" class="dashboard-grid grid" style="padding: 20px;"></div>

<div id="turn-view" class="hidden">
    <div style="text-align: center; margin-top: 30px;">
        <button id="next-btn" class="btn" onclick="startRoulette()" style="width: 300px; font-size: 24px; background: #1f6feb;">üé≤ GIRAR RULETA</button>
    </div>
    <div id="active-turn-card" class="current-turn-box hidden">
        <p style="color: gray; text-transform: uppercase; letter-spacing: 2px;">HABLANDO AHORA</p>
        
        <div id="speaker-name" class="active-speaker">...</div>
        
        <div id="loading-response" class="hidden" style="color: #e3b341; margin: 15px; font-style: italic;">
            ‚è≥ Esperando respuesta...
        </div>

        <div id="speaker-text-current" class="transcript-revealed" style="margin-top: 15px; min-height: 40px;"></div>
    </div>
</div>

<div id="group-view" class="hidden">
    <div style="text-align: center; padding: 10px;">
        <button class="btn btn-action" onclick="startGroupingAnimation()">‚≠ê DISTRIBUIR</button>
    </div>
    <div id="grouping-canvas">
        <div class="group-box group-1"><h3 style="color: #d2a8ff;">GRUPO 1</h3></div>
        <div class="group-box group-2"><h3 style="color: #79c0ff;">GRUPO 2</h3></div>
        <div class="group-box group-3"><h3 style="color: #56d364;">GRUPO 3</h3></div>
    </div>
</div>

<script>
const GROUPS = {
    "Fatima zahra": 1, "Hamza": 1, "Othmane": 1, "Omar": 1,
    "Souhail": 2, "Zakariya": 2, "Marwa": 2, "Malak": 2,
    "Hiba": 3, "Aya G.": 3, "Aya B.": 3, "Aya Z.": 3
};

let studentsData = [];
let currentSpeaker = null;
let lastGroupPlayed = null;
let playedStudents = [];

async function init() {
    const res = await databases.listDocuments(CLIENT_CONFIG.databaseId, CLIENT_CONFIG.collectionId);
    studentsData = res.documents;
    renderMonitor();

    client.subscribe(`databases.${CLIENT_CONFIG.databaseId}.collections.${CLIENT_CONFIG.collectionId}.documents`, response => {
        const doc = response.payload;
        const idx = studentsData.findIndex(s => s.$id === doc.$id);
        if (idx !== -1) studentsData[idx] = doc;
        renderMonitor();

        if (currentSpeaker && currentSpeaker.$id === doc.$id && doc.transcript) {
            currentSpeaker.transcript = doc.transcript;
            
            // ÿ•ÿÆŸÅÿßÿ° ÿßŸÑŸÄ Loading
            const loadingEl = document.getElementById('loading-response');
            if(loadingEl) loadingEl.classList.add('hidden');

            // ÿ•ÿ∏Ÿáÿßÿ± ÿßŸÑŸÜÿµ ŸÖÿ®ÿßÿ¥ÿ±ÿ©
            const textBox = document.getElementById('speaker-text-current');
            textBox.innerText = `"${doc.transcript}"`;
            
            addToHistoryList(doc.name, doc.transcript);
        }
    });
}
init();

function renderMonitor() {
    const container = document.getElementById('monitor-view');
    container.innerHTML = '';
    studentsData.forEach(s => {
        if (s.status !== 'online') return;
        const card = document.createElement('div');
        card.className = `card ${s.is_turn ? 'speaking' : ''}`;
        card.innerHTML = `<h3>${s.name}</h3><p>CONECTADO</p>`;
        card.style.border = "1px solid #30363d";
        card.style.background = "#161b22";
        card.style.padding = "10px";
        container.appendChild(card);
    });
}

function startRoulette() {
    // Reset UI
    if (currentSpeaker) {
        databases.updateDocument(CLIENT_CONFIG.databaseId, CLIENT_CONFIG.collectionId, currentSpeaker.$id, { is_turn: false });
    }
    
    document.getElementById('active-turn-card').classList.remove('hidden');
    // ÿ£ÿÆŸÅŸäŸÜÿß Loading ŸÅŸä ÿßŸÑÿ®ÿØÿßŸäÿ©
    const loadingEl = document.getElementById('loading-response');
    if(loadingEl) loadingEl.classList.add('hidden');
    
    document.getElementById('speaker-text-current').innerText = "";
    
    const nextBtn = document.getElementById('next-btn');
    nextBtn.disabled = true;

    // Logic
    let eligible = studentsData.filter(s => s.status === 'online');
    let pool = eligible.filter(s => !playedStudents.includes(s.$id));
    
    if (pool.length === 0) {
        playedStudents = [];
        pool = eligible;
    }

    if (pool.length === 0) { alert("¬°Nadie conectado!"); nextBtn.disabled = false; return; }

    let candidates = pool.filter(s => GROUPS[s.name] !== lastGroupPlayed);
    if (candidates.length === 0) candidates = pool;

    const winner = candidates[Math.floor(Math.random() * candidates.length)];

    // Animation
    const nameBox = document.getElementById('speaker-name');
    let counter = 0;
    const maxSpins = 20; 
    
    const interval = setInterval(() => {
        const randomName = eligible[Math.floor(Math.random() * eligible.length)].name;
        nameBox.innerText = randomName;
        counter++;
        if (counter >= maxSpins) {
            clearInterval(interval);
            finalizeTurn(winner);
        }
    }, 80);
}

async function finalizeTurn(student) {
    document.getElementById('speaker-name').innerText = student.name;
    document.getElementById('next-btn').disabled = false;
    
    currentSpeaker = student;
    lastGroupPlayed = GROUPS[student.name];
    playedStudents.push(student.$id);

    // ÿØÿßÿ®ÿß ÿπÿßÿØ Ÿäÿ®ÿßŸÜ ÿßŸÑŸÄ Loading
    const loadingEl = document.getElementById('loading-response');
    if(loadingEl) {
        loadingEl.classList.remove('hidden');
        loadingEl.innerText = `‚è≥ Esperando respuesta de ${student.name}...`;
    }

    await databases.updateDocument(CLIENT_CONFIG.databaseId, CLIENT_CONFIG.collectionId, student.$id, { is_turn: true, transcript: "" });
}

function toggleHistory() {
    const modal = document.getElementById('history-modal');
    modal.style.display = modal.style.display === 'block' ? 'none' : 'block';
}

function addToHistoryList(name, text) {
    const container = document.getElementById('history-content');
    const div = document.createElement('div');
    div.className = 'history-item';
    div.innerHTML = `<div><span>${name}</span>: "${text}"</div>`;
    container.insertBefore(div, container.firstChild);
}

function startGroupingAnimation() {
    const canvas = document.getElementById('grouping-canvas');
    document.querySelectorAll('.floating-name').forEach(e => e.remove());
    const activeStudents = studentsData.filter(s => s.status === 'online');

    activeStudents.forEach(s => {
        const el = document.createElement('div');
        el.className = 'floating-name';
        el.innerText = s.name;
        el.dataset.name = s.name;
        el.style.left = (canvas.clientWidth / 2) + 'px';
        el.style.top = (canvas.clientHeight / 2) + 'px';
        canvas.appendChild(el);
    });

    setTimeout(() => {
        document.querySelectorAll('.floating-name').forEach(el => {
            const name = el.dataset.name;
            const groupNum = GROUPS[name] || 2;
            let targetX, targetY;
            if (groupNum === 1) targetX = canvas.clientWidth * 0.05; 
            else if (groupNum === 2) targetX = canvas.clientWidth * 0.38;
            else targetX = canvas.clientWidth * 0.70;
            targetY = 50 + (Math.random() * 200);
            el.style.left = targetX + 'px';
            el.style.top = targetY + 'px';
        });
    }, 500);
}

function switchMode(mode) {
    document.getElementById('monitor-view').classList.add('hidden');
    document.getElementById('turn-view').classList.add('hidden');
    document.getElementById('group-view').classList.add('hidden');
    if (mode === 'monitor') {
        document.getElementById('monitor-view').classList.remove('hidden');
        document.getElementById('mode-title').innerText = "MODO: MONITOR";
    } else if (mode === 'turn') {
        document.getElementById('turn-view').classList.remove('hidden');
        document.getElementById('mode-title').innerText = "MODO: TURNOS";
    } else if (mode === 'group') {
        document.getElementById('group-view').classList.remove('hidden');
        document.getElementById('grouping-canvas').style.display = 'block';
        document.getElementById('mode-title').innerText = "MODO: GRUPOS";
    }
}

async function resetAll() {
    if(confirm("¬øReiniciar sistema?")) {
        studentsData.forEach(s => {
            databases.updateDocument(CLIENT_CONFIG.databaseId, CLIENT_CONFIG.collectionId, s.$id, { status: 'offline', cheated: false, is_turn: false, transcript: "" });
        });
        location.reload();
    }
}
</script>
</body>
</html>