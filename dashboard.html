<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Panel de Profesor - Casino Mode</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/appwrite@13.0.0"></script>
    <script src="config.js"></script>
    <style>
        .control-bar { display: flex; align-items: center; gap: 10px; background: #161b22; padding: 15px; border-bottom: 2px solid #30363d; flex-wrap: wrap;}
        .mode-title { color: #58a6ff; font-weight: bold; font-size: 24px; text-transform: uppercase; margin-right: auto; }
        
        /* Roulette Animation Styles */
        .roulette-box {
            font-size: 4em; font-weight: bold; color: #58a6ff; 
            text-shadow: 0 0 20px rgba(88, 166, 255, 0.5);
            min-height: 1.5em; display: flex; align-items: center; justify-content: center;
        }
        .roulette-spinning { color: #8b949e; animation: shake 0.1s infinite; }
        
        @keyframes shake { 0% { transform: rotate(0deg); } 25% { transform: rotate(2deg); } 75% { transform: rotate(-2deg); } 100% { transform: rotate(0deg); } }

        /* Groups UI Enhancements */
        .group-container-grid {
            display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; height: 70vh; padding: 20px;
        }
        .group-column {
            background: #0d1117; border: 2px solid; border-radius: 12px; padding: 15px;
            display: flex; flex-direction: column; gap: 10px;
        }
        .group-header { font-size: 24px; text-align: center; text-transform: uppercase; padding-bottom: 10px; border-bottom: 1px solid rgba(255,255,255,0.1); margin-bottom: 10px;}
        .student-chip { padding: 10px; background: rgba(255,255,255,0.05); border-radius: 6px; font-size: 18px; text-align: center; }

        /* History Modal */
        #history-modal {
            position: fixed; top: 10%; left: 10%; width: 80%; height: 80%;
            background: #161b22; border: 2px solid #58a6ff; z-index: 1000;
            overflow-y: auto; padding: 20px; border-radius: 10px; box-shadow: 0 0 50px rgba(0,0,0,0.8);
        }
        .close-btn { float: right; cursor: pointer; font-size: 30px; color: red; }
    </style>
</head>
<body>

<div class="control-bar">
    <div class="mode-title" id="mode-title">MODO: TURNOS</div>
    
    <button class="btn btn-action" onclick="switchMode('turn')">üé∞ RULETA</button>
    <button class="btn btn-action" onclick="switchMode('group')">üß© GRUPOS UI</button>
    <button class="btn btn-action" onclick="toggleHistory()" style="background: #e3b341; color: black;">üìú HISTORIAL</button>
    <button class="btn btn-danger" onclick="resetAll()" style="width: auto;">üîÑ RESET</button>
</div>

<div id="turn-view">
    <div style="text-align: center; margin-top: 50px;">
        <button id="next-btn" class="btn" onclick="spinRoulette()" style="width: 300px; font-size: 30px; background: #1f6feb; padding: 20px;">
            üé≤ GIRAR RULETA
        </button>
    </div>

    <div id="active-turn-card" class="current-turn-box">
        <p style="color: gray; text-transform: uppercase; letter-spacing: 2px;">TURNO DE:</p>
        <div id="speaker-name" class="roulette-box">???</div>
        
        <div id="status-indicator" style="margin: 20px; color: #e3b341; font-style: italic;" class="hidden">
            ‚è≥ Esperando audio...
        </div>

     
        <div id="speaker-text-current" class="transcript-hidden" style="margin-top: 15px; font-size: 28px; min-height: 60px;"></div>
    </div>
</div>

<div id="group-view" class="hidden">
    <div class="group-container-grid">
        <div class="group-column" style="border-color: #d2a8ff;">
            <div class="group-header" style="color: #d2a8ff;">GRUPO 1</div>
            <div id="list-g1"></div>
        </div>
        <div class="group-column" style="border-color: #79c0ff;">
            <div class="group-header" style="color: #79c0ff;">GRUPO 2</div>
            <div id="list-g2"></div>
        </div>
        <div class="group-column" style="border-color: #56d364;">
            <div class="group-header" style="color: #56d364;">GRUPO 3</div>
            <div id="list-g3"></div>
        </div>
    </div>
</div>

<div id="history-modal" class="hidden">
    <span class="close-btn" onclick="toggleHistory()">‚úñ</span>
    <h2 style="color: #58a6ff; text-align: center;">HISTORIAL DE RESPUESTAS</h2>
    <div id="history-list" class="history-container"></div>
</div>

<script>
// CONFIGURACI√ìN DE GRUPOS
const GROUPS = {
    "Fatima zahra": 1, "Hamza": 1, "Othmane": 1, "Omar": 1,
    "Souhail": 2, "Zakariya": 2, "Marwa": 2, "Malak": 2,
    "Hiba": 3, "Aya G.": 3, "Aya B.": 3, "Aya Z.": 3
};

let studentsData = [];
let currentSpeaker = null;
let lastGroupIndex = null; // To track previous group
let availablePool = []; // For the "Cycle" logic

async function init() {
    const res = await databases.listDocuments(CLIENT_CONFIG.databaseId, CLIENT_CONFIG.collectionId);
    studentsData = res.documents;
    renderGroupsUI();
    
    // Subscribe to changes (Transcript updates)
    client.subscribe(`databases.${CLIENT_CONFIG.databaseId}.collections.${CLIENT_CONFIG.collectionId}.documents`, response => {
        const doc = response.payload;
        
        // Update local data
        const idx = studentsData.findIndex(s => s.$id === doc.$id);
        if (idx !== -1) studentsData[idx] = doc;

        // If the current speaker sends a transcript
        if (currentSpeaker && currentSpeaker.$id === doc.$id && doc.transcript) {
            currentSpeaker.transcript = doc.transcript;
            
            // UI Logic: Transcript arrived
            document.getElementById('status-indicator').classList.add('hidden');
            document.getElementById('reveal-btn-current').classList.remove('hidden'); // Show button NOW
            
            const textBox = document.getElementById('speaker-text-current');
            textBox.dataset.text = doc.transcript;
            textBox.innerText = "¬°AUDIO RECIBIDO! (Ver Historial)";
            
            // Automatically add to history log (background)
            addToHistory(doc);
        }
    });
}
init();

// --- LOGIC: SMART SELECTION & ROULETTE ---

function getEligibleStudents() {
    return studentsData.filter(s => s.status === 'online');
}

function pickSmartStudent() {
    const onlineStudents = getEligibleStudents();
    
    if (onlineStudents.length === 0) return null;

    // 1. Initialize Pool if empty (Cycle Logic)
    // Filter availablePool to only include currently online students
    let validPool = availablePool.filter(id => onlineStudents.some(s => s.$id === id));
    
    if (validPool.length === 0) {
        // Refill pool with all online students
        validPool = onlineStudents.map(s => s.$id);
    }

    // 2. Filter by Group (Don't pick same group twice consecutively)
    let candidates = onlineStudents.filter(s => validPool.includes(s.$id));
    
    // Try to find someone from a different group
    let bestCandidates = candidates.filter(s => GROUPS[s.name] !== lastGroupIndex);
    
    // Fallback: If everyone left is from the same group, you must pick them
    if (bestCandidates.length === 0) {
        bestCandidates = candidates;
    }

    // 3. Pick Randomly from Best Candidates
    const winner = bestCandidates[Math.floor(Math.random() * bestCandidates.length)];

    // 4. Update State
    availablePool = validPool.filter(id => id !== winner.$id); // Remove from pool
    lastGroupIndex = GROUPS[winner.name]; // Remember group
    
    return winner;
}

async function spinRoulette() {
    // UI Cleanup
    if (currentSpeaker) {
        // Reset previous speaker
        databases.updateDocument(CLIENT_CONFIG.databaseId, CLIENT_CONFIG.collectionId, currentSpeaker.$id, { is_turn: false });
    }
    document.getElementById('reveal-btn-current').classList.add('hidden');
    document.getElementById('status-indicator').classList.add('hidden');
    document.getElementById('speaker-text-current').innerText = "";
    
    const online = getEligibleStudents();
    if (online.length === 0) { alert("¬°Nadie conectado!"); return; }

    const nameDisplay = document.getElementById('speaker-name');
    nameDisplay.classList.add('roulette-spinning');
    const nextBtn = document.getElementById('next-btn');
    nextBtn.disabled = true;

    // The Logic Selection happens instantly
    const winner = pickSmartStudent();
    currentSpeaker = winner;

    // Visual Effect (Casino Wheel)
    let counter = 0;
    const maxSpins = 20; // How many names to flash
    const interval = setInterval(() => {
        // Flash random names
        const randomName = online[Math.floor(Math.random() * online.length)].name;
        nameDisplay.innerText = randomName;
        counter++;

        if (counter >= maxSpins) {
            clearInterval(interval);
            finalizeTurn(winner);
        }
    }, 100); // Speed of spin
}

async function finalizeTurn(student) {
    const nameDisplay = document.getElementById('speaker-name');
    nameDisplay.classList.remove('roulette-spinning');
    nameDisplay.innerText = student.name;
    document.getElementById('next-btn').disabled = false;
    
    // Show "Waiting" status
    document.getElementById('status-indicator').classList.remove('hidden');
    document.getElementById('status-indicator').innerText = "‚è≥ Esperando audio de " + student.name + "...";

    // DB Update
    await databases.updateDocument(CLIENT_CONFIG.databaseId, CLIENT_CONFIG.collectionId, student.$id, { 
        is_turn: true, 
        transcript: "" 
    });
}

function revealCurrent() {
    const textBox = document.getElementById('speaker-text-current');
    const text = textBox.dataset.text || "";
    textBox.innerText = `"${text}"`;
    textBox.className = "transcript-revealed";
}

// --- UI: GROUPS & HISTORY ---

function renderGroupsUI() {
    ['1', '2', '3'].forEach(g => document.getElementById(`list-g${g}`).innerHTML = '');
    
    studentsData.forEach(s => {
        const gNum = GROUPS[s.name] || 1;
        const el = document.createElement('div');
        el.className = 'student-chip';
        el.innerText = s.name;
        el.style.color = s.status === 'online' ? '#fff' : '#444';
        el.style.border = s.status === 'online' ? '1px solid white' : '1px dashed #444';
        document.getElementById(`list-g${gNum}`).appendChild(el);
    });
}

function addToHistory(student) {
    const list = document.getElementById('history-list');
    const div = document.createElement('div');
    div.className = 'history-card';
    div.style.width = "90%"; // Fix for modal width
    
    div.innerHTML = `
        <span class="history-name">${student.name}</span>
        <p style="color: #8b949e; margin: 0 10px;">${student.transcript}</p>
    `;
    list.insertBefore(div, list.firstChild);
}

function toggleHistory() {
    const modal = document.getElementById('history-modal');
    modal.classList.toggle('hidden');
}

function switchMode(mode) {
    document.getElementById('turn-view').classList.add('hidden');
    document.getElementById('group-view').classList.add('hidden');
    
    if (mode === 'turn') document.getElementById('turn-view').classList.remove('hidden');
    if (mode === 'group') {
        renderGroupsUI();
        document.getElementById('group-view').classList.remove('hidden');
    }
}

async function resetAll() {
    if(confirm("¬øReiniciar sistema?")) {
        studentsData.forEach(s => {
            databases.updateDocument(CLIENT_CONFIG.databaseId, CLIENT_CONFIG.collectionId, s.$id, { 
                status: 'offline', is_turn: false, transcript: "" 
            });
        });
        location.reload();
    }
}
</script>
</body>
</html>