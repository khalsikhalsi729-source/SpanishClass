<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Panel de Profesor</title>
<link rel="stylesheet" href="style.css">
<script src="https://cdn.jsdelivr.net/npm/appwrite@13.0.0"></script>
<script src="config.js"></script>
<style>
/* Dashboard Layout */
.control-bar { display: flex; flex-wrap: wrap; gap: 10px; background: #161b22; padding: 15px; border-bottom: 2px solid #30363d; align-items: center; }
.mode-title { color: #58a6ff; font-weight: bold; font-size: 24px; margin-right: auto; }

/* Turn/Roulette Styles */
.current-turn-box { 
    text-align: center; margin: 20px auto; padding: 30px; 
    border: 3px solid #58a6ff; border-radius: 15px; background: #0d1117; width: 70%; 
}
.active-speaker { font-size: 4em; color: #58a6ff; margin: 10px 0; font-weight: bold; min-height: 1.2em; text-shadow: 0 0 15px rgba(88, 166, 255, 0.3); }

/* History Modal */
#history-modal { 
    display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); 
    width: 60%; max-height: 80vh; background: #0d1117; border: 2px solid #e3b341; 
    border-radius: 10px; z-index: 2000; overflow-y: auto; padding: 20px; box-shadow: 0 0 100px rgba(0,0,0,0.9); 
}
.history-row { 
    display: flex; justify-content: space-between; border-bottom: 1px solid #30363d; 
    padding: 15px; align-items: center; 
}
.history-name { color: #58a6ff; font-weight: bold; font-size: 1.1em; width: 30%; }
.history-text { color: #c9d1d9; width: 65%; font-style: italic; }

/* Groups Grid Layout (Clear View) */
.groups-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; padding: 20px; }
.group-col { background: #161b22; border: 2px solid; border-radius: 8px; padding: 10px; min-height: 300px; }
.group-title { text-align: center; font-size: 1.5em; margin-bottom: 15px; font-weight: bold; text-transform: uppercase; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 10px; }
.student-item { 
    padding: 8px; margin: 5px 0; background: rgba(255,255,255,0.05); 
    border-radius: 4px; font-size: 1.1em; display: flex; justify-content: space-between;
}
.online-dot { height: 10px; width: 10px; border-radius: 50%; background: #238636; display: inline-block; }
.offline-dot { height: 10px; width: 10px; border-radius: 50%; background: #da3633; display: inline-block; }

.transcript-revealed { color: #e3b341; font-size: 1.8em; font-weight: bold; margin-top: 20px; animation: popIn 0.5s ease; }
@keyframes popIn { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }
</style>
</head>
<body>

<div class="control-bar">
    <div class="mode-title" id="mode-title">MODO: MONITOR</div>
    <button class="btn btn-action" onclick="switchMode('monitor')">üìä MONITOR</button>
    <button class="btn btn-action" onclick="switchMode('turn')">üé∞ RULETA</button>
    <button class="btn btn-action" onclick="switchMode('group')">üß© GRUPOS UI</button>
    <button class="btn btn-action" style="background: #e3b341; color: black;" onclick="toggleHistory()">üìú HISTORIAL</button>
    <button class="btn btn-danger" onclick="resetAll()">üîÑ RESET</button>
</div>

<div id="history-modal">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h2 style="color: #e3b341; margin: 0;">üìú HISTORIAL DE RESPUESTAS</h2>
        <button onclick="toggleHistory()" style="background: none; border: none; color: red; font-size: 24px; cursor: pointer;">‚úñ</button>
    </div>
    <div id="history-content">
        <p style="text-align: center; color: gray;">No hay respuestas todav√≠a.</p>
    </div>
</div>

<div id="monitor-view" class="dashboard-grid grid" style="padding: 20px;"></div>

<div id="turn-view" class="hidden">
    <div style="text-align: center; margin-top: 40px;">
        <button id="next-btn" class="btn" onclick="startRoulette()" style="width: 300px; font-size: 28px; background: #1f6feb; padding: 20px;">
            üé≤ GIRAR RULETA
        </button>
    </div>
    
    <div id="active-turn-card" class="current-turn-box hidden">
        <p style="color: gray; text-transform: uppercase; letter-spacing: 2px; margin-bottom: 10px;">TURNO DE:</p>
        
        <div id="speaker-name" class="active-speaker">...</div>
        
        <div id="loading-response" class="hidden" style="color: #e3b341; margin: 20px; font-size: 1.2em;">
            ‚è≥ Esperando audio del estudiante...
        </div>
        
        <div id="speaker-text-current" class="transcript-revealed" style="min-height: 40px;"></div>
    </div>
</div>

<div id="group-view" class="hidden">
    <div class="groups-grid">
        <div class="group-col" style="border-color: #d2a8ff;">
            <div class="group-title" style="color: #d2a8ff;">GRUPO 1</div>
            <div id="g1-list"></div>
        </div>
        <div class="group-col" style="border-color: #79c0ff;">
            <div class="group-title" style="color: #79c0ff;">GRUPO 2</div>
            <div id="g2-list"></div>
        </div>
        <div class="group-col" style="border-color: #56d364;">
            <div class="group-title" style="color: #56d364;">GRUPO 3</div>
            <div id="g3-list"></div>
        </div>
    </div>
</div>

<script>
const GROUPS = {
    "Fatima zahra": 1, "Hamza": 1, "Othmane": 1, "Omar": 1,
    "Souhail": 2, "Zakariya": 2, "Marwa": 2, "Malak": 2,
    "Hiba": 3, "Aya G.": 3, "Aya B.": 3, "Aya Z.": 3
};

let studentsData = [];
let currentSpeaker = null;
let lastGroupPlayed = null;
let playedStudents = [];

async function init() {
    // ÿ¨ŸÑÿ® ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿ£ŸàŸÑŸäÿ©
    const res = await databases.listDocuments(CLIENT_CONFIG.databaseId, CLIENT_CONFIG.collectionId);
    studentsData = res.documents;
    
    renderAllViews();
    updateHistoryUI(); // ÿ™ÿπÿ®ÿ¶ÿ© ÿßŸÑÿ≥ÿ¨ŸÑ ŸÅŸàÿ±ÿßŸã

    // ÿßŸÑÿßÿ≥ÿ™ŸÖÿßÿπ ŸÑŸÑÿ™ÿ∫ŸäŸäÿ±ÿßÿ™
    client.subscribe(`databases.${CLIENT_CONFIG.databaseId}.collections.${CLIENT_CONFIG.collectionId}.documents`, response => {
        const doc = response.payload;
        const idx = studentsData.findIndex(s => s.$id === doc.$id);
        if (idx !== -1) studentsData[idx] = doc;
        
        renderAllViews();

        // ŸÖŸÜÿ∑ŸÇ ŸàÿµŸàŸÑ ÿßŸÑÿ¨Ÿàÿßÿ®
        if (currentSpeaker && currentSpeaker.$id === doc.$id && doc.transcript) {
            // ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑŸàÿßÿ¨Ÿáÿ©
            const loadingEl = document.getElementById('loading-response');
            if(loadingEl) loadingEl.classList.add('hidden');

            const textBox = document.getElementById('speaker-text-current');
            textBox.innerText = `"${doc.transcript}"`;

            // ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿ≥ÿ¨ŸÑ
            updateHistoryUI();
        }
    });
}
init();

// ÿØÿßŸÑÿ© Ÿàÿ≠ÿØÿ© ŸÉÿ™ÿ≠ÿØÿ´ ŸÉŸÑÿ¥Ÿä (Monitor + Groups)
function renderAllViews() {
    renderMonitor();
    renderGroupsGrid();
}

function renderMonitor() {
    const container = document.getElementById('monitor-view');
    container.innerHTML = '';
    studentsData.forEach(s => {
        if (s.status !== 'online') return;
        const card = document.createElement('div');
        card.className = `card ${s.is_turn ? 'speaking' : ''}`;
        card.innerHTML = `<h3>${s.name}</h3><p>CONECTADO</p>`;
        container.appendChild(card);
    });
}

function renderGroupsGrid() {
    // ÿ™ŸÅÿ±Ÿäÿ∫ ÿßŸÑŸÇŸàÿßÿ¶ŸÖ
    document.getElementById('g1-list').innerHTML = '';
    document.getElementById('g2-list').innerHTML = '';
    document.getElementById('g3-list').innerHTML = '';

    studentsData.forEach(s => {
        const gID = GROUPS[s.name] || 1;
        const div = document.createElement('div');
        div.className = 'student-item';
        // ÿßŸÑŸÜŸÇÿ∑ÿ© ÿßŸÑÿÆÿ∂ÿ±ÿßÿ° ŸÑŸÑÿ≠ÿßŸÑÿ©
        const dotClass = s.status === 'online' ? 'online-dot' : 'offline-dot';
        div.innerHTML = `<span>${s.name}</span> <span class="${dotClass}"></span>`;
        // ÿ™ŸÑŸàŸäŸÜ ÿßŸÑÿßÿ≥ŸÖ ÿ•ÿ∞ÿß ŸÉÿßŸÜ Ÿäÿ™ÿ≠ÿØÿ´
        if (s.is_turn) div.style.border = "1px solid #e3b341";
        
        document.getElementById(`g${gID}-list`).appendChild(div);
    });
}

// ------ ŸÖŸÜÿ∑ŸÇ ÿßŸÑÿπÿ¨ŸÑÿ© (Roulette Logic) ------

function startRoulette() {
    if (currentSpeaker) {
        // ÿ•ÿ∑ŸÅÿßÿ° ÿßŸÑÿ™ŸÑŸÖŸäÿ∞ ÿßŸÑÿ≥ÿßÿ®ŸÇ
        databases.updateDocument(CLIENT_CONFIG.databaseId, CLIENT_CONFIG.collectionId, currentSpeaker.$id, { is_turn: false });
    }
    
    // UI Reset
    document.getElementById('active-turn-card').classList.remove('hidden');
    document.getElementById('loading-response').classList.add('hidden');
    document.getElementById('speaker-text-current').innerText = "";
    document.getElementById('next-btn').disabled = true;

    // 1. ÿ™ÿµŸÅŸäÿ© (Cycle Logic)
    let eligible = studentsData.filter(s => s.status === 'online');
    let pool = eligible.filter(s => !playedStudents.includes(s.$id));
    
    if (pool.length === 0) {
        playedStudents = []; // Reset cycle
        pool = eligible;
    }

    if (pool.length === 0) { alert("¬°Nadie conectado!"); document.getElementById('next-btn').disabled = false; return; }

    // 2. ÿ™ÿµŸÅŸäÿ© ÿßŸÑŸÖÿ¨ŸÖŸàÿπÿ© (Group Logic)
    let candidates = pool.filter(s => GROUPS[s.name] !== lastGroupPlayed);
    if (candidates.length === 0) candidates = pool;

    const winner = candidates[Math.floor(Math.random() * candidates.length)];

    // Animation
    const nameBox = document.getElementById('speaker-name');
    let counter = 0;
    const interval = setInterval(() => {
        nameBox.innerText = eligible[Math.floor(Math.random() * eligible.length)].name;
        counter++;
        if (counter >= 15) {
            clearInterval(interval);
            finalizeTurn(winner);
        }
    }, 80);
}

async function finalizeTurn(student) {
    document.getElementById('speaker-name').innerText = student.name;
    document.getElementById('next-btn').disabled = false;
    document.getElementById('loading-response').classList.remove('hidden');
    
    currentSpeaker = student;
    lastGroupPlayed = GROUPS[student.name];
    playedStudents.push(student.$id);

    // ‚úÖ‚úÖ ŸáŸÜÿß ÿßŸÑŸÉŸàÿØ ÿßŸÑŸÑŸä ŸÉÿßŸÜ ŸÜÿßŸÇÿµ ÿ®ÿßÿ¥ Ÿäÿ∑ŸÑÿπ ÿßŸÑÿ≤ÿ± ÿπŸÜÿØ ÿßŸÑÿ™ŸÑŸÖŸäÿ∞ ‚úÖ‚úÖ
    await databases.updateDocument(CLIENT_CONFIG.databaseId, CLIENT_CONFIG.collectionId, student.$id, { 
        is_turn: true, 
        transcript: "" 
    });
}

// ------ ÿßŸÑÿ≥ÿ¨ŸÑ (History) ------
function toggleHistory() {
    const modal = document.getElementById('history-modal');
    modal.style.display = modal.style.display === 'block' ? 'none' : 'block';
}

function updateHistoryUI() {
    const container = document.getElementById('history-content');
    // ÿ¨ŸÑÿ® ŸÉŸÑ ŸÖŸÜ ŸÑÿØŸäŸá transcript
    const historyData = studentsData.filter(s => s.transcript && s.transcript.length > 0); // ÿ™ÿ±ÿ™Ÿäÿ® ÿ®ÿ≥Ÿäÿ∑
    
    if (historyData.length === 0) {
        container.innerHTML = '<p style="text-align: center; color: gray;">No hay respuestas todav√≠a.</p>';
        return;
    }

    container.innerHTML = '';
    // ŸÜÿ∏Ÿáÿ±ŸàŸáŸÖ (ÿßŸÑÿ£ÿ≠ÿØÿ´ ŸÅÿßŸÑÿ£ÿ≠ÿØÿ´ ÿ•ŸÑÿß ÿ®ÿ∫Ÿäÿ™Ÿä ŸÖŸÖŸÉŸÜ ŸÜÿπŸÉÿ≥ŸàŸáŸÖ)
    historyData.forEach(s => {
        const row = document.createElement('div');
        row.className = 'history-row';
        row.innerHTML = `
            <span class="history-name">${s.name}</span>
            <span class="history-text">"${s.transcript}"</span>
        `;
        container.appendChild(row);
    });
}

function switchMode(mode) {
    document.getElementById('monitor-view').classList.add('hidden');
    document.getElementById('turn-view').classList.add('hidden');
    document.getElementById('group-view').classList.add('hidden');
    
    if (mode === 'monitor') {
        document.getElementById('monitor-view').classList.remove('hidden');
        document.getElementById('mode-title').innerText = "MODO: MONITOR";
    } else if (mode === 'turn') {
        document.getElementById('turn-view').classList.remove('hidden');
        document.getElementById('mode-title').innerText = "MODO: TURNOS";
    } else if (mode === 'group') {
        document.getElementById('group-view').classList.remove('hidden');
        document.getElementById('mode-title').innerText = "MODO: GRUPOS UI";
    }
}

async function resetAll() {
    if(confirm("¬øReiniciar todo?")) {
        studentsData.forEach(s => {
            databases.updateDocument(CLIENT_CONFIG.databaseId, CLIENT_CONFIG.collectionId, s.$id, { 
                status: 'offline', is_turn: false, transcript: "" 
            });
        });
        location.reload();
    }
}
</script>
</body>
</html>