<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Teacher Dashboard </title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/appwrite@13.0.0"></script>
    <script src="config.js"></script>
</head>
<body>

    <div style="background: #161b22; padding: 15px; border-bottom: 2px solid #30363d; display: flex; justify-content: space-between; align-items: center;">
        <div id="mode-title" style="color: #58a6ff; font-weight: bold; font-size: 24px;">panel</div>
        <div>
            <button class="btn btn-action" onclick="switchMode('monitor')">ğŸ“Š Monitor</button>
            <button class="btn btn-action" onclick="switchMode('turn')">ğŸ¤ Turnos </button>
            <button class="btn btn-action" onclick="switchMode('group')">ğŸ§© Grupos  </button>
            <button class="btn btn-danger" onclick="resetAll()">ğŸ”„ RESET</button>
        </div>
    </div>

    <div id="monitor-view" class="dashboard-grid" style="padding: 20px;"></div>

    <div id="turn-view" class="hidden">
        <div style="text-align: center; margin-top: 50px;">
            <button id="next-turn-btn" class="btn" onclick="spinTheWheel()" style="width: 300px; font-size: 22px; background: #1f6feb; box-shadow: 0 0 15px #1f6feb;">
                ğŸ² GIRAR RULETA 
            </button>
            
            <div id="active-turn-card" class="turn-display">
                <p style="color: gray; letter-spacing: 2px; text-transform: uppercase;">Hablando ahora:</p>
                <h1 id="speaker-name" class="active-speaker">...</h1>
                
                <div id="transcript-area" class="hidden">
                    <button class="btn btn-reveal" style="background: #e3b341; color: black;" onclick="revealText()">ğŸ‘ï¸</button>
                    <div id="speaker-text" style="display: none;" class="transcript-revealed"></div>
                </div>
            </div>
        </div>
    </div>

    <div id="group-view" class="hidden">
        <div style="text-align: center; padding: 10px; background: #0d1117;">
            <button class="btn btn-action" onclick="prepareGrouping()">1. PREPARAR NOMBRES</button>
            <button class="btn btn-action" onclick="executeDistribution()">2. DISTRIBUIR (GO!)</button>
        </div>
        
        <div id="grouping-canvas">
            <div class="groups-container">
                <div class="group-box group-1" id="box-1">
                    <div class="group-header">GRUPO 1</div>
                    <div class="group-content" id="content-1"></div>
                </div>
                <div class="group-box group-2" id="box-2">
                    <div class="group-header">GRUPO 2</div>
                    <div class="group-content" id="content-2"></div>
                </div>
                <div class="group-box group-3" id="box-3">
                    <div class="group-header">GRUPO 3</div>
                    <div class="group-content" id="content-3"></div>
                </div>
            </div>

            <div class="staging-area" id="staging-area">
                <p style="width: 100%; color: gray;">Los nombres apareceÃ¡n aquÃ­ ...</p>
            </div>
        </div>
    </div>

    <script>
        // --- ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ---
        // ØªØ¹Ø±ÙŠÙ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª (ÙŠÙ…ÙƒÙ†Ùƒ ØªØºÙŠÙŠØ±Ù‡Ø§)
        const GROUPS = {
            "Aya Z.": 1, "Hamza": 1, "Malak": 1, "Omar": 1,
            "Aya G.": 2, "Zakariya": 2, "Fatima zahra": 2, "Hiba": 2,
            "Othmane": 3, "Aya B.": 3, "Marwa": 3, "Souhail": 3
        };

        let studentsData = [];
        let currentSpeakerId = null;
        let isSpinning = false;

        async function init() {
            // Ø¬Ù„Ø¨ Ø§Ù„Ø¯Ø§ØªØ§ Ø§Ù„Ø£ÙˆÙ„ÙŠØ©
            const res = await databases.listDocuments(CLIENT_CONFIG.databaseId, CLIENT_CONFIG.collectionId);
            studentsData = res.documents;
            renderMonitor();

            // Realtime Update
            client.subscribe(`databases.${CLIENT_CONFIG.databaseId}.collections.${CLIENT_CONFIG.collectionId}.documents`, response => {
                const doc = response.payload;
                const idx = studentsData.findIndex(s => s.$id === doc.$id);
                if (idx !== -1) studentsData[idx] = doc;
                else studentsData.push(doc);
                
                renderMonitor();
                
                // Ø¥Ø°Ø§ ÙˆØµÙ„ Ø§Ù„Ù†Øµ (transcript) ÙˆØ§Ù„Ø³Ø¨ÙŠÙ†Ø± Ø³Ø§Ù„Ø§ØŒ Ø¨ÙŠÙ† Ø§Ù„Ø²Ø±
                if (currentSpeakerId === doc.$id && doc.transcript && doc.transcript.length > 0) {
                   // Ø§Ù„ØªÙ„Ù…ÙŠØ° Ù‡Ø¯Ø±ØŒ ÙˆØ§Ø´ Ù†Ø¨ÙŠÙ†Ùˆ Ø¯Ø§Ø¨Ø§ØŸ Ù„Ø§ØŒ Ø­ØªÙ‰ ÙŠØ·Ù„Ø¨ Ø§Ù„Ø£Ø³ØªØ§Ø° Reveal
                   // Ù‡Ù†Ø§ Ù…Ù…ÙƒÙ† Ù†Ø¯ÙŠØ±Ùˆ Ø´ÙŠ Ø¥Ø´Ø§Ø±Ø© Ø£Ù† Ø§Ù„Ù†Øµ ÙˆØµÙ„
                }
            });
        }
        init();

        // --- 1. Monitor Logic ---
        function renderMonitor() {
            const container = document.getElementById('monitor-view');
            container.innerHTML = '';
            studentsData.forEach(s => {
                // Ø¨ÙŠÙ† ÙƒÙ„Ø´ÙŠ Ø¨Ø§Ø´ ØªØ¹Ø±Ù Ø´ÙƒÙˆÙ† Ø­Ø§Ø¶Ø±
                const isOnline = s.status === 'online';
                const isCheated = s.cheated;
                
                const card = document.createElement('div');
                card.className = `card ${isCheated ? 'cheated' : ''} ${s.is_turn ? 'speaking' : ''}`;
                card.style.opacity = isOnline || isCheated ? '1' : '0.5';
                
                let statusIcon = isOnline ? 'ğŸŸ¢' : 'âš«';
                if(isCheated) statusIcon = 'ğŸ˜¡';

                card.innerHTML = `
                    <h3>${s.name}</h3>
                    <p>${statusIcon} ${isCheated ? 'Busted!' : (isOnline ? 'Online' : 'Offline')}</p>
                `;
                container.appendChild(card);
            });
        }

        // --- 2. Casino Turn Logic (Ø¹Ø¬Ù„Ø© Ø§Ù„Ø­Ø¸) ---
        async function spinTheWheel() {
            if(isSpinning) return; // Ù…Ù†Ø¹ Ø§Ù„Ø¶ØºØ· Ø§Ù„Ù…ØªÙƒØ±Ø±
            
            // 1. Reset Ø§Ù„Ø³Ø§Ø¨Ù‚
            if (currentSpeakerId) {
                await databases.updateDocument(CLIENT_CONFIG.databaseId, CLIENT_CONFIG.collectionId, currentSpeakerId, { is_turn: false });
                document.getElementById('transcript-area').classList.add('hidden');
                document.getElementById('speaker-text').style.display = 'none';
                document.getElementById('speaker-text').innerText = '';
            }

            // 2. ØªØµÙÙŠØ© Ø§Ù„Ù…Ø±Ø´Ø­ÙŠÙ† (ÙÙ‚Ø· Ø§Ù„Ù„ÙŠ Ø£ÙˆÙ†Ù„Ø§ÙŠÙ† ÙˆÙ…Ø§Ø´ÙŠ ØºØ´Ø§Ø´ÙŠÙ†)
            const eligible = studentsData.filter(s => s.status === 'online' && !s.cheated);
            if (eligible.length === 0) { alert("Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØªÙ„Ø§Ù…ÙŠØ° Ù…ØªØ§Ø­ÙŠÙ† (No active students)"); return; }

            // 3. Ø¨Ø¯Ø¡ ØªØ£Ø«ÙŠØ± Ø§Ù„ÙƒØ§Ø²ÙŠÙ†Ùˆ
            isSpinning = true;
            document.getElementById('next-turn-btn').disabled = true;
            const nameDisplay = document.getElementById('speaker-name');
            nameDisplay.style.color = "white";
            
            let counter = 0;
            const maxSpins = 30; // Ø´Ø­Ø§Ù„ Ù…Ù† Ù…Ø±Ø© ÙŠØªØ¨Ø¯Ù„ Ø§Ù„Ø§Ø³Ù…
            const speed = 80; // Ø§Ù„Ø³Ø±Ø¹Ø© Ø¨Ø§Ù„Ù…ÙŠÙ„ÙŠ Ø«Ø§Ù†ÙŠØ©

            const interval = setInterval(() => {
                // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ø³Ù… Ø¹Ø´ÙˆØ§Ø¦ÙŠ
                const randomName = eligible[Math.floor(Math.random() * eligible.length)].name;
                nameDisplay.innerText = randomName;
                counter++;

                if (counter >= maxSpins) {
                    clearInterval(interval);
                    finalizeTurn(eligible);
                }
            }, speed);
        }

        async function finalizeTurn(eligible) {
            // Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø±Ø§Ø¨Ø­ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ
            const winner = eligible[Math.floor(Math.random() * eligible.length)];
            const nameDisplay = document.getElementById('speaker-name');
            
            // ØªØ£Ø«ÙŠØ± Ø§Ù„ØªÙˆÙ‚Ù
            nameDisplay.innerText = winner.name;
            nameDisplay.style.color = "#58a6ff";
            nameDisplay.style.transform = "scale(1.5)";
            setTimeout(() => nameDisplay.style.transform = "scale(1)", 300);

            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¯Ø§ØªØ§Ø¨ÙŠØ²
            currentSpeakerId = winner.$id;
            await databases.updateDocument(CLIENT_CONFIG.databaseId, CLIENT_CONFIG.collectionId, winner.$id, { 
                is_turn: true,
                transcript: "" // Ù…Ø³Ø­ Ø§Ù„Ù†Øµ Ø§Ù„Ù‚Ø¯ÙŠÙ…
            });

            isSpinning = false;
            document.getElementById('next-turn-btn').disabled = false;
            
            // Ø¥Ø¸Ù‡Ø§Ø± Ø²Ø± Ø§Ù„Ù€ Reveal (Ù†ØªØ³Ù†Ø§Ùˆ Ø´ÙˆÙŠØ© Ø¨Ø§Ø´ ÙŠØ¹ÙŠÙ‚ Ø¨Ù„ÙŠ Ø±Ø§Ù‡ Ø§Ø®ØªØ§Ø±ÙŠÙ†Ø§Ù‡)
            setTimeout(() => {
                document.getElementById('transcript-area').classList.remove('hidden');
            }, 1000);
        }

        async function revealText() {
            const textBox = document.getElementById('speaker-text');
            textBox.innerText = "â³ Cargando..."; // Loading message
            textBox.style.display = 'block';

            // 1. Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©
            let student = studentsData.find(s => s.$id === currentSpeakerId);

            // 2. Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù†Øµ ÙØ§Ø±ØºØ§Ù‹ØŒ Ù†Ø¬Ø¨Ø± Ø§Ù„Ù†Ø¸Ø§Ù… ÙŠØ¬ÙŠØ¨Ùˆ Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ± (Force Fetch)
            if (!student || !student.transcript) {
                try {
                    console.log("Fetching fresh data from server...");
                    student = await databases.getDocument(CLIENT_CONFIG.databaseId, CLIENT_CONFIG.collectionId, currentSpeakerId);
                    
                    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ© Ø¨Ø§Ø´ Ø§Ù„Ù…Ø±Ø© Ø§Ù„Ø¬Ø§ÙŠØ© ØªÙƒÙˆÙ† ÙˆØ§Ø¬Ø¯Ø©
                    const idx = studentsData.findIndex(s => s.$id === currentSpeakerId);
                    if(idx !== -1) studentsData[idx] = student;
                } catch(e) { 
                    console.error("Error fetching data:", e);
                }
            }

            // 3. Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©
            if (student && student.transcript) {
                textBox.innerText = `"${student.transcript}"`;
                textBox.className = "transcript-revealed";
            } else {
                textBox.innerText = "âš ï¸ No hay respuesta ";
            }
        }

        // --- 3. Groups Logic (ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª) ---
        
        function prepareGrouping() {
            // 1. ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø³Ø§Ø­Ø©
            document.getElementById('content-1').innerHTML = '';
            document.getElementById('content-2').innerHTML = '';
            document.getElementById('content-3').innerHTML = '';
            const staging = document.getElementById('staging-area');
            staging.innerHTML = '';

            // 2. ÙˆØ¶Ø¹ ÙƒÙ„ Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ (Ø§Ù„Ø£ÙˆÙ†Ù„Ø§ÙŠÙ† + Ø§Ù„ØºØ´Ø§Ø´ÙŠÙ†) ÙÙŠ Ø§Ù„Ø£Ø³ÙÙ„
            const activeStudents = studentsData.filter(s => s.status === 'online' || s.cheated);
            
            activeStudents.forEach(s => {
                const badge = document.createElement('div');
                badge.className = 'student-tag';
                badge.style.background = '#30363d'; // Ù„ÙˆÙ† Ø±Ù…Ø§Ø¯ÙŠ Ù…Ø¤Ù‚Øª
                badge.innerText = s.name;
                badge.dataset.id = s.$id;
                badge.dataset.name = s.name;
                staging.appendChild(badge);
            });
        }

        function executeDistribution() {
            const stagingTags = Array.from(document.querySelectorAll('#staging-area .student-tag'));
            if(stagingTags.length === 0) return;

            // Ù†ÙˆØ²Ø¹ÙˆÙ‡Ù… ÙˆØ§Ø­Ø¯ Ø¨ÙˆØ§Ø­Ø¯ Ø¨ÙØ§ØµÙ„ Ø²Ù…Ù†ÙŠ
            stagingTags.forEach((tag, index) => {
                setTimeout(() => {
                    animateTagToGroup(tag);
                }, index * 800); // ÙƒÙ„ 0.8 Ø«Ø§Ù†ÙŠØ© ÙŠÙ…Ø´ÙŠ ÙˆØ§Ø­Ø¯
            });
        }

        function animateTagToGroup(originalTag) {
            const name = originalTag.dataset.name;
            const groupNum = GROUPS[name] || 2; // Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ Ù…Ø¬Ù…ÙˆØ¹Ø© 2
            const targetBox = document.getElementById(`box-${groupNum}`);
            const targetContent = document.getElementById(`content-${groupNum}`);

            // 1. Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª Ù„Ù„Ø§Ù†Ø·Ù„Ø§Ù‚ ÙˆØ§Ù„Ù‡Ø¨ÙˆØ·
            const rectStart = originalTag.getBoundingClientRect();
            // Ù†Ø­Ø³Ø¨Ùˆ ÙÙŠÙ† ØºØ§Ø¯ÙŠ ÙŠØ¬ÙŠ ÙØ§Ù„Ù„Ø®Ø± (ØªÙ‚Ø±ÙŠØ¨Ø§ ÙˆØ³Ø· Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚)
            const rectEnd = targetBox.getBoundingClientRect();

            // 2. Ø¥Ù†Ø´Ø§Ø¡ Ù†Ø³Ø®Ø© Ø·Ø§Ø¦Ø±Ø©
            const flyer = document.createElement('div');
            flyer.className = 'flying-name';
            flyer.innerText = name;
            flyer.style.left = rectStart.left + 'px';
            flyer.style.top = rectStart.top + 'px';
            flyer.style.width = rectStart.width + 'px';
            
            document.body.appendChild(flyer);
            
            // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø£ØµÙ„ÙŠ
            originalTag.style.opacity = 0;

            // 3. Ø§Ù„ØªØ­Ø±ÙŠÙƒ (Force Reflow)
            flyer.getBoundingClientRect(); 
            
            // Ø§Ù„Ù‡Ø¯Ù: ÙˆØ³Ø· Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚
            flyer.style.left = (rectEnd.left + rectEnd.width/2 - 50) + 'px';
            flyer.style.top = (rectEnd.top + rectEnd.height/2) + 'px';
            flyer.style.background = getGroupColor(groupNum); // ÙŠØªØ¨Ø¯Ù„ Ù„ÙˆÙ†Ùˆ Ø¨Ù„ÙˆÙ† Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© ÙØ§Ù„Ø·Ø±ÙŠÙ‚

            // 4. Ø¹Ù†Ø¯ Ø§Ù„ÙˆØµÙˆÙ„
            setTimeout(() => {
                flyer.remove();
                
                // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¹Ù†ØµØ± Ø§Ù„Ø¯Ø§Ø¦Ù… Ø¯Ø§Ø®Ù„ Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚
                const finalTag = document.createElement('div');
                finalTag.className = 'student-tag';
                finalTag.innerText = name;
                finalTag.style.background = getGroupColor(groupNum);
                targetContent.appendChild(finalTag); // Ù‡Ù†Ø§ Ø§Ù„Ù€ Flexbox ØºÙŠÙ‚Ø§Ø¯Ùˆ Ù…Ø²ÙŠØ§Ù†
                
                // ØµÙˆØª Ø¨Ø³ÙŠØ· (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
                // new Audio('pop.mp3').play().catch(()=>{}); 
            }, 1000); // Ù†ÙØ³ ÙˆÙ‚Øª Ø§Ù„Ù€ transition ÙÙ€ CSS
        }

        function getGroupColor(num) {
            if(num === 1) return '#d2a8ff';
            if(num === 2) return '#79c0ff';
            return '#56d364';
        }

        // --- Navigation ---
        function switchMode(mode) {
            ['monitor-view', 'turn-view', 'group-view'].forEach(id => document.getElementById(id).classList.add('hidden'));
            
            if (mode === 'monitor') {
                document.getElementById('monitor-view').classList.remove('hidden');
                document.getElementById('mode-title').innerText = "MONITOR";
            } else if (mode === 'turn') {
                document.getElementById('turn-view').classList.remove('hidden');
                document.getElementById('mode-title').innerText = "CASINO TURN";
            } else if (mode === 'group') {
                document.getElementById('group-view').classList.remove('hidden');
                document.getElementById('mode-title').innerText = "GROUP SORT";
            }
        }

        async function resetAll() {
            if(confirm("Reset complete system?")) {
                studentsData.forEach(s => {
                    databases.updateDocument(CLIENT_CONFIG.databaseId, CLIENT_CONFIG.collectionId, s.$id, { 
                        status: 'offline', cheated: false, is_turn: false, transcript: ""
                    });
                });
                setTimeout(() => location.reload(), 1000);
            }
        }
    </script>
</body>
</html>