<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Panel de Profesor</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/appwrite@13.0.0"></script>
    <script src="config.js"></script>
    <style>
        /* ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ø®Ø§ØµØ© Ø¯Ø§Ø®Ù„ Ø§Ù„ØµÙØ­Ø© Ù„Ø¶Ù…Ø§Ù† Ø¹Ø¯Ù… ØªØ¹Ø§Ø±Ø¶Ù‡Ø§ */
        .control-bar { display: flex; gap: 10px; background: #161b22; padding: 15px; border-bottom: 2px solid #30363d; flex-wrap: wrap; }
        .mode-title { color: #58a6ff; font-weight: bold; font-size: 24px; text-transform: uppercase; margin-right: auto; align-self: center; }
        
        .current-turn-box {
            text-align: center; margin: 20px auto; padding: 40px;
            border: 4px solid #58a6ff; border-radius: 20px;
            background: #0d1117; width: 70%; box-shadow: 0 0 30px rgba(88, 166, 255, 0.15);
            min-height: 300px; display: flex; flex-direction: column; justify-content: center; align-items: center;
        }
        
        .active-speaker { font-size: 4em; color: #58a6ff; margin: 20px 0; font-weight: bold; text-shadow: 0 0 10px rgba(88, 166, 255, 0.5); }
        
        .history-table { width: 80%; margin: 20px auto; border-collapse: collapse; color: #c9d1d9; background: #161b22; }
        .history-table th, .history-table td { border: 1px solid #30363d; padding: 15px; text-align: left; }
        .history-table th { background: #21262d; color: #58a6ff; }
        
        /* ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯ */
        #grouping-canvas { position: relative; height: 75vh; width: 100%; margin-top: 10px; }
        .group-box {
            position: absolute; width: 30%; height: 50%; border: 3px solid;
            border-radius: 15px; padding: 10px; background: rgba(22, 27, 34, 0.9);
            overflow-y: auto; top: 10px; display: flex; flex-direction: column; gap: 5px;
        }
        .group-1 { left: 2%; border-color: #d2a8ff; }
        .group-2 { left: 35%; border-color: #79c0ff; }
        .group-3 { right: 2%; border-color: #56d364; }
        
        .pool-area {
            position: absolute; bottom: 0; left: 0; width: 100%; height: 30%;
            border-top: 2px dashed #30363d; display: flex; flex-wrap: wrap; 
            justify-content: center; align-items: center; gap: 10px; padding: 20px;
        }

        .name-tag {
            background: #238636; color: white; padding: 8px 15px; border-radius: 20px;
            font-weight: bold; font-size: 16px; white-space: nowrap; z-index: 100;
            transition: all 1s cubic-bezier(0.25, 1, 0.5, 1); position: absolute;
        }
    </style>
</head>
<body>

<div class="control-bar">
    <div class="mode-title" id="mode-title">MODO: MONITOR</div>
    <button class="btn btn-action" onclick="switchMode('monitor')">ğŸ“Š MONITOR</button>
    <button class="btn btn-action" onclick="switchMode('turn')">ğŸ¤ TURNOS</button>
    <button class="btn btn-action" onclick="switchMode('group')">ğŸ§© GRUPOS</button>
    <button class="btn btn-action" onclick="switchMode('history')" style="background: #e3b341; color: black;">ğŸ“œ HISTORIAL</button>
    <button class="btn btn-danger" onclick="resetAll()" style="width: auto;">ğŸ”„ REINICIAR</button>
</div>

<div id="monitor-view" class="dashboard-grid grid" style="padding: 20px;"></div>

<div id="turn-view" class="hidden">
    <div style="text-align: center; margin-top: 20px;">
        <button id="next-btn" class="btn" onclick="nextTurn()" style="width: 300px; font-size: 24px; background: #1f6feb;">â¡ï¸ SIGUIENTE TURNO</button>
    </div>

    <div id="active-turn-card" class="current-turn-box hidden">
        <p style="color: gray; text-transform: uppercase; letter-spacing: 2px;">JUGADOR ACTUAL</p>
        <div id="speaker-name" class="active-speaker">...</div>
        
        <div id="loading-transcript" class="hidden" style="margin-top:20px;">
            <span style="font-size:20px; color: #8b949e;">Esperando respuesta... â³</span>
        </div>

        <button id="reveal-btn-current" class="btn btn-reveal hidden" onclick="revealCurrent()" style="margin-top:20px;">ğŸ‘ï¸ MOSTRAR RESPUESTA</button>
        <div id="speaker-text-current" class="transcript-hidden" style="margin-top: 20px; font-size: 28px; color: #e3b341;"></div>
    </div>
</div>

<div id="group-view" class="hidden">
    <div style="text-align: center; padding: 10px;">
        <button class="btn btn-action" onclick="startGroupingAnimation()">â­ DISTRIBUIR GRUPOS</button>
    </div>
    <div id="grouping-canvas">
        <div class="group-box group-1" id="box-1"><h3 style="color: #d2a8ff; text-align: center; border-bottom:1px solid #30363d; padding-bottom:5px;">GRUPO 1</h3></div>
        <div class="group-box group-2" id="box-2"><h3 style="color: #79c0ff; text-align: center; border-bottom:1px solid #30363d; padding-bottom:5px;">GRUPO 2</h3></div>
        <div class="group-box group-3" id="box-3"><h3 style="color: #56d364; text-align: center; border-bottom:1px solid #30363d; padding-bottom:5px;">GRUPO 3</h3></div>
        <div class="pool-area" id="pool-area"></div>
    </div>
</div>

<div id="history-view" class="hidden">
    <h2 style="text-align: center; color: #58a6ff; margin-top: 20px;">HISTORIAL DE RESPUESTAS</h2>
    <table class="history-table">
        <thead>
            <tr>
                <th>Nombre</th>
                <th>Grupo</th>
                <th>Respuesta</th>
            </tr>
        </thead>
        <tbody id="history-body">
            </tbody>
    </table>
</div>

<script>
const GROUPS = {
    "Fatima zahra": 1, "Hamza": 1, "Othmane": 1, "Omar": 1,
    "Souhail": 2, "Zakariya": 2, "Marwa": 2, "Malak": 2,
    "Hiba": 3, "Aya G.": 3, "Aya B.": 3, "Aya Z.": 3
};

let studentsData = [];
let currentSpeaker = null;
let usedStudentIds = new Set(); // Ù„ØªØªØ¨Ø¹ Ù…Ù† Ø´Ø§Ø±Ùƒ
let lastGroup = null; // Ù„ØªØªØ¨Ø¹ Ø¢Ø®Ø± Ù…Ø¬Ù…ÙˆØ¹Ø© Ø´Ø§Ø±ÙƒØª

async function init() {
    const res = await databases.listDocuments(CLIENT_CONFIG.databaseId, CLIENT_CONFIG.collectionId);
    studentsData = res.documents;
    
    // Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© Ø¥Ø°Ø§ ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙØ­Ø©
    studentsData.forEach(s => {
        if(s.is_turn && s.transcript) {
            // Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ø³Ø¬Ù„ Ø¥Ø°Ø§ ÙƒØ§Ù† Ù„Ø¯ÙŠÙ‡ Ù†Øµ ÙˆÙ„Ù… ÙŠØ¹Ø¯ Ø¯ÙˆØ±Ù‡
             addToHistory(s.name, GROUPS[s.name] || '?', s.transcript);
             usedStudentIds.add(s.$id);
        }
    });

    renderMonitor();

    client.subscribe(`databases.${CLIENT_CONFIG.databaseId}.collections.${CLIENT_CONFIG.collectionId}.documents`, response => {
        const doc = response.payload;
        const idx = studentsData.findIndex(s => s.$id === doc.$id);
        if (idx !== -1) studentsData[idx] = doc;
        renderMonitor();

        // Ø¥Ø°Ø§ ÙˆØµÙ„ Ø§Ù„Ù†Øµ Ù„Ù„Ù…ØªØ­Ø¯Ø« Ø§Ù„Ø­Ø§Ù„ÙŠ
        if (currentSpeaker && currentSpeaker.$id === doc.$id && doc.transcript) {
            currentSpeaker.transcript = doc.transcript;
            document.getElementById('loading-transcript').classList.add('hidden');
            document.getElementById('reveal-btn-current').classList.remove('hidden');
            document.getElementById('speaker-text-current').dataset.text = doc.transcript;
            document.getElementById('next-btn').disabled = false; // Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„Ù…Ø±ÙˆØ± Ù„Ù„ØªØ§Ù„ÙŠ
            
            // ØªØ³Ø¬ÙŠÙ„ ÙÙŠ Ø§Ù„Ù‡ÙŠØ³ØªÙˆØ±ÙŠ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ (Ù…Ø®ÙÙŠ)
            addToHistory(doc.name, GROUPS[doc.name] || '?', doc.transcript);
        }
    });
}
init();

function renderMonitor() {
    const container = document.getElementById('monitor-view');
    container.innerHTML = '';
    studentsData.forEach(s => {
        const card = document.createElement('div');
        card.className = `card ${s.is_turn ? 'speaking' : ''}`;
        card.style.opacity = s.status === 'online' ? '1' : '0.5';
        card.innerHTML = `
            <h3>${s.name}</h3>
            <p>${s.status === 'online' ? 'ğŸŸ¢ ONLINE' : 'âš« OFFLINE'}</p>
        `;
        container.appendChild(card);
    });
}

// --- LOGIC: SELECCIÃ“N DE TURNOS (ROULETTE & RULES) ---

async function nextTurn() {
    const eligible = studentsData.filter(s => s.status === 'online' && !usedStudentIds.has(s.$id));

    if (eligible.length === 0) {
        alert("Â¡Todos los estudiantes han participado o no hay nadie conectado!");
        return;
    }

    // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ù‚Ø¯ÙŠÙ…
    if (currentSpeaker) {
        databases.updateDocument(CLIENT_CONFIG.databaseId, CLIENT_CONFIG.collectionId, currentSpeaker.$id, { is_turn: false });
    }

    // ØªØ­Ø¶ÙŠØ± Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
    document.getElementById('active-turn-card').classList.remove('hidden');
    document.getElementById('reveal-btn-current').classList.add('hidden');
    document.getElementById('speaker-text-current').innerText = "";
    document.getElementById('speaker-text-current').className = "transcript-hidden";
    document.getElementById('loading-transcript').classList.remove('hidden'); // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±
    document.getElementById('next-btn').disabled = true; // Ù…Ù†Ø¹ Ø§Ù„Ø¶ØºØ· Ù…Ø±ØªÙŠÙ†

    // Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ÙØ§Ø¦Ø² (ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø´Ø±ÙˆØ·)
    let candidates = eligible;
    
    // Ø´Ø±Ø·: Ø¹Ø¯Ù… ØªÙƒØ±Ø§Ø± Ù†ÙØ³ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© Ø¥Ø°Ø§ Ø£Ù…ÙƒÙ†
    if (lastGroup !== null) {
        const differentGroupCandidates = eligible.filter(s => GROUPS[s.name] !== lastGroup);
        if (differentGroupCandidates.length > 0) {
            candidates = differentGroupCandidates;
        }
    }

    const winner = candidates[Math.floor(Math.random() * candidates.length)];
    
    // ØªØ´ØºÙŠÙ„ Ø§Ù„Ø±ÙˆÙ„ÙŠØª (Animation)
    await spinRoulette(eligible, winner);

    // Ø¨Ø¹Ø¯ Ø§Ù„ØªÙˆÙ‚Ù
    currentSpeaker = winner;
    lastGroup = GROUPS[winner.name];
    usedStudentIds.add(winner.$id);
    
    // ØªÙØ¹ÙŠÙ„ Ø§Ù„ØªÙ„Ù…ÙŠØ° ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    await databases.updateDocument(CLIENT_CONFIG.databaseId, CLIENT_CONFIG.collectionId, winner.$id, { is_turn: true, transcript: "" });
}

function spinRoulette(pool, winner) {
    return new Promise(resolve => {
        const nameDisplay = document.getElementById('speaker-name');
        let counter = 0;
        const totalSpins = 20; // Ø¹Ø¯Ø¯ Ù…Ø±Ø§Øª Ø§Ù„ØªØºÙŠÙŠØ± Ù‚Ø¨Ù„ Ø§Ù„ØªÙˆÙ‚Ù
        
        const interval = setInterval(() => {
            const randomName = pool[Math.floor(Math.random() * pool.length)].name;
            nameDisplay.innerText = randomName;
            nameDisplay.style.color = "#8b949e"; // Ù„ÙˆÙ† Ø±Ù…Ø§Ø¯ÙŠ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¯ÙˆØ±Ø§Ù†
            counter++;

            if (counter >= totalSpins) {
                clearInterval(interval);
                nameDisplay.innerText = winner.name;
                nameDisplay.style.color = "#58a6ff"; // Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø£Ø²Ø±Ù‚ Ù„Ù„ÙØ§Ø¦Ø²
                resolve();
            }
        }, 100); // Ø³Ø±Ø¹Ø© Ø§Ù„Ø¯ÙˆØ±Ø§Ù† (ms)
    });
}

function revealCurrent() {
    const textBox = document.getElementById('speaker-text-current');
    const text = textBox.dataset.text || "";
    textBox.innerText = `"${text}"`;
    textBox.className = "transcript-revealed";
}

function addToHistory(name, group, text) {
    const tbody = document.getElementById('history-body');
    const row = document.createElement('tr');
    row.innerHTML = `
        <td style="font-weight:bold;">${name}</td>
        <td>Grupo ${group}</td>
        <td>"${text}"</td>
    `;
    // Ø¥Ø¶Ø§ÙØ© ÙÙŠ Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©
    tbody.insertBefore(row, tbody.firstChild);
}

// --- LOGIC: GROUPS UX ---

function startGroupingAnimation() {
    const pool = document.getElementById('pool-area');
    const onlineStudents = studentsData.filter(s => s.status === 'online');
    
    // 1. ØªÙ†Ø¸ÙŠÙ
    pool.innerHTML = '';
    [1, 2, 3].forEach(i => {
        const box = document.getElementById(`box-${i}`);
        // Ù…Ø³Ø­ Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ ÙÙ‚Ø· ÙˆØªØ±Ùƒ Ø§Ù„Ø¹Ù†ÙˆØ§Ù†
        Array.from(box.children).forEach(c => { if(c.tagName !== 'H3') c.remove(); });
    });

    // 2. ÙˆØ¶Ø¹ Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ ÙÙŠ Ø§Ù„Ø£Ø³ÙÙ„ (Pool)
    onlineStudents.forEach(s => {
        const tag = document.createElement('div');
        tag.className = 'name-tag';
        tag.innerText = s.name;
        tag.id = `tag-${s.$id}`;
        pool.appendChild(tag);
    });

    // 3. Ø§Ù„ØªØ­Ø±ÙŠÙƒ Ø¨Ø¹Ø¯ Ù…Ù‡Ù„Ø© Ù‚ØµÙŠØ±Ø©
    setTimeout(() => {
        onlineStudents.forEach(s => {
            const tag = document.getElementById(`tag-${s.$id}`);
            const groupNum = GROUPS[s.name] || 2; // Default group 2
            const targetBox = document.getElementById(`box-${groupNum}`);
            
            // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª Ù„Ù„Ø§Ù†ØªÙ‚Ø§Ù„
            const startRect = tag.getBoundingClientRect();
            const targetRect = targetBox.getBoundingClientRect();
            
            // Ù†Ù‚Ù„ Ø§Ù„Ø¹Ù†ØµØ± Ù„ÙŠÙƒÙˆÙ† absolute Ø¨Ø§Ù„Ù†Ø³Ø¨Ø© Ù„Ù„Ø´Ø§Ø´Ø© Ù„Ù„Ø­Ø±ÙƒØ©
            tag.style.position = 'fixed';
            tag.style.left = startRect.left + 'px';
            tag.style.top = startRect.top + 'px';
            tag.style.margin = 0;

            // Ø§Ù„ØªØ­Ø±Ùƒ Ù†Ø­Ùˆ Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚
            // Ø­Ø³Ø§Ø¨ Ù…ÙˆÙ‚Ø¹ Ø¹Ø´ÙˆØ§Ø¦ÙŠ Ù‚Ù„ÙŠÙ„Ø§Ù‹ Ø¯Ø§Ø®Ù„ Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚ Ù„Ø¹Ø¯Ù… Ø§Ù„ØªØ·Ø§Ø¨Ù‚ Ø§Ù„ØªØ§Ù…
            const offsetX = 20;
            const offsetY = 50 + (targetBox.children.length * 40); // ØªØ±ØªÙŠØ¨ Ø¹Ù…ÙˆØ¯ÙŠ

            setTimeout(() => {
                tag.style.left = (targetRect.left + offsetX) + 'px';
                tag.style.top = (targetRect.top + offsetY) + 'px';
                
                // Ø¨Ø¹Ø¯ Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ø­Ø±ÙƒØ©ØŒ Ù†Ù‚Ù„Ù‡ ÙØ¹Ù„ÙŠØ§Ù‹ Ø¯Ø§Ø®Ù„ Ø§Ù„Ù€ DOM Ø§Ù„Ø®Ø§Øµ Ø¨Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚
                setTimeout(() => {
                    tag.style.position = 'static';
                    tag.style.transform = 'none';
                    targetBox.appendChild(tag);
                }, 1000); // Ù†ÙØ³ Ù…Ø¯Ø© Ø§Ù„Ù€ transition ÙÙŠ CSS
            }, 100);
        });
    }, 500);
}

function switchMode(mode) {
    ['monitor', 'turn', 'group', 'history'].forEach(m => {
        document.getElementById(`${m}-view`).classList.add('hidden');
    });
    document.getElementById(`${mode}-view`).classList.remove('hidden');
    
    const titles = {
        'monitor': "MODO: MONITOR",
        'turn': "MODO: TURNOS",
        'group': "MODO: GRUPOS",
        'history': "HISTORIAL"
    };
    document.getElementById('mode-title').innerText = titles[mode];
}

async function resetAll() {
    if(confirm("Â¿Reiniciar todo el sistema?")) {
        // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† ÙƒÙ„ Ø´ÙŠØ¡
        studentsData.forEach(s => {
            databases.updateDocument(CLIENT_CONFIG.databaseId, CLIENT_CONFIG.collectionId, s.$id, { 
                status: 'offline', 
                is_turn: false, 
                transcript: "" 
            });
        });
        location.reload();
    }
}
</script>
</body>
</html>