<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Panel de Profesor</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/appwrite@13.0.0"></script>
    <script src="config.js"></script>
    <style>
        .control-bar { display: flex; justify-content: space-between; background: #161b22; padding: 15px; border-bottom: 2px solid #30363d; }
        .mode-title { color: #58a6ff; font-weight: bold; font-size: 24px; text-transform: uppercase; }
        
        /* ØªØµÙ…ÙŠÙ… Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø¯ÙˆØ± Ø§Ù„Ø­Ø§Ù„ÙŠ */
        .current-turn-box {
            text-align: center; margin: 20px auto; padding: 30px; 
            border: 3px solid #58a6ff; border-radius: 15px; 
            background: #0d1117; width: 60%; box-shadow: 0 0 20px rgba(88, 166, 255, 0.2);
        }
        .active-speaker { font-size: 3.5em; color: #58a6ff; margin: 10px 0; font-weight: bold; }
        
        /* Ø³Ø¬Ù„ Ø§Ù„Ù…ØªØ­Ø¯Ø«ÙŠÙ† Ø§Ù„Ø³Ø§Ø¨Ù‚ÙŠÙ† */
        .history-container {
            display: flex; flex-direction: column; align-items: center; margin-top: 30px; width: 100%;
        }
        .history-card {
            background: #161b22; border: 1px solid #30363d; border-radius: 8px;
            padding: 15px; margin: 10px; width: 50%; display: flex; justify-content: space-between; align-items: center;
            opacity: 0.8; transition: opacity 0.3s;
        }
        .history-card:hover { opacity: 1; }
        .history-name { font-size: 1.2em; font-weight: bold; color: #c9d1d9; }
        
        /* Ø§Ù„Ù†Ø¬ÙˆÙ… */
        .star-icon { font-size: 24px; color: gold; margin-right: 5px; animation: spin 2s infinite linear; display: inline-block;}
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div class="control-bar">
        <div class="mode-title" id="mode-title">MODO: MONITOR</div>
        <div>
            <button class="btn btn-action" onclick="switchMode('monitor')">ğŸ“Š MONITOR</button>
            <button class="btn btn-action" onclick="switchMode('turn')">ğŸ¤ TURNOS</button>
            <button class="btn btn-action" onclick="switchMode('group')">ğŸ§© GRUPOS</button>
            <button class="btn btn-danger" onclick="resetAll()" style="width: auto;">ğŸ”„ REINICIAR</button>
        </div>
    </div>

    <div id="monitor-view" class="dashboard-grid grid" style="padding: 20px;"></div>

    <div id="turn-view" class="hidden">
        <div style="text-align: center; margin-top: 30px;">
            <button class="btn" onclick="nextTurn()" style="width: 300px; font-size: 24px; background: #1f6feb;">â¡ï¸ SIGUIENTE</button>
        </div>

        <div id="active-turn-card" class="current-turn-box hidden">
            <p style="color: gray; text-transform: uppercase; letter-spacing: 2px;">Hablando ahora</p>
            <div id="speaker-name" class="active-speaker">...</div>
            
            <button id="reveal-btn-current" class="btn btn-reveal hidden" onclick="revealCurrent()">ğŸ‘ï¸ MOSTRAR RESPUESTA</button>
            <div id="speaker-text-current" class="transcript-hidden" style="margin-top: 15px; font-size: 24px; min-height: 40px;"></div>
        </div>

        <div id="history-list" class="history-container">
            </div>
    </div>

    <div id="group-view" class="hidden">
        <div style="text-align: center; padding: 10px;">
            <button class="btn btn-action" onclick="startGroupingAnimation()">â­ INICIAR DISTRIBUCIÃ“N</button>
        </div>
        
        <div id="grouping-canvas">
            <div class="group-box group-1"><h3 style="color: #d2a8ff;">GRUPO 1</h3></div>
            <div class="group-box group-2"><h3 style="color: #79c0ff;">GRUPO 2</h3></div>
            <div class="group-box group-3"><h3 style="color: #56d364;">GRUPO 3</h3></div>
        </div>
    </div>

    <script>
        const GROUPS = {
            "Aya Z.": 1, "Hamza": 1, "Malak": 1, "Omar": 1,
            "Aya G.": 2, "Zakariya": 2, "Fatima zahra": 2, "Hiba": 2,
            "Othmane": 3, "Aya B.": 3, "Marwa": 3, "Souhail": 3
        };

        let studentsData = [];
        let currentSpeaker = null; // Object ÙƒØ§Ù…Ù„
        let historyStack = []; // Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ø³Ø§Ø¨Ù‚ÙŠÙ†

        async function init() {
            const res = await databases.listDocuments(CLIENT_CONFIG.databaseId, CLIENT_CONFIG.collectionId);
            studentsData = res.documents;
            renderMonitor();

            client.subscribe(`databases.${CLIENT_CONFIG.databaseId}.collections.${CLIENT_CONFIG.collectionId}.documents`, response => {
                const doc = response.payload;
                const idx = studentsData.findIndex(s => s.$id === doc.$id);
                if (idx !== -1) studentsData[idx] = doc;
                
                renderMonitor();
                
                // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ØªØ­Ø¯Ø« Ø§Ù„Ø­Ø§Ù„ÙŠ ÙÙ‚Ø· Ø¥Ø°Ø§ ÙˆØµÙ„ Ù†Øµ Ø¬Ø¯ÙŠØ¯
                if (currentSpeaker && currentSpeaker.$id === doc.$id && doc.transcript) {
                    currentSpeaker.transcript = doc.transcript; // Ù†Ø­Ø¯Ø« Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù…Ø­Ù„ÙŠØ©
                    document.getElementById('reveal-btn-current').classList.remove('hidden');
                    // Ù†Ø®Ø²Ù† Ø§Ù„Ù†Øµ ÙÙŠ Ø¹Ù†ØµØ± Ù…Ø®ÙÙŠ Ù„Ù†ÙƒØ´ÙÙ‡ Ù„Ø§Ø­Ù‚Ø§Ù‹
                    document.getElementById('speaker-text-current').dataset.text = doc.transcript;
                    document.getElementById('speaker-text-current').innerText = "Respuesta recibida (oculta)";
                }
            });
        }
        init();

        function renderMonitor() {
            const container = document.getElementById('monitor-view');
            container.innerHTML = '';
            studentsData.forEach(s => {
                if (s.status !== 'online' && !s.cheated) return;
                const card = document.createElement('div');
                card.className = `card ${s.cheated ? 'cheated' : ''} ${s.is_turn ? 'speaking' : ''}`;
                let html = `<h3>${s.name}</h3>`;
                if (s.cheated) html += `<h1 style="color:white;">Â¡TE VI!</h1>`;
                else html += `<p>CONECTADO</p>`;
                card.innerHTML = html;
                container.appendChild(card);
            });
        }

        // --- Logic: Turnos ---
        async function nextTurn() {
            // 1. Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ Ù…ØªØ­Ø¯Ø« Ø­Ø§Ù„ÙŠØŒ Ø§Ù†Ù‚Ù„Ù‡ Ù„Ù„Ø£Ø±Ø´ÙŠÙ (History)
            if (currentSpeaker) {
                // Ù†ÙˆÙ‚Ù Ø¯ÙˆØ±Ù‡ ÙÙŠ Ø§Ù„Ø¯Ø§ØªØ§Ø¨ÙŠØ²
                databases.updateDocument(CLIENT_CONFIG.databaseId, CLIENT_CONFIG.collectionId, currentSpeaker.$id, { is_turn: false });
                addToHistory(currentSpeaker);
            }

            // 2. ØªÙ†Ø¸ÙŠÙ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ù„Ù„Ø¬Ø¯ÙŠØ¯
            document.getElementById('active-turn-card').classList.remove('hidden');
            document.getElementById('reveal-btn-current').classList.add('hidden');
            const textBox = document.getElementById('speaker-text-current');
            textBox.innerText = "";
            textBox.className = "transcript-hidden";
            textBox.dataset.text = "";

            // 3. Ø§Ø®ØªÙŠØ§Ø± Ø¹Ø´ÙˆØ§Ø¦ÙŠ
            const eligible = studentsData.filter(s => s.status === 'online' && !s.cheated);
            if (eligible.length === 0) { alert("Â¡No hay estudiantes disponibles!"); return; }
            
            const lucky = eligible[Math.floor(Math.random() * eligible.length)];
            currentSpeaker = lucky; // Ù†Ø­ØªÙØ¸ Ø¨Ù‡ ÙƒÙ€ Object
            
            document.getElementById('speaker-name').innerText = lucky.name;

            // 4. ØªÙØ¹ÙŠÙ„ ÙÙŠ Ø§Ù„Ø¯Ø§ØªØ§Ø¨ÙŠØ²
            await databases.updateDocument(CLIENT_CONFIG.databaseId, CLIENT_CONFIG.collectionId, lucky.$id, { 
                is_turn: true,
                transcript: "" 
            });
        }

        function revealCurrent() {
            const textBox = document.getElementById('speaker-text-current');
            const text = textBox.dataset.text || "";
            textBox.innerText = `"${text}"`;
            textBox.className = "transcript-revealed";
        }

        function addToHistory(student) {
            const list = document.getElementById('history-list');
            const div = document.createElement('div');
            div.className = 'history-card';
            
            // Ù†Ø¬Ù„Ø¨ Ø§Ù„Ù†Øµ Ø§Ù„Ø£Ø®ÙŠØ± Ù…Ù† Ø§Ù„Ù€ DOM Ø£Ùˆ Ù…Ù† Ø§Ù„Ù€ Object
            const lastText = document.getElementById('speaker-text-current').dataset.text || student.transcript || "...";
            
            div.innerHTML = `
                <span class="history-name">${student.name}</span>
                <div style="display:flex; align-items:center; gap:10px;">
                    <span id="hist-text-${student.$id}" class="transcript-hidden" style="font-size:14px;">${lastText}</span>
                    <button class="btn btn-action" style="padding:5px 10px; font-size:12px;" onclick="revealHistory('${student.$id}')">ğŸ‘ï¸</button>
                </div>
            `;
            // Ù†Ø¶ÙŠÙÙ‡ ÙÙŠ Ø§Ù„Ø£Ø¹Ù„Ù‰ (Prepend)
            list.insertBefore(div, list.firstChild);
        }

        function revealHistory(id) {
            const el = document.getElementById(`hist-text-${id}`);
            el.className = "transcript-revealed";
        }

        // --- Logic: Grupos (Stars Animation) ---
        function startGroupingAnimation() {
            const canvas = document.getElementById('grouping-canvas');
            // Ù…Ø³Ø­ Ø§Ù„Ù‚Ø¯ÙŠÙ…
            document.querySelectorAll('.floating-name').forEach(e => e.remove());

            const activeStudents = studentsData.filter(s => s.status === 'online' || s.cheated);
            
            // 1. Ø®Ù„Ù‚ Ø§Ù„Ù†Ø¬ÙˆÙ… ÙÙŠ Ø§Ù„ÙˆØ³Ø·
            activeStudents.forEach(s => {
                const el = document.createElement('div');
                el.className = 'floating-name';
                // â­ Ù‡Ù†Ø§ Ø§Ù„ØªØºÙŠÙŠØ±: Ù†Ø¬Ù…Ø© + Ø§Ù„Ø§Ø³Ù…
                el.innerHTML = `<div class="star-icon">â­</div> ${s.name}`;
                el.dataset.name = s.name;
                
                const centerX = canvas.clientWidth / 2 - 60 + (Math.random() * 100 - 50);
                const centerY = canvas.clientHeight / 2 - 30 + (Math.random() * 100 - 50);
                
                el.style.left = centerX + 'px';
                el.style.top = centerY + 'px';
                el.style.display = 'flex'; // ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ù†Ø¬Ù…Ø© Ù…Ø¹ Ø§Ù„Ø§Ø³Ù…
                el.style.alignItems = 'center';
                
                canvas.appendChild(el);
            });

            // 2. Ø§Ù„ØªØ­Ø±ÙŠÙƒ
            setTimeout(() => {
                document.querySelectorAll('.floating-name').forEach(el => {
                    const name = el.dataset.name;
                    const groupNum = GROUPS[name] || 2;
                    
                    let targetX, targetY;
                    const jitterX = Math.random() * 120;
                    const jitterY = Math.random() * 150;

                    if (groupNum === 1) { targetX = 30 + jitterX; targetY = 70 + jitterY; }
                    else if (groupNum === 2) { targetX = canvas.clientWidth * 0.35 + 30 + jitterX; targetY = 70 + jitterY; }
                    else { targetX = canvas.clientWidth * 0.70 + 30 + jitterX; targetY = 70 + jitterY; }

                    el.style.left = targetX + 'px';
                    el.style.top = targetY + 'px';
                    
                    setTimeout(() => {
                        el.style.transform = "scale(1.1)";
                        setTimeout(() => el.style.transform = "scale(1)", 200);
                    }, 1500);
                });
            }, 1000);
        }

        function switchMode(mode) {
            document.getElementById('monitor-view').classList.add('hidden');
            document.getElementById('turn-view').classList.add('hidden');
            document.getElementById('group-view').classList.add('hidden');
            
            if (mode === 'monitor') {
                document.getElementById('monitor-view').classList.remove('hidden');
                document.getElementById('mode-title').innerText = "MODO: MONITOR";
            } else if (mode === 'turn') {
                document.getElementById('turn-view').classList.remove('hidden');
                document.getElementById('mode-title').innerText = "MODO: TURNOS";
            } else if (mode === 'group') {
                document.getElementById('group-view').classList.remove('hidden');
                document.getElementById('grouping-canvas').style.display = 'block';
                document.getElementById('mode-title').innerText = "MODO: GRUPOS";
            }
        }

        async function resetAll() {
            if(confirm("Â¿Reiniciar todo el sistema?")) {
                studentsData.forEach(s => {
                    databases.updateDocument(CLIENT_CONFIG.databaseId, CLIENT_CONFIG.collectionId, s.$id, { 
                        status: 'offline', cheated: false, is_turn: false, transcript: ""
                    });
                });
                location.reload();
            }
        }
    </script>
</body>
</html>