<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Panel de Control</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/appwrite@13.0.0"></script>
    <script src="config.js"></script>
</head>
<body>

    <div style="background: #161b22; padding: 15px; border-bottom: 1px solid #30363d; display: flex; justify-content: space-between; align-items: center;">
        <h2 id="mode-title" style="margin: 0; color: #58a6ff;">MODO: MONITOR</h2>
        <div style="display: flex; gap: 10px;">
            <button class="btn btn-action" onclick="switchMode('monitor')">ğŸ“Š MONITOR</button>
            <button class="btn btn-blue" onclick="switchMode('turn')">ğŸ° RULETA</button>
            <button class="btn btn-gold" onclick="switchMode('group')">ğŸ§© GRUPOS</button>
            <button class="btn btn-danger" onclick="resetAll()">ğŸ”„ RESET</button>
        </div>
    </div>

    <div id="monitor-view" class="dashboard-grid"></div>

    <div id="turn-view" class="turn-container hidden">
        <button id="next-btn" class="btn btn-blue" onclick="startRoulette()" style="font-size: 24px; padding: 15px 40px;">
            â¡ï¸ GIRAR RULETA
        </button>

        <div id="roulette-display" class="roulette-box hidden">...</div>

        <div id="status-badge" class="status-badge hidden"></div>

        <button id="reveal-btn" class="btn btn-gold hidden" style="margin-top: 20px; font-size: 20px;" onclick="revealAnswer()">
            ğŸ‘ï¸ MOSTRAR RESPUESTA
        </button>

        <div id="transcript-result" class="transcript-box"></div>
    </div>

    <div id="group-view" class="hidden">
        <div style="text-align: center; padding: 20px;">
            <button class="btn btn-action" onclick="organizeGroups()">â­ DISTRIBUIR GRUPOS</button>
        </div>
        <div id="grouping-canvas">
            <div class="group-column group-1">
                <h3 style="color: #d2a8ff;">GRUPO 1</h3>
                <div id="g1-container" style="width: 100%; position: relative; flex-grow: 1;"></div>
            </div>
            <div class="group-column group-2">
                <h3 style="color: #79c0ff;">GRUPO 2</h3>
                <div id="g2-container" style="width: 100%; position: relative; flex-grow: 1;"></div>
            </div>
            <div class="group-column group-3">
                <h3 style="color: #56d364;">GRUPO 3</h3>
                <div id="g3-container" style="width: 100%; position: relative; flex-grow: 1;"></div>
            </div>
        </div>
    </div>

    <script>
        const GROUPS = {
            "Fatima zahra": 1, "Hamza": 1, "Othmane": 1, "Omar": 1,
            "Souhail": 2, "Zakariya": 2, "Marwa": 2, "Malak": 2,
            "Hiba": 3, "Aya G.": 3, "Aya B.": 3, "Aya Z.": 3
        };

        let studentsData = [];
        let currentSpeaker = null;
        let playedIDs = new Set();
        let lastGroupID = -1;

        async function init() {
            // Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£ÙˆÙ„ÙŠØ©
            const res = await databases.listDocuments(CLIENT_CONFIG.databaseId, CLIENT_CONFIG.collectionId);
            studentsData = res.documents;
            renderMonitor();

            // Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ù„ØªØºÙŠÙŠØ±Ø§Øª ÙÙŠ Ø§Ù„ÙˆÙ‚Øª Ø§Ù„ÙØ¹Ù„ÙŠ
            client.subscribe(`databases.${CLIENT_CONFIG.databaseId}.collections.${CLIENT_CONFIG.collectionId}.documents`, response => {
                const doc = response.payload;
                const idx = studentsData.findIndex(s => s.$id === doc.$id);
                if (idx !== -1) studentsData[idx] = doc;
                
                renderMonitor(); // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø© Ø¯Ø§Ø¦Ù…Ø§Ù‹

                // âœ… Ø§Ù„Ù…Ù†Ø·Ù‚ Ø§Ù„Ø­Ø§Ø³Ù…: Ø¥Ø°Ø§ ÙˆØµÙ„ Ù†Øµ Ø¬Ø¯ÙŠØ¯ Ù„Ù„Ù…ØªØ­Ø¯Ø« Ø§Ù„Ø­Ø§Ù„ÙŠ
                if (currentSpeaker && currentSpeaker.$id === doc.$id && doc.transcript && doc.transcript.length > 0) {
                    currentSpeaker.transcript = doc.transcript;
                    
                    // ØªØºÙŠÙŠØ± Ø§Ù„Ø­Ø§Ù„Ø© Ù…Ù† "Ø§Ù†ØªØ¸Ø§Ø±" Ø¥Ù„Ù‰ "Ø¬Ø§Ù‡Ø²"
                    const badge = document.getElementById('status-badge');
                    badge.className = "status-badge status-ready";
                    badge.innerText = "Â¡AUDIO RECIBIDO!";
                    
                    // Ø¥Ø¸Ù‡Ø§Ø± Ø²Ø± Ø§Ù„ÙƒØ´Ù
                    document.getElementById('reveal-btn').classList.remove('hidden');
                }
            });
        }
        init();

        // --- 1. MONITOR LOGIC ---
        function renderMonitor() {
            const container = document.getElementById('monitor-view');
            container.innerHTML = '';
            
            studentsData.forEach(s => {
                // ÙÙ‚Ø· Ø§Ù„Ù…ØªØµÙ„ÙŠÙ† Ø£Ùˆ Ø§Ù„ØºØ´Ø§Ø´ÙŠÙ†
                if (s.status === 'offline' && !s.cheated) return;

                const card = document.createElement('div');
                card.className = `monitor-card ${s.cheated ? 'cheated' : 'online'}`;
                
                let html = `
                    <div style="display: flex; align-items: center; justify-content: space-between;">
                        <span style="font-weight: bold; font-size: 1.1em;">${s.name}</span>
                        <div class="status-indicator"></div>
                    </div>
                    <div style="margin-top: 10px; font-size: 0.9em; opacity: 0.7;">
                        ${s.cheated ? 'Â¡SALÃO DE LA APP!' : 'En lÃ­nea'}
                    </div>
                `;
                card.innerHTML = html;
                container.appendChild(card);
            });
        }

        // --- 2. ROULETTE LOGIC ---
        async function startRoulette() {
            // ØªÙ†Ø¸ÙŠÙ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©
            document.getElementById('reveal-btn').classList.add('hidden');
            document.getElementById('transcript-result').classList.remove('revealed');
            document.getElementById('transcript-result').innerText = "";
            document.getElementById('status-badge').classList.add('hidden');
            
            // 1. ÙÙ„ØªØ±Ø© Ø§Ù„Ù…Ø±Ø´Ø­ÙŠÙ†
            let candidates = studentsData.filter(s => 
                s.status === 'online' && 
                !s.cheated && 
                !playedIDs.has(s.$id)
            );

            // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ¯ÙˆÙŠØ± Ø§Ù„ØµØ§Ù…Øª (Silent Reset)
            if (candidates.length === 0) {
                playedIDs.clear();
                candidates = studentsData.filter(s => s.status === 'online' && !s.cheated);
            }

            if (candidates.length === 0) { alert("No hay alumnos conectados."); return; }

            // 2. ØªØ¬Ù†Ø¨ Ù†ÙØ³ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©
            let bestCandidates = candidates.filter(s => GROUPS[s.name] !== lastGroupID);
            let finalPool = bestCandidates.length > 0 ? bestCandidates : candidates;

            // 3. Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ÙØ§Ø¦Ø²
            const winner = finalPool[Math.floor(Math.random() * finalPool.length)];
            currentSpeaker = winner;
            lastGroupID = GROUPS[winner.name];
            playedIDs.add(winner.$id);

            // 4. ØªØ´ØºÙŠÙ„ Ø§Ù†ÙŠÙ…ÙŠØ´Ù† Ø§Ù„Ø±ÙˆÙ„ÙŠØª
            const display = document.getElementById('roulette-display');
            display.classList.remove('hidden');
            document.getElementById('next-btn').disabled = true;

            let steps = 0;
            const maxSteps = 20; // Ø¹Ø¯Ø¯ ØªÙ‚Ù„Ø¨Ø§Øª Ø§Ù„Ø£Ø³Ù…Ø§Ø¡
            const interval = setInterval(async () => {
                // Ø¹Ø±Ø¶ Ø£Ø³Ù…Ø§Ø¡ Ø¹Ø´ÙˆØ§Ø¦ÙŠØ© Ù„Ù„ØªØ£Ø«ÙŠØ±
                const randomName = studentsData[Math.floor(Math.random() * studentsData.length)].name;
                display.innerText = randomName;
                steps++;

                if (steps >= maxSteps) {
                    clearInterval(interval);
                    // Ø§Ù„ØªÙˆÙ‚Ù Ø¹Ù†Ø¯ Ø§Ù„ÙØ§Ø¦Ø²
                    display.innerText = winner.name;
                    display.style.color = "#d29922"; // Ù„ÙˆÙ† Ø°Ù‡Ø¨ÙŠ
                    display.style.transform = "scale(1.2)";
                    
                    // ØªÙØ¹ÙŠÙ„ Ø­Ø§Ù„Ø© Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±
                    document.getElementById('status-badge').className = "status-badge status-waiting";
                    document.getElementById('status-badge').innerText = "ESPERANDO AUDIO...";
                    document.getElementById('status-badge').classList.remove('hidden');

                    document.getElementById('next-btn').disabled = false;

                    // ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„ÙŠØ¨Ø¯Ø£ Ø§Ù„Ø·Ø§Ù„Ø¨
                    await databases.updateDocument(CLIENT_CONFIG.databaseId, CLIENT_CONFIG.collectionId, winner.$id, {
                        is_turn: true,
                        transcript: "" // Ù…Ø³Ø­ Ø§Ù„Ù‚Ø¯ÙŠÙ…
                    });
                }
            }, 100);
        }

        function revealAnswer() {
            const box = document.getElementById('transcript-result');
            box.innerText = `"${currentSpeaker.transcript}"`;
            box.classList.add('revealed');
            // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø²Ø± Ø¨Ø¹Ø¯ Ø§Ù„ÙƒØ´Ù
            document.getElementById('reveal-btn').classList.add('hidden');
            
            // Ø¥Ù†Ù‡Ø§Ø¡ Ø¯ÙˆØ± Ø§Ù„Ø·Ø§Ù„Ø¨
            databases.updateDocument(CLIENT_CONFIG.databaseId, CLIENT_CONFIG.collectionId, currentSpeaker.$id, {
                is_turn: false
            });
        }

        // --- 3. SMART GROUPS LOGIC ---
        function organizeGroups() {
            // ØªÙ†Ø¸ÙŠÙ
            document.querySelectorAll('.student-chip').forEach(e => e.remove());
            
            const activeStudents = studentsData.filter(s => s.status === 'online' || s.cheated);
            const canvas = document.getElementById('grouping-canvas');
            
            // Ø¹Ø¯Ø§Ø¯Ø§Øª Ù„Ù„Ù…ÙˆØ§Ø¶Ø¹ Ø¯Ø§Ø®Ù„ ÙƒÙ„ Ù…Ø¬Ù…ÙˆØ¹Ø©
            let counts = { 1: 0, 2: 0, 3: 0 };

            activeStudents.forEach((s, index) => {
                const grp = GROUPS[s.name] || 2;
                const chip = document.createElement('div');
                chip.className = 'student-chip';
                chip.innerText = s.name;
                
                // Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©: ÙˆØ³Ø· Ø§Ù„Ø´Ø§Ø´Ø©
                chip.style.left = "50%";
                chip.style.top = "50%";
                chip.style.transform = "translate(-50%, -50%) scale(0)";
                
                canvas.appendChild(chip);

                // Ø§Ù„Ø­Ø±ÙƒØ© Ù†Ø­Ùˆ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©
                setTimeout(() => {
                    const targetContainer = document.querySelector(`.group-${grp}`);
                    // Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…ÙˆØ¶Ø¹ Ø§Ù„Ù†Ø³Ø¨ÙŠ
                    // Ù‡Ù†Ø§ Ø§Ù„Ø®Ø¯Ø¹Ø©: Ø¨Ø¯Ù„ absolute coordinatesØŒ Ø³Ù†Ø¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø­Ø§ÙˆÙŠØ©
                    // Ù„ÙƒÙ† Ù„Ù„Ø­Ø±ÙƒØ© Ø§Ù„Ø³Ù„Ø³Ø©ØŒ Ø³Ù†Ø­Ø³Ø¨ Ø§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª
                    
                    // Ø§Ù„Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø£Ø¨Ø³Ø· ÙˆØ§Ù„Ø£Ø¬Ù…Ù„:
                    // Ù†Ù‚Ù„ Ø§Ù„Ø¹Ù†ØµØ± Ø¥Ù„Ù‰ Ø§Ù„Ù€ Container Ø§Ù„Ø®Ø§Øµ Ø¨Ù‡ ÙˆØªØºÙŠÙŠØ± Ø§Ù„Ù€ positioning
                    chip.style.position = "relative";
                    chip.style.left = "auto";
                    chip.style.top = "auto";
                    chip.style.transform = "scale(1)";
                    chip.style.margin = "5px 0";
                    
                    // Ø¥Ø¶Ø§ÙØªÙ‡ Ù„Ù„Ø¹Ù…ÙˆØ¯ Ø§Ù„ØµØ­ÙŠØ­
                    const colId = `g${grp}-container`;
                    document.getElementById(colId).appendChild(chip);
                    
                }, 100 + (index * 100)); // ØªØ£Ø®ÙŠØ± Ù…ØªØªØ§Ø¨Ø¹
            });
        }

        // --- UTILS ---
        function switchMode(mode) {
            ['monitor-view', 'turn-view', 'group-view'].forEach(id => document.getElementById(id).classList.add('hidden'));
            
            if (mode === 'monitor') {
                document.getElementById('monitor-view').classList.remove('hidden');
                document.getElementById('mode-title').innerText = "MODO: MONITOR";
            } else if (mode === 'turn') {
                document.getElementById('turn-view').classList.remove('hidden');
                document.getElementById('mode-title').innerText = "MODO: RULETA";
            } else if (mode === 'group') {
                document.getElementById('group-view').classList.remove('hidden');
                document.getElementById('grouping-canvas').style.display = 'block';
                document.getElementById('mode-title').innerText = "MODO: GRUPOS";
            }
        }

        async function resetAll() {
            if(confirm("Â¿EstÃ¡s seguro de reiniciar todo?")) {
                studentsData.forEach(s => {
                    databases.updateDocument(CLIENT_CONFIG.databaseId, CLIENT_CONFIG.collectionId, s.$id, { 
                        status: 'offline', cheated: false, is_turn: false, transcript: ""
                    });
                });
                location.reload();
            }
        }
    </script>
</body>
</html>