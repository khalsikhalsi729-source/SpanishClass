<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Control - Ruleta</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/appwrite@13.0.0"></script>
    <script src="config.js"></script>
    <style>
        body { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; background: #0d1117; }
        /* ØªØµÙ…ÙŠÙ… Ø¨Ø³ÙŠØ· Ø¬Ø¯Ø§Ù‹: Ø²Ø± ÙˆØ¹Ø¬Ù„Ø© ÙÙ‚Ø· */
        .roulette-container { text-align: center; width: 100%; max-width: 800px; }
        .roulette-text { font-size: 5rem; font-weight: 900; color: #58a6ff; min-height: 120px; text-shadow: 0 0 30px rgba(88,166,255,0.4); margin: 30px 0; }
        .btn-spin { font-size: 2rem; padding: 20px 60px; border-radius: 50px; background: #1f6feb; border: none; color: white; cursor: pointer; box-shadow: 0 10px 40px rgba(31,111,235,0.4); transition: transform 0.2s; }
        .btn-spin:active { transform: scale(0.95); }
        .btn-spin:disabled { background: #30363d; cursor: not-allowed; box-shadow: none; }
        
        .history-btn { position: absolute; top: 20px; right: 20px; background: #d29922; border: none; color: white; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: bold; }
        .reset-btn { position: absolute; top: 20px; left: 20px; background: #da3633; border: none; color: white; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: bold; }
        
        /* Modal Historial */
        #history-modal { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 70%; height: 80%; background: #161b22; border: 2px solid #d29922; border-radius: 12px; z-index: 2000; padding: 20px; overflow-y: auto; box-shadow: 0 0 100px black; text-align: left; }
        .history-item { background: #0d1117; padding: 15px; margin-bottom: 10px; border-radius: 8px; border: 1px solid #30363d; }
    </style>
</head>
<body>

    <button class="reset-btn" onclick="resetAll()">ğŸ”„ RESET</button>
    <button class="history-btn" onclick="toggleHistory()">ğŸ“œ HISTORIAL</button>

    <div class="roulette-container">
        <h1 style="color: gray; font-size: 1.5rem; text-transform: uppercase; letter-spacing: 2px;">Elige un estudiante</h1>
        
        <div id="roulette-display" class="roulette-text">...</div>
        
        <button id="spin-btn" class="btn-spin" onclick="startRoulette()">ğŸ² GIRAR 4444</button>
        
        <div id="status-msg" style="margin-top: 30px; color: #238636; font-size: 1.5rem; display: none;">
            ğŸ“¢ Esperando audio del estudiante...
        </div>
    </div>

    <div id="history-modal">
        <div style="display: flex; justify-content: space-between; margin-bottom: 20px;">
            <h2 style="color: #d29922; margin: 0;">HISTORIAL</h2>
            <button onclick="toggleHistory()" style="background: none; border: none; color: white; font-size: 24px; cursor: pointer;">âœ•</button>
        </div>
        <div id="history-list"></div>
    </div>

    <script>
        const GROUPS = {
            "Fatima zahra": 1, "Hamza": 1, "Othmane": 1, "Omar": 1,
            "Souhail": 2, "Zakariya": 2, "Marwa": 2, "Malak": 2,
            "Hiba": 3, "Aya G.": 3, "Aya B.": 3, "Aya Z.": 3
        };

        let studentsData = [];
        let currentSpeaker = null;
        let playedIDs = new Set();
        let lastGroupID = -1;
        let historyLog = [];

        // 1. Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆÙ…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„ØµÙˆØª Ø§Ù„Ù‚Ø§Ø¯Ù…
        async function init() {
            const res = await databases.listDocuments(CLIENT_CONFIG.databaseId, CLIENT_CONFIG.collectionId);
            studentsData = res.documents;

            client.subscribe(`databases.${CLIENT_CONFIG.databaseId}.collections.${CLIENT_CONFIG.collectionId}.documents`, response => {
                const doc = response.payload;
                const idx = studentsData.findIndex(s => s.$id === doc.$id);
                if (idx !== -1) studentsData[idx] = doc;
                
                // âœ… Ø§Ù„Ù„Ø­Ø¸Ø© Ø§Ù„ØªÙŠ ÙŠØµÙ„ ÙÙŠÙ‡Ø§ Ø§Ù„ØµÙˆØª Ù…Ù† Ø§Ù„ØªÙ„Ù…ÙŠØ°
                if (currentSpeaker && currentSpeaker.$id === doc.$id && doc.transcript && doc.transcript.length > 0) {
                    
                    // Ù…Ù†Ø¹ Ø§Ù„ØªÙƒØ±Ø§Ø±
                    if (historyLog.length > 0 && historyLog[0].text === doc.transcript && historyLog[0].name === doc.name) return;

                    // 1. Ø­ÙØ¸ ÙÙŠ Ø§Ù„Ù‡ÙŠØ³ØªÙˆØ±ÙŠ
                    addToHistory(doc);
                    
                    // 2. Ø¥Ø®ÙØ§Ø¡ Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± ÙˆØªÙØ¹ÙŠÙ„ Ø§Ù„Ø²Ø± Ù…Ø±Ø© Ø£Ø®Ø±Ù‰
                    document.getElementById('status-msg').style.display = 'none';
                    document.getElementById('spin-btn').disabled = false;
                    document.getElementById('spin-btn').innerText = "ğŸ² GIRAR";

                    // 3. Ø¥Ù†Ù‡Ø§Ø¡ Ø¯ÙˆØ± Ø§Ù„ØªÙ„Ù…ÙŠØ° (Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø²Ø± Ù…Ù† Ù‡Ø§ØªÙÙ‡)
                    databases.updateDocument(CLIENT_CONFIG.databaseId, CLIENT_CONFIG.collectionId, currentSpeaker.$id, {
                        is_turn: false
                    });
                }
            });
        }
        init();

        // 2. Ù…Ù†Ø·Ù‚ Ø§Ù„Ø¹Ø¬Ù„Ø© (ÙÙ‚Ø· Ø§Ù„Ù…ØªØµÙ„ÙŠÙ†)
        async function startRoulette() {
            const statusMsg = document.getElementById('status-msg');
            statusMsg.style.display = 'none';
            
            // ÙÙ„ØªØ±: Ø§Ù„Ù…ØªØµÙ„ÙŠÙ† ÙÙ‚Ø· (online)
            let candidates = studentsData.filter(s => s.status === 'online' && !playedIDs.has(s.$id));
            
            // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ¯ÙˆÙŠØ±
            if (candidates.length === 0) {
                playedIDs.clear();
                candidates = studentsData.filter(s => s.status === 'online');
            }

            if (candidates.length === 0) { 
                alert("Â¡No hay nadie conectado! (Los alumnos deben entrar primero)"); 
                return; 
            }

            // ØªØ¬Ù†Ø¨ Ù†ÙØ³ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©
            let bestCandidates = candidates.filter(s => GROUPS[s.name] !== lastGroupID);
            let finalPool = bestCandidates.length > 0 ? bestCandidates : candidates;

            // Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ÙØ§Ø¦Ø²
            const winner = finalPool[Math.floor(Math.random() * finalPool.length)];
            currentSpeaker = winner;
            lastGroupID = GROUPS[winner.name];
            playedIDs.add(winner.$id);

            // ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¹Ø¬Ù„Ø©
            const display = document.getElementById('roulette-display');
            const btn = document.getElementById('spin-btn');
            btn.disabled = true;

            let steps = 0;
            const interval = setInterval(async () => {
                // Ø¹Ø±Ø¶ Ø£Ø³Ù…Ø§Ø¡ Ø¹Ø´ÙˆØ§Ø¦ÙŠØ© Ù…Ù† Ø§Ù„Ù…ØªØµÙ„ÙŠÙ†
                const onlineNames = studentsData.filter(s => s.status === 'online').map(s => s.name);
                display.innerText = onlineNames[Math.floor(Math.random() * onlineNames.length)];
                steps++;

                if (steps >= 20) {
                    clearInterval(interval);
                    
                    // Ø§Ù„ØªÙˆÙ‚Ù Ø¹Ù†Ø¯ Ø§Ù„ÙØ§Ø¦Ø²
                    display.innerText = winner.name;
                    display.style.color = "#d29922";
                    
                    // Ø¥Ø¸Ù‡Ø§Ø± Ø±Ø³Ø§Ù„Ø© Ø§Ù†ØªØ¸Ø§Ø±
                    statusMsg.style.display = 'block';
                    
                    // ğŸ”¥ğŸ”¥ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø£Ù…Ø± Ù„Ù‡Ø§ØªÙ Ø§Ù„ØªÙ„Ù…ÙŠØ° ğŸ”¥ğŸ”¥
                    await databases.updateDocument(CLIENT_CONFIG.databaseId, CLIENT_CONFIG.collectionId, winner.$id, {
                        is_turn: true,
                        transcript: "" 
                    });
                }
            }, 80);
        }

        function addToHistory(doc) {
            const entry = { name: doc.name, text: doc.transcript, time: new Date().toLocaleTimeString() };
            historyLog.unshift(entry);
            
            const list = document.getElementById('history-list');
            const div = document.createElement('div');
            div.className = 'history-item';
            div.innerHTML = `<strong style="color:#58a6ff">${entry.name}</strong> <span style="float:right; color:gray">${entry.time}</span><br><div style="margin-top:5px; font-size:1.2rem;">"${entry.text}"</div>`;
            list.prepend(div);
        }

        function toggleHistory() {
            const modal = document.getElementById('history-modal');
            modal.style.display = (modal.style.display === 'block') ? 'none' : 'block';
        }

        async function resetAll() {
            if(confirm("RESET?")) {
                studentsData.forEach(s => databases.updateDocument(CLIENT_CONFIG.databaseId, CLIENT_CONFIG.collectionId, s.$id, { status: 'offline', is_turn: false, transcript: "" }));
                location.reload();
            }
        }
    </script>
</body>
</html>