<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Panel del Profesor</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/appwrite@13.0.0"></script>
    <script src="config.js"></script>
    <style>
        /* --- ØªØ­Ø³ÙŠÙ†Ø§Øª Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© (UX/UI List) --- */
        .dashboard-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); 
            gap: 20px; 
            padding: 20px;
        }

        /* ØªØµÙ…ÙŠÙ… Ø§Ù„ÙƒØ§Ø±Øª */
        .student-card {
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 12px;
            padding: 20px;
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
        }

        /* ØªØ£Ø«ÙŠØ±Ø§Øª Ø§Ù„Ù€ Hover */
        .student-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 15px rgba(0,0,0,0.4);
            border-color: #58a6ff;
        }

        /* Ø§Ù„Ø­Ø§Ù„Ø©: Ø£ÙˆÙ†Ù„Ø§ÙŠÙ† */
        .status-badge {
            margin-top: 10px;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            display: flex; align-items: center; gap: 6px;
        }
        .online { background: rgba(35, 134, 54, 0.2); color: #3fb950; border: 1px solid #238636; }
        .offline { background: rgba(48, 54, 61, 0.5); color: #8b949e; border: 1px solid #30363d; opacity: 0.7; }
        
        /* Ù†Ù‚Ø·Ø© Ø§Ù„Ù†Ø¨Ø¶ */
        .pulse-dot {
            width: 8px; height: 8px; border-radius: 50%; background: #3fb950;
            box-shadow: 0 0 0 rgba(63, 185, 80, 0.4);
            animation: pulse-green 2s infinite;
        }
        @keyframes pulse-green {
            0% { box-shadow: 0 0 0 0 rgba(63, 185, 80, 0.7); }
            70% { box-shadow: 0 0 0 6px rgba(63, 185, 80, 0); }
            100% { box-shadow: 0 0 0 0 rgba(63, 185, 80, 0); }
        }

        /* Ø§Ù„Ø­Ø§Ù„Ø©: ØºØ´Ø§Ø´ (Cheated) */
        .student-card.cheated {
            background: repeating-linear-gradient(
                45deg,
                #2a0a0a,
                #2a0a0a 10px,
                #3a0f0f 10px,
                #3a0f0f 20px
            );
            border: 2px solid #da3633;
            animation: shake 0.5s;
        }
        .student-card.cheated h3 { color: #da3633; }
        .cheated-badge { background: #da3633; color: white; padding: 5px 10px; border-radius: 5px; font-weight: bold; }

        /* Ø§Ù„Ø­Ø§Ù„Ø©: ÙŠØªØ­Ø¯Ø« (Speaking) */
        .student-card.speaking {
            border: 2px solid #e3b341;
            box-shadow: 0 0 20px rgba(227, 179, 65, 0.3);
            transform: scale(1.05);
            background: #1f1f1f;
        }

        /* --- Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ø³ØªØ§ÙŠÙ„ --- */
        .control-bar { background: #0d1117; padding: 15px; border-bottom: 1px solid #30363d; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px; }
        .mode-title { color: #58a6ff; font-weight: bold; font-size: 20px; display: flex; align-items: center; gap: 10px;}
        .connection-status { font-size: 12px; color: gray; margin-left: 10px; }
        .active-connection { color: #3fb950; }
        .error-connection { color: #da3633; }

        /* Turnos & Groups Styles (Ù†ÙØ³ Ø§Ù„Ø³Ø§Ø¨Ù‚) */
        .turn-display { margin-top: 40px; }
        .active-speaker { font-size: 4em; color: #58a6ff; margin: 20px 0; min-height: 1.2em; }
        .transcript-revealed { font-size: 1.5em; color: #e3b341; margin-top: 20px; padding: 20px; border: 1px solid #e3b341; border-radius: 8px; background: rgba(227,179,65,0.1); }
        
        /* Groups Logic Styles */
        #grouping-canvas { position: relative; height: 70vh; width: 100%; border: 1px dashed #30363d; margin-top: 20px; background: #0d1117; display: flex; flex-direction: column; }
        .groups-container { display: flex; justify-content: space-around; height: 60%; padding-top: 20px; }
        .group-box { width: 30%; height: 100%; border: 2px solid #58a6ff; border-radius: 12px; background: rgba(22, 27, 34, 0.9); display: flex; flex-direction: column; overflow: hidden; }
        .group-header { padding: 10px; font-size: 1.2em; font-weight: bold; border-bottom: 1px solid #58a6ff; text-align: center;}
        .group-1 { border-color: #d2a8ff; } .group-1 .group-header { background: rgba(210, 168, 255, 0.2); color: #d2a8ff; }
        .group-2 { border-color: #79c0ff; } .group-2 .group-header { background: rgba(121, 192, 255, 0.2); color: #79c0ff; }
        .group-3 { border-color: #56d364; } .group-3 .group-header { background: rgba(86, 211, 100, 0.2); color: #56d364; }
        .group-content { flex: 1; padding: 10px; display: flex; flex-wrap: wrap; align-content: flex-start; gap: 8px; justify-content: center; }
        .student-tag { background: #238636; color: white; padding: 8px 12px; border-radius: 20px; font-size: 14px; font-weight: bold; animation: popIn 0.3s ease-out; }
        .staging-area { height: 40%; width: 100%; border-top: 1px solid #30363d; display: flex; justify-content: center; align-items: center; flex-wrap: wrap; gap: 10px; padding: 20px; background: #161b22; }
        .flying-name { position: fixed; z-index: 9999; background: #e3b341; color: black; padding: 10px 15px; border-radius: 20px; font-weight: bold; font-size: 16px; box-shadow: 0 5px 15px rgba(0,0,0,0.5); transition: all 1s cubic-bezier(0.25, 0.8, 0.25, 1); }
        
        @keyframes popIn { from { transform: scale(0); } to { transform: scale(1); } }
        @keyframes shake { 0% { transform: translate(1px, 1px); } 100% { transform: translate(-1px, -1px); } }
    </style>
</head>
<body>

    <div class="control-bar">
        <div class="mode-title">
            <span id="mode-icon">ğŸ“Š</span> 
            <span id="mode-title">MONITOR</span>
            <span id="connection-status" class="connection-status">Conectando...</span>
        </div>
        <div>
            <button class="btn btn-action" onclick="switchMode('monitor')">ğŸ“Š Monitor</button>
            <button class="btn btn-action" onclick="switchMode('turn')">ğŸ° RULETA</button>
            <button class="btn btn-action" onclick="switchMode('group')">ğŸ§© Grupos</button>
            <button class="btn btn-danger" onclick="resetAll()">ğŸ”„ REINICIAR</button>
        </div>
    </div>

    <div id="monitor-view" class="dashboard-grid">
        </div>

    <div id="turn-view" class="hidden">
        <div style="text-align: center; margin-top: 50px;">
            <button id="next-turn-btn" class="btn" onclick="spinTheWheel()" style="width: 300px; font-size: 22px; background: #1f6feb; box-shadow: 0 0 15px #1f6feb;">
                ğŸ² GIRAR RULETA
            </button>
            
            <div id="active-turn-card" class="turn-display">
                <p style="color: gray; letter-spacing: 2px; text-transform: uppercase;">Hablando ahora:</p>
                <h1 id="speaker-name" class="active-speaker">...</h1>
                
                <div id="transcript-area" class="hidden">
                    <button class="btn btn-reveal" style="background: #e3b341; color: black; font-weight: bold;" onclick="revealText()">ğŸ‘ï¸ VER RESPUESTA</button>
                    <div id="speaker-text" style="display: none;" class="transcript-revealed"></div>
                </div>
            </div>
        </div>
    </div>

    <div id="group-view" class="hidden">
        <div style="text-align: center; padding: 10px; background: #0d1117;">
            <button class="btn btn-action" onclick="prepareGrouping()">1. PREPARAR</button>
            <button class="btn btn-action" onclick="executeDistribution()">2. DISTRIBUIR</button>
        </div>
        
        <div id="grouping-canvas">
            <div class="groups-container">
                <div class="group-box group-1" id="box-1"><div class="group-header">GRUPO 1</div><div class="group-content" id="content-1"></div></div>
                <div class="group-box group-2" id="box-2"><div class="group-header">GRUPO 2</div><div class="group-content" id="content-2"></div></div>
                <div class="group-box group-3" id="box-3"><div class="group-header">GRUPO 3</div><div class="group-content" id="content-3"></div></div>
            </div>
            <div class="staging-area" id="staging-area"><p style="width: 100%; color: gray;">Lista de estudiantes...</p></div>
        </div>
    </div>

    <script>
        // --- Config ---
        const GROUPS = {
            "Aya Z.": 1, "Hamza": 1, "Malak": 1, "Omar": 1,
            "Aya G.": 2, "Zakariya": 2, "Fatima zahra": 2, "Hiba": 2,
            "Othmane": 3, "Aya B.": 3, "Marwa": 3, "Souhail": 3
        };

        let studentsData = [];
        let currentSpeakerId = null;
        let isSpinning = false;
        let unsubscribe = null; // Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ

        // --- Init with Error Handling ---
        async function init() {
            updateConnectionStatus("Conectando...", "gray");
            try {
                // Fetch initial data
                const res = await databases.listDocuments(CLIENT_CONFIG.databaseId, CLIENT_CONFIG.collectionId);
                studentsData = res.documents;
                renderMonitor();
                updateConnectionStatus("Conectado â—", "active-connection");
                
                startRealtime();

            } catch (e) {
                console.error("Init Error:", e);
                updateConnectionStatus("Error: " + e.message, "error-connection");
                alert("Error de conexiÃ³n a la base de datos. Verifica el ID del Proyecto y los Permisos.");
            }
        }

        function startRealtime() {
            if(unsubscribe) unsubscribe(); // Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ù‚Ø¯ÙŠÙ… Ø¥Ø°Ø§ ÙˆØ¬Ø¯

            try {
                unsubscribe = client.subscribe(`databases.${CLIENT_CONFIG.databaseId}.collections.${CLIENT_CONFIG.collectionId}.documents`, response => {
                    const doc = response.payload;
                    
                    // Update Local Data
                    const idx = studentsData.findIndex(s => s.$id === doc.$id);
                    if (idx !== -1) studentsData[idx] = doc;
                    else studentsData.push(doc);
                    
                    renderMonitor();
                });
            } catch(e) {
                console.log("Realtime failed, retrying...");
                setTimeout(startRealtime, 2000);
            }
        }

        function updateConnectionStatus(text, className) {
            const el = document.getElementById('connection-status');
            el.innerText = text;
            el.className = "connection-status " + className;
        }

        init();

        // --- 1. Monitor Render (New UX) ---
        function renderMonitor() {
            const container = document.getElementById('monitor-view');
            container.innerHTML = '';
            
            // ØªØ±ØªÙŠØ¨: Ø§Ù„Ø£ÙˆÙ†Ù„Ø§ÙŠÙ† Ù‡Ùˆ Ø§Ù„Ø£ÙˆÙ„
            const sortedStudents = [...studentsData].sort((a, b) => {
                const aActive = a.status === 'online' || a.cheated;
                const bActive = b.status === 'online' || b.cheated;
                return bActive - aActive; 
            });

            if(sortedStudents.length === 0) {
                container.innerHTML = `<p style="color:gray; width:100%; text-align:center;">No hay estudiantes conectados...</p>`;
                return;
            }

            sortedStudents.forEach(s => {
                const isOnline = s.status === 'online';
                const isCheated = s.cheated;
                const isSpeaking = s.is_turn;
                
                const card = document.createElement('div');
                card.className = `student-card ${isCheated ? 'cheated' : ''} ${isSpeaking ? 'speaking' : ''}`;
                
                // ØªØ­Ø¯ÙŠØ¯ Ø´ÙƒÙ„ Ø§Ù„Ù€ Badge
                let badgeHTML = '';
                if(isCheated) {
                    badgeHTML = `<div class="cheated-badge">ğŸš« DETECTADO</div>`;
                } else if(isOnline) {
                    badgeHTML = `<div class="status-badge online"><div class="pulse-dot"></div> EN LÃNEA</div>`;
                } else {
                    badgeHTML = `<div class="status-badge offline">âš« DESCONECTADO</div>`;
                    card.style.opacity = "0.6"; // ØªØºÙ…ÙŠÙ‚ Ø§Ù„Ù„ÙŠ ØºØ§ÙŠØ¨
                }

                card.innerHTML = `
                    <h3 style="margin:0; font-size: 1.2em; color: #e6edf3;">${s.name}</h3>
                    ${badgeHTML}
                    ${isSpeaking ? '<div style="margin-top:5px; color:#e3b341; font-weight:bold;">ğŸ¤ Hablando...</div>' : ''}
                `;
                container.appendChild(card);
            });
        }

        // --- 2. Casino Logic ---
        async function spinTheWheel() {
            if(isSpinning) return;
            
            // Reset Previous
            if (currentSpeakerId) {
                await databases.updateDocument(CLIENT_CONFIG.databaseId, CLIENT_CONFIG.collectionId, currentSpeakerId, { is_turn: false });
                document.getElementById('transcript-area').classList.add('hidden');
                document.getElementById('speaker-text').style.display = 'none';
            }

            const eligible = studentsData.filter(s => s.status === 'online' && !s.cheated);
            if (eligible.length === 0) { alert("Â¡No hay estudiantes activos!"); return; }

            isSpinning = true;
            document.getElementById('next-turn-btn').disabled = true;
            const nameDisplay = document.getElementById('speaker-name');
            nameDisplay.style.color = "white";
            
            let counter = 0;
            const maxSpins = 25;
            const interval = setInterval(() => {
                nameDisplay.innerText = eligible[Math.floor(Math.random() * eligible.length)].name;
                counter++;
                if (counter >= maxSpins) {
                    clearInterval(interval);
                    finalizeTurn(eligible);
                }
            }, 80);
        }

        async function finalizeTurn(eligible) {
            const winner = eligible[Math.floor(Math.random() * eligible.length)];
            const nameDisplay = document.getElementById('speaker-name');
            
            nameDisplay.innerText = winner.name;
            nameDisplay.style.color = "#58a6ff";
            nameDisplay.style.transform = "scale(1.5)";
            setTimeout(() => nameDisplay.style.transform = "scale(1)", 300);

            currentSpeakerId = winner.$id;
            await databases.updateDocument(CLIENT_CONFIG.databaseId, CLIENT_CONFIG.collectionId, winner.$id, { 
                is_turn: true, transcript: "" 
            });

            isSpinning = false;
            document.getElementById('next-turn-btn').disabled = false;
            setTimeout(() => { document.getElementById('transcript-area').classList.remove('hidden'); }, 1000);
        }

        async function revealText() {
            const textBox = document.getElementById('speaker-text');
            textBox.innerText = "â³ Cargando...";
            textBox.style.display = 'block';

            try {
                // Force fetch from server
                const doc = await databases.getDocument(CLIENT_CONFIG.databaseId, CLIENT_CONFIG.collectionId, currentSpeakerId);
                if (doc.transcript) {
                    textBox.innerText = `"${doc.transcript}"`;
                    textBox.className = "transcript-revealed";
                } else {
                    textBox.innerText = "âš ï¸ AÃºn no hay datos.";
                }
            } catch(e) { textBox.innerText = "Error al cargar el texto."; }
        }

        // --- 3. Groups Logic ---
        function prepareGrouping() {
            ['content-1', 'content-2', 'content-3', 'staging-area'].forEach(id => document.getElementById(id).innerHTML = '');
            
            const activeStudents = studentsData.filter(s => s.status === 'online' || s.cheated);
            const staging = document.getElementById('staging-area');

            activeStudents.forEach(s => {
                const badge = document.createElement('div');
                badge.className = 'student-tag';
                badge.style.background = '#30363d';
                badge.innerText = s.name;
                badge.dataset.name = s.name;
                staging.appendChild(badge);
            });
        }

        function executeDistribution() {
            const tags = Array.from(document.querySelectorAll('#staging-area .student-tag'));
            tags.forEach((tag, index) => {
                setTimeout(() => animateTagToGroup(tag), index * 600);
            });
        }

        function animateTagToGroup(originalTag) {
            const name = originalTag.dataset.name;
            const groupNum = GROUPS[name] || 2;
            const targetBox = document.getElementById(`box-${groupNum}`);
            const targetContent = document.getElementById(`content-${groupNum}`);

            const rectStart = originalTag.getBoundingClientRect();
            const rectEnd = targetBox.getBoundingClientRect();

            const flyer = document.createElement('div');
            flyer.className = 'flying-name';
            flyer.innerText = name;
            flyer.style.left = rectStart.left + 'px';
            flyer.style.top = rectStart.top + 'px';
            flyer.style.width = rectStart.width + 'px';
            document.body.appendChild(flyer);
            
            originalTag.style.opacity = 0;

            flyer.getBoundingClientRect(); 
            flyer.style.left = (rectEnd.left + rectEnd.width/2 - 50) + 'px';
            flyer.style.top = (rectEnd.top + rectEnd.height/2) + 'px';
            flyer.style.background = groupNum === 1 ? '#d2a8ff' : (groupNum === 2 ? '#79c0ff' : '#56d364');

            setTimeout(() => {
                flyer.remove();
                const finalTag = document.createElement('div');
                finalTag.className = 'student-tag';
                finalTag.innerText = name;
                finalTag.style.background = flyer.style.background;
                targetContent.appendChild(finalTag);
            }, 1000);
        }

        // --- Navigation & Reset ---
        function switchMode(mode) {
            ['monitor-view', 'turn-view', 'group-view'].forEach(id => document.getElementById(id).classList.add('hidden'));
            document.getElementById(mode + '-view').classList.remove('hidden');
            
            const titles = { monitor: "MONITOR", turn: "CASINO", group: "GRUPOS" };
            document.getElementById('mode-title').innerText = titles[mode];
        }

        async function resetAll() {
            if(confirm("Â¿Reiniciar todo?")) {
                studentsData.forEach(s => {
                    databases.updateDocument(CLIENT_CONFIG.databaseId, CLIENT_CONFIG.collectionId, s.$id, { 
                        status: 'offline', cheated: false, is_turn: false, transcript: ""
                    });
                });
                setTimeout(() => location.reload(), 1000);
            }
        }
    </script>
</body>
</html>