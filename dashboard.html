<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Teacher Dashboard</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/appwrite@13.0.0"></script>
    <script src="config.js"></script>
    <style>
        .control-bar { display: flex; justify-content: space-between; background: #161b22; padding: 15px; border-bottom: 2px solid #30363d; }
        .mode-title { color: #58a6ff; font-weight: bold; font-size: 24px; text-transform: uppercase; }
        .turn-display { text-align: center; margin: 20px; padding: 20px; border: 2px solid #58a6ff; border-radius: 10px; display: none; }
        .active-speaker { font-size: 3em; color: #58a6ff; animation: pulse 2s infinite; }
    </style>
</head>
<body>

    <div class="control-bar">
        <div class="mode-title" id="mode-title">MODO: MONITOR</div>
        <div>
            <button class="btn btn-action" onclick="switchMode('monitor')">ğŸ“Š Monitor</button>
            <button class="btn btn-action" onclick="switchMode('turn')">ğŸ¤ Turnos</button>
            <button class="btn btn-action" onclick="switchMode('group')">ğŸ§© Grupos</button>
            <button class="btn btn-danger" onclick="resetAll()" style="width: auto;">ğŸ”„ RESET</button>
        </div>
    </div>

    <div id="monitor-view" class="dashboard-grid grid" style="padding: 20px;"></div>

    <div id="turn-view" class="hidden">
        <div style="text-align: center; margin-top: 50px;">
            <button class="btn" onclick="nextTurn()" style="width: 300px; font-size: 20px; background: #1f6feb;">â¡ï¸ SIGUIENTE TURNO</button>
            
            <div id="active-turn-card" class="turn-display">
                <p style="color: gray;">Hablando ahora:</p>
                <h1 id="speaker-name" class="active-speaker">...</h1>
                
                <button id="reveal-btn" class="btn btn-reveal hidden" onclick="revealText()">ğŸ‘ï¸ REVEAL ANSWER</button>
                
                <div id="speaker-text" class="transcript-hidden" style="margin-top: 20px; font-size: 24px;"></div>
            </div>
        </div>
    </div>

    <div id="group-view" class="hidden">
        <div style="text-align: center; padding: 10px;">
            <button class="btn btn-action" onclick="startGroupingAnimation()">ğŸ¬ START ANIMATION</button>
        </div>
        
        <div id="grouping-canvas">
            <div class="group-box group-1"><h3>GRUPO 1</h3></div>
            <div class="group-box group-2"><h3>GRUPO 2</h3></div>
            <div class="group-box group-3"><h3>GRUPO 3</h3></div>
            </div>
    </div>

    <script>
        // ØªØ¹Ø±ÙŠÙ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª ÙŠØ¯ÙˆÙŠØ§Ù‹
        const GROUPS = {
            "Aya Z.": 1, "Hamza": 1, "Malak": 1, "Omar": 1,
            "Aya G.": 2, "Zakariya": 2, "Fatima zahra": 2, "Hiba": 2,
            "Othmane": 3, "Aya B.": 3, "Marwa": 3, "Souhail": 3
        };

        let studentsData = [];
        let currentSpeakerId = null;

        async function init() {
            // Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆÙ…Ø±Ø§Ù‚Ø¨ØªÙ‡Ø§
            const res = await databases.listDocuments(CLIENT_CONFIG.databaseId, CLIENT_CONFIG.collectionId);
            studentsData = res.documents;
            renderMonitor();

            client.subscribe(`databases.${CLIENT_CONFIG.databaseId}.collections.${CLIENT_CONFIG.collectionId}.documents`, response => {
                const doc = response.payload;
                const idx = studentsData.findIndex(s => s.$id === doc.$id);
                if (idx !== -1) studentsData[idx] = doc;
                
                // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù€ Monitor Ø¯Ø§Ø¦Ù…Ø§Ù‹
                renderMonitor();
                
                // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù€ Turn View Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ùˆ Ø§Ù„Ù…ØªØ­Ø¯Ø« Ø§Ù„Ø­Ø§Ù„ÙŠ
                if (currentSpeakerId === doc.$id && doc.transcript) {
                    document.getElementById('reveal-btn').classList.remove('hidden');
                    document.getElementById('speaker-text').innerText = `"${doc.transcript}"`;
                }
            });
        }
        init();

        // --- Render Functions ---

        function renderMonitor() {
            const container = document.getElementById('monitor-view');
            container.innerHTML = '';
            studentsData.forEach(s => {
                // ÙÙ„ØªØ±Ø©: Ø¨ÙŠÙ† ØºÙŠØ± Ø§Ù„Ù„ÙŠ Ù…ÙƒÙˆÙ†ÙŠÙƒØ·ÙŠÙ† + Ø§Ù„Ù„ÙŠ Ø­ØµÙ„ÙˆØ§ (cheated)
                if (s.status !== 'online' && !s.cheated) return;

                const card = document.createElement('div');
                card.className = `card ${s.cheated ? 'cheated' : ''} ${s.is_turn ? 'speaking' : ''}`;
                
                let html = `<h3>${s.name}</h3>`;
                if (s.cheated) html += `<h1 style="color:white;">Â¡TE VI!</h1>`;
                else html += `<p>Conectado</p>`;
                
                card.innerHTML = html;
                container.appendChild(card);
            });
        }

        // --- Logic: Turnos ---

        async function nextTurn() {
            // 1. Reset Ø§Ù„Ù‚Ø¯ÙŠÙ…
            if (currentSpeakerId) {
                await databases.updateDocument(CLIENT_CONFIG.databaseId, CLIENT_CONFIG.collectionId, currentSpeakerId, { is_turn: false });
            }
            
            // 2. Ø¥Ø®ÙØ§Ø¡ ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„ÙƒØ´Ù
            document.getElementById('active-turn-card').style.display = 'block';
            document.getElementById('reveal-btn').classList.add('hidden');
            const textBox = document.getElementById('speaker-text');
            textBox.innerText = "";
            textBox.className = "transcript-hidden";

            // 3. Ø§Ø®ØªÙŠØ§Ø± Ø¹Ø´ÙˆØ§Ø¦ÙŠ (ÙÙ‚Ø· Online ÙˆØºÙŠØ± ØºØ´Ø§Ø´ÙŠÙ†)
            const eligible = studentsData.filter(s => s.status === 'online' && !s.cheated);
            if (eligible.length === 0) { alert("No students available!"); return; }
            
            const lucky = eligible[Math.floor(Math.random() * eligible.length)];
            currentSpeakerId = lucky.$id;
            document.getElementById('speaker-name').innerText = lucky.name;

            // 4. ØªÙØ¹ÙŠÙ„ Ø§Ù„ØªÙ„Ù…ÙŠØ°
            await databases.updateDocument(CLIENT_CONFIG.databaseId, CLIENT_CONFIG.collectionId, lucky.$id, { 
                is_turn: true,
                transcript: "" 
            });
        }

        function revealText() {
            const textBox = document.getElementById('speaker-text');
            textBox.className = "transcript-revealed";
            // ØªØ´ØºÙŠÙ„ ØµÙˆØª "Ta-da!" Ø¥Ø°Ø§ Ø£Ù…ÙƒÙ†
        }

        // --- Logic: Groups Animation ---

        function startGroupingAnimation() {
            const canvas = document.getElementById('grouping-canvas');
            // ØªÙ†Ø¸ÙŠÙ
            document.querySelectorAll('.floating-name').forEach(e => e.remove());

            const activeStudents = studentsData.filter(s => s.status === 'online' || s.cheated); // Ø¨ØºÙŠÙ†Ø§ Ø­ØªÙ‰ Ø§Ù„Ù„ÙŠ Ø­ØµÙ„ÙˆØ§ ÙŠØ¯Ø®Ù„Ùˆ ÙØ§Ù„ÙƒØ±ÙˆØ¨Ø§Øª
            
            // 1. Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¹Ù†Ø§ØµØ± ÙÙŠ Ø§Ù„ÙˆØ³Ø· (Ø§Ù„ÙƒØªÙ„Ø©)
            activeStudents.forEach(s => {
                const el = document.createElement('div');
                el.className = 'floating-name';
                el.innerText = s.name;
                el.dataset.name = s.name;
                
                // Ù…ÙˆØ¶Ø¹ Ø¹Ø´ÙˆØ§Ø¦ÙŠ ÙÙŠ Ø§Ù„ÙˆØ³Ø·
                const centerX = canvas.clientWidth / 2 - 50 + (Math.random() * 100 - 50);
                const centerY = canvas.clientHeight / 2 - 20 + (Math.random() * 100 - 50);
                
                el.style.left = centerX + 'px';
                el.style.top = centerY + 'px';
                
                canvas.appendChild(el);
            });

            // 2. Ø§Ù„ØªØ­Ø±ÙŠÙƒ Ù†Ø­Ùˆ Ø§Ù„ØµÙ†Ø§Ø¯ÙŠÙ‚ Ø¨Ø¹Ø¯ Ù…Ù‡Ù„Ø© Ù‚ØµÙŠØ±Ø©
            setTimeout(() => {
                document.querySelectorAll('.floating-name').forEach(el => {
                    const name = el.dataset.name;
                    const groupNum = GROUPS[name] || 2; // Ø§ÙØªØ±Ø§Ø¶ÙŠ 2 Ø¥Ø°Ø§ Ù…Ø§Ù„Ù‚Ø§Ø´ Ø³Ù…ÙŠØªÙˆ
                    
                    // Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª Ø§Ù„ØµÙ†Ø§Ø¯ÙŠÙ‚ (ØªÙ‚Ø±ÙŠØ¨ÙŠØ© Ø¨Ø§Ù„Ù†Ø³Ø¨Ø© Ù„Ù„Ù€ canvas)
                    let targetX, targetY;
                    const jitterX = Math.random() * 150; // Ø¹Ø´ÙˆØ§Ø¦ÙŠØ© Ø¯Ø§Ø®Ù„ Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚
                    const jitterY = Math.random() * 200;

                    if (groupNum === 1) { targetX = 20 + jitterX; targetY = 60 + jitterY; } // ÙŠØ³Ø§Ø±
                    else if (groupNum === 2) { targetX = canvas.clientWidth * 0.35 + 20 + jitterX; targetY = 60 + jitterY; } // ÙˆØ³Ø·
                    else { targetX = canvas.clientWidth * 0.70 + 20 + jitterX; targetY = 60 + jitterY; } // ÙŠÙ…ÙŠÙ†

                    el.style.left = targetX + 'px';
                    el.style.top = targetY + 'px';
                    
                    // ØªØ£Ø«ÙŠØ± Ø§Ù„ØªÙƒØ¨ÙŠØ± Ø¹Ù†Ø¯ Ø§Ù„ÙˆØµÙˆÙ„
                    setTimeout(() => {
                        el.style.transform = "scale(1.2)";
                        setTimeout(() => el.style.transform = "scale(1)", 200);
                    }, 1500); // Ù†ÙØ³ Ù…Ø¯Ø© Ø§Ù„Ù€ transition ÙÙŠ CSS
                });
            }, 1000); // Ø§Ù†ØªØ¸Ø± Ø«Ø§Ù†ÙŠØ© Ù„ÙŠØ±Ù‰ Ø§Ù„Ø¬Ù…Ù‡ÙˆØ± "Ø§Ù„ÙƒØªÙ„Ø©"
        }

        // --- Helpers ---
        function switchMode(mode) {
            document.getElementById('monitor-view').classList.add('hidden');
            document.getElementById('turn-view').classList.add('hidden');
            document.getElementById('group-view').classList.add('hidden');
            
            if (mode === 'monitor') {
                document.getElementById('monitor-view').classList.remove('hidden');
                document.getElementById('mode-title').innerText = "MODO: MONITOR";
            } else if (mode === 'turn') {
                document.getElementById('turn-view').classList.remove('hidden');
                document.getElementById('mode-title').innerText = "MODO: TURNOS";
            } else if (mode === 'group') {
                document.getElementById('group-view').classList.remove('hidden');
                document.getElementById('grouping-canvas').style.display = 'block';
                document.getElementById('mode-title').innerText = "MODO: GRUPOS";
            }
        }

        async function resetAll() {
            if(confirm("Reset complete system?")) {
                studentsData.forEach(s => {
                    databases.updateDocument(CLIENT_CONFIG.databaseId, CLIENT_CONFIG.collectionId, s.$id, { 
                        status: 'offline', cheated: false, is_turn: false, transcript: ""
                    });
                });
                location.reload();
            }
        }
    </script>
</body>
</html>