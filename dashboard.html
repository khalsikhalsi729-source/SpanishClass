<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Panel de Profesor</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/appwrite@13.0.0"></script>
    <script src="config.js"></script>
    <style>
        .control-bar { display: flex; justify-content: space-between; background: #161b22; padding: 15px; border-bottom: 2px solid #30363d; flex-wrap: wrap; gap: 10px;}
        .mode-title { color: #58a6ff; font-weight: bold; font-size: 24px; text-transform: uppercase; }
        
        .current-turn-box {
            text-align: center; margin: 20px auto; padding: 30px; 
            border: 3px solid #58a6ff; border-radius: 15px; 
            background: #0d1117; width: 60%; box-shadow: 0 0 20px rgba(88, 166, 255, 0.2);
        }
        .active-speaker { font-size: 3.5em; color: #58a6ff; margin: 10px 0; font-weight: bold; }
        
        /* History Modal Design */
        #history-modal {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 80%; max-height: 80vh; background: #161b22; border: 2px solid #30363d;
            border-radius: 10px; padding: 20px; z-index: 1000; overflow-y: auto;
            box-shadow: 0 0 50px rgba(0,0,0,0.8); display: none;
        }
        .history-item {
            border-bottom: 1px solid #30363d; padding: 10px; display: flex; justify-content: space-between;
        }
        .history-item:last-child { border-bottom: none; }
        .close-modal {
            background: #da3633; color: white; border: none; padding: 5px 10px; 
            float: right; cursor: pointer; border-radius: 5px; margin-bottom: 10px;
        }
        
        /* Star Animation */
        .star-icon { font-size: 24px; color: gold; margin-right: 5px; animation: spin 2s infinite linear; display: inline-block;}
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div class="control-bar">
        <div class="mode-title" id="mode-title">MODO: MONITOR</div>
        <div>
            <button class="btn btn-action" onclick="switchMode('monitor')">ğŸ“Š MONITOR</button>
            <button class="btn btn-action" onclick="switchMode('turn')">ğŸ¤ TURNOS</button>
            <button class="btn btn-action" onclick="switchMode('group')">ğŸ§© GRUPOS</button>
            <button class="btn btn-action" style="background-color: #d29922;" onclick="toggleHistory()">ğŸ“œ HISTORIAL</button>
            <button class="btn btn-danger" onclick="resetAll()" style="width: auto;">ğŸ”„ REINICIAR</button>
        </div>
    </div>

    <div id="history-modal">
        <button class="close-modal" onclick="toggleHistory()">CERRAR (Ø¥ØºÙ„Ø§Ù‚)</button>
        <h2 style="color: #d29922; text-align: center;">HISTORIAL DE RESPUESTAS</h2>
        <div id="full-history-list">
            <p style="text-align: center; color: gray;">No hay registros aÃºn.</p>
        </div>
    </div>

    <div id="monitor-view" class="dashboard-grid grid" style="padding: 20px;"></div>

    <div id="turn-view" class="hidden">
        <div style="text-align: center; margin-top: 30px;">
            <button class="btn" onclick="nextTurn()" style="width: 300px; font-size: 24px; background: #1f6feb;">â¡ï¸ SIGUIENTE</button>
        </div>
        <div id="active-turn-card" class="current-turn-box hidden">
            <p style="color: gray; text-transform: uppercase; letter-spacing: 2px;">Hablando ahora</p>
            <div id="speaker-name" class="active-speaker">...</div>
            <button id="reveal-btn-current" class="btn btn-reveal hidden" onclick="revealCurrent()">ğŸ‘ï¸ MOSTRAR RESPUESTA</button>
            <div id="speaker-text-current" class="transcript-hidden" style="margin-top: 15px; font-size: 24px; min-height: 40px;"></div>
        </div>
    </div>

    <div id="group-view" class="hidden">
        <div style="text-align: center; padding: 10px;">
            <button class="btn btn-action" onclick="startGroupingAnimation()">â­ INICIAR DISTRIBUCIÃ“N</button>
        </div>
        <div id="grouping-canvas">
            <div class="group-box group-1"><h3 style="color: #d2a8ff;">GRUPO 1</h3></div>
            <div class="group-box group-2"><h3 style="color: #79c0ff;">GRUPO 2</h3></div>
            <div class="group-box group-3"><h3 style="color: #56d364;">GRUPO 3</h3></div>
        </div>
    </div>

    <script>
        // Ø§Ù„ØªÙˆØ²ÙŠØ¹ Ø§Ù„ØµØ­ÙŠØ­ Ù„Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª
        const GROUPS = {
            "Fatima zahra": 1, "Hamza": 1, "Othmane": 1, "Omar": 1,
            "Souhail": 2, "Zakariya": 2, "Marwa": 2, "Malak": 2,
            "Hiba": 3, "Aya G.": 3, "Aya B.": 3, "Aya Z.": 3
        };

        let studentsData = [];
        let currentSpeaker = null;
        
        // Ù…ØªØºÙŠØ±Ø§Øª Ù„Ù„ØªØ­ÙƒÙ… ÙÙŠ Ø§Ù„Ø¯ÙˆØ± (Logic)
        let playedStudentsIDs = new Set(); // Ù„ØªØªØ¨Ø¹ Ù…Ù† Ø´Ø§Ø±Ùƒ
        let lastGroupID = null; // Ù„ØªØªØ¨Ø¹ Ø¢Ø®Ø± Ù…Ø¬Ù…ÙˆØ¹Ø© Ø´Ø§Ø±ÙƒØª

        async function init() {
            const res = await databases.listDocuments(CLIENT_CONFIG.databaseId, CLIENT_CONFIG.collectionId);
            studentsData = res.documents;
            renderMonitor();

            client.subscribe(`databases.${CLIENT_CONFIG.databaseId}.collections.${CLIENT_CONFIG.collectionId}.documents`, response => {
                const doc = response.payload;
                const idx = studentsData.findIndex(s => s.$id === doc.$id);
                if (idx !== -1) studentsData[idx] = doc;
                renderMonitor();
                
                if (currentSpeaker && currentSpeaker.$id === doc.$id && doc.transcript) {
                    currentSpeaker.transcript = doc.transcript;
                    document.getElementById('reveal-btn-current').classList.remove('hidden');
                    document.getElementById('speaker-text-current').dataset.text = doc.transcript;
                    document.getElementById('speaker-text-current').innerText = "Respuesta recibida (oculta)";
                }
            });
        }
        init();

        function renderMonitor() {
            const container = document.getElementById('monitor-view');
            container.innerHTML = '';
            studentsData.forEach(s => {
                if (s.status !== 'online' && !s.cheated) return;
                const card = document.createElement('div');
                card.className = `card ${s.cheated ? 'cheated' : ''} ${s.is_turn ? 'speaking' : ''}`;
                let html = `<h3>${s.name}</h3>`;
                if (s.cheated) html += `<h1 style="color:white;">Â¡TE VI!</h1>`;
                else html += `<p>CONECTADO</p>`;
                card.innerHTML = html;
                container.appendChild(card);
            });
        }

        // --- Ø§Ù„Ù…Ù†Ø·Ù‚ Ø§Ù„Ø°ÙƒÙŠ Ù„Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¯ÙˆØ± ---
        async function nextTurn() {
            // 1. Ø£Ø±Ø´ÙØ© Ø§Ù„Ø³Ø§Ø¨Ù‚
            if (currentSpeaker) {
                databases.updateDocument(CLIENT_CONFIG.databaseId, CLIENT_CONFIG.collectionId, currentSpeaker.$id, { is_turn: false });
                addToHistoryLog(currentSpeaker);
            }
            
            // ØªÙ†Ø¸ÙŠÙ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
            document.getElementById('active-turn-card').classList.remove('hidden');
            document.getElementById('reveal-btn-current').classList.add('hidden');
            const textBox = document.getElementById('speaker-text-current');
            textBox.innerText = "";
            textBox.className = "transcript-hidden";
            textBox.dataset.text = "";

            // 2. ØªØµÙÙŠØ© Ø§Ù„Ù…Ø±Ø´Ø­ÙŠÙ†
            // Ø§Ù„Ø´Ø±Ø·: Ø£ÙˆÙ†Ù„Ø§ÙŠÙ† + Ù…Ø§Ø´ÙŠ ØºØ´Ø§Ø´ + Ù…Ø§Ø²Ø§Ù„ Ù…Ø§ Ù„Ø¹Ø¨Ø´
            let candidates = studentsData.filter(s => 
                s.status === 'online' && 
                !s.cheated && 
                !playedStudentsIDs.has(s.$id)
            );

            // Ø¥Ø°Ø§ ÙƒÙ„Ø´ÙŠ Ù„Ø¹Ø¨ØŒ Ù†Ø¹Ø§ÙˆØ¯Ùˆ Ø§Ù„Ø³ÙŠÙƒÙ„
            if (candidates.length === 0) {
                alert("Â¡Todos han participado! Reiniciando el ciclo...");
                playedStudentsIDs.clear();
                // Ù†Ø¹Ø§ÙˆØ¯Ùˆ Ù†Ø¹Ù…Ø±ÙˆØ§ Ø§Ù„Ù…Ø±Ø´Ø­ÙŠÙ†
                candidates = studentsData.filter(s => s.status === 'online' && !s.cheated);
            }

            if (candidates.length === 0) { alert("No hay estudiantes conectados."); return; }

            // 3. ØªØ¬Ù†Ø¨ Ù†ÙØ³ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© (Anti-Same Group Logic)
            let preferredCandidates = candidates.filter(s => {
                const sGroup = GROUPS[s.name];
                return sGroup !== lastGroupID;
            });

            // Ø¥Ø°Ø§ Ø¨Ù‚Ø§Ùˆ ØºÙŠØ± Ù…Ù† Ù†ÙØ³ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©ØŒ Ø¨Ø²Ø² Ù…Ù†Ø§ Ù†Ø®ØªØ§Ø±Ùˆ Ù…Ù†Ù‡Ù…ØŒ ÙˆØ¥Ù„Ø§ Ù†Ø®ØªØ§Ø±Ùˆ Ù…Ù† Ø§Ù„Ù…ÙØ¶Ù„ÙŠÙ†
            let finalPool = preferredCandidates.length > 0 ? preferredCandidates : candidates;

            // Ø§Ø®ØªÙŠØ§Ø± Ø¹Ø´ÙˆØ§Ø¦ÙŠ
            const lucky = finalPool[Math.floor(Math.random() * finalPool.length)];
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø©
            currentSpeaker = lucky;
            playedStudentsIDs.add(lucky.$id);
            lastGroupID = GROUPS[lucky.name];

            document.getElementById('speaker-name').innerText = lucky.name;
            await databases.updateDocument(CLIENT_CONFIG.databaseId, CLIENT_CONFIG.collectionId, lucky.$id, { is_turn: true, transcript: "" });
        }

        function revealCurrent() {
            const textBox = document.getElementById('speaker-text-current');
            const text = textBox.dataset.text || "";
            textBox.innerText = `"${text}"`;
            textBox.className = "transcript-revealed";
        }

        // --- Ù…Ù†Ø·Ù‚ Ø§Ù„Ù‡ÙŠØ³ØªÙˆØ±ÙŠ Ø§Ù„Ø¬Ø¯ÙŠØ¯ ---
        let historyLog = []; // Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ø³Ø¬Ù„ Ù…Ø­Ù„ÙŠØ§Ù‹

        function addToHistoryLog(student) {
            const text = document.getElementById('speaker-text-current').dataset.text || student.transcript || "(Sin respuesta)";
            const entry = { name: student.name, text: text, time: new Date().toLocaleTimeString() };
            historyLog.unshift(entry); // Ø¥Ø¶Ø§ÙØ© ÙÙŠ Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©
            renderHistoryLog();
        }

        function renderHistoryLog() {
            const list = document.getElementById('full-history-list');
            list.innerHTML = "";
            if (historyLog.length === 0) {
                list.innerHTML = '<p style="text-align: center; color: gray;">No hay registros aÃºn.</p>';
                return;
            }
            historyLog.forEach(item => {
                const div = document.createElement('div');
                div.className = 'history-item';
                div.innerHTML = `
                    <span style="color: #58a6ff; font-weight: bold;">${item.name}</span>
                    <span style="color: #c9d1d9;">"${item.text}"</span>
                `;
                list.appendChild(div);
            });
        }

        function toggleHistory() {
            const modal = document.getElementById('history-modal');
            if (modal.style.display === 'block') modal.style.display = 'none';
            else {
                renderHistoryLog(); // ØªØ­Ø¯ÙŠØ« Ù‚Ø¨Ù„ Ø§Ù„ÙØªØ­
                modal.style.display = 'block';
            }
        }

        // --- Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª ---
        function startGroupingAnimation() {
            const canvas = document.getElementById('grouping-canvas');
            document.querySelectorAll('.floating-name').forEach(e => e.remove());
            const activeStudents = studentsData.filter(s => s.status === 'online' || s.cheated);
            
            activeStudents.forEach(s => {
                const el = document.createElement('div');
                el.className = 'floating-name';
                el.innerHTML = `<div class="star-icon">â­</div> ${s.name}`;
                el.dataset.name = s.name;
                const centerX = canvas.clientWidth / 2 - 60 + (Math.random() * 100 - 50);
                const centerY = canvas.clientHeight / 2 - 30 + (Math.random() * 100 - 50);
                el.style.left = centerX + 'px';
                el.style.top = centerY + 'px';
                el.style.display = 'flex'; el.style.alignItems = 'center';
                canvas.appendChild(el);
            });

            setTimeout(() => {
                document.querySelectorAll('.floating-name').forEach(el => {
                    const name = el.dataset.name;
                    const groupNum = GROUPS[name] || 2;
                    let targetX, targetY;
                    const jitterX = Math.random() * 120; const jitterY = Math.random() * 150;
                    if (groupNum === 1) { targetX = 30 + jitterX; targetY = 70 + jitterY; }
                    else if (groupNum === 2) { targetX = canvas.clientWidth * 0.35 + 30 + jitterX; targetY = 70 + jitterY; }
                    else { targetX = canvas.clientWidth * 0.70 + 30 + jitterX; targetY = 70 + jitterY; }
                    el.style.left = targetX + 'px'; el.style.top = targetY + 'px';
                    setTimeout(() => { el.style.transform = "scale(1.1)"; setTimeout(() => el.style.transform = "scale(1)", 200); }, 1500);
                });
            }, 1000);
        }

        function switchMode(mode) {
            document.getElementById('monitor-view').classList.add('hidden');
            document.getElementById('turn-view').classList.add('hidden');
            document.getElementById('group-view').classList.add('hidden');
            if (mode === 'monitor') {
                document.getElementById('monitor-view').classList.remove('hidden');
                document.getElementById('mode-title').innerText = "MODO: MONITOR";
            } else if (mode === 'turn') {
                document.getElementById('turn-view').classList.remove('hidden');
                document.getElementById('mode-title').innerText = "MODO: TURNOS";
            } else if (mode === 'group') {
                document.getElementById('group-view').classList.remove('hidden');
                document.getElementById('grouping-canvas').style.display = 'block';
                document.getElementById('mode-title').innerText = "MODO: GRUPOS";
            }
        }

        async function resetAll() {
            if(confirm("Â¿Reiniciar todo el sistema?")) {
                studentsData.forEach(s => {
                    databases.updateDocument(CLIENT_CONFIG.databaseId, CLIENT_CONFIG.collectionId, s.$id, { status: 'offline', cheated: false, is_turn: false, transcript: "" });
                });
                location.reload();
            }
        }
    </script>
</body>
</html>