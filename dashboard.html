<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Panel de Profesor</title>
<link rel="stylesheet" href="style.css">
<script src="https://cdn.jsdelivr.net/npm/appwrite@13.0.0"></script>
<script src="config.js"></script>
<style>
.control-bar { display: flex; justify-content: space-between; background: #161b22; padding: 15px; border-bottom: 2px solid #30363d; }
.mode-title { color: #58a6ff; font-weight: bold; font-size: 24px; text-transform: uppercase; }
.current-turn-box {
text-align: center; margin: 20px auto; padding: 30px;
border: 3px solid #58a6ff; border-radius: 15px;
background: #0d1117; width: 60%; box-shadow: 0 0 20px rgba(88, 166, 255, 0.2);
}
.active-speaker { font-size: 3.5em; color: #58a6ff; margin: 10px 0; font-weight: bold; }

/* Casino Spinner Animation */
.spinner-container { margin: 20px 0; min-height: 100px; }
.spinner-name {
font-size: 3em; color: #ffd700; font-weight: bold;
animation: spin-flash 0.1s infinite;
}
@keyframes spin-flash {
0%, 100% { opacity: 1; transform: scale(1); }
50% { opacity: 0.7; transform: scale(1.1); }
}

/* Group Distribution Styles */
#grouping-canvas {
position: relative; height: 80vh; width: 100%; margin-top: 20px;
background: #0d1117; border-radius: 10px; overflow: hidden;
}
.group-container {
position: absolute; width: 30%; height: 90%; 
border: 3px solid; border-radius: 15px; padding: 20px;
background: rgba(22, 27, 34, 0.9); overflow: hidden;
display: flex; flex-direction: column;
}
.group-container.group-1 { left: 2%; top: 5%; border-color: #d2a8ff; }
.group-container.group-2 { left: 35%; top: 5%; border-color: #79c0ff; }
.group-container.group-3 { right: 2%; top: 5%; border-color: #56d364; }

.group-header {
font-size: 28px; font-weight: bold; text-align: center;
padding: 15px; margin-bottom: 20px; border-radius: 10px;
}
.group-1 .group-header { color: #d2a8ff; background: rgba(210, 168, 255, 0.1); }
.group-2 .group-header { color: #79c0ff; background: rgba(121, 192, 255, 0.1); }
.group-3 .group-header { color: #56d364; background: rgba(86, 211, 100, 0.1); }

.names-area {
flex: 1; display: flex; flex-direction: column; gap: 10px;
align-items: center; justify-content: center;
}

.floating-name {
position: absolute; padding: 12px 24px;
background: linear-gradient(145deg, #238636, #2ea043);
color: white; border-radius: 20px; font-weight: bold;
font-size: 18px; box-shadow: 0 4px 15px rgba(35, 134, 54, 0.4);
transition: all 2s cubic-bezier(0.25, 1, 0.5, 1);
z-index: 10; display: flex; align-items: center; gap: 8px;
}
.star-icon { font-size: 24px; animation: rotate 2s linear infinite; }
@keyframes rotate { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

.static-name {
padding: 10px 20px; background: rgba(35, 134, 54, 0.3);
border: 2px solid #238636; border-radius: 10px;
color: #c9d1d9; font-size: 18px; font-weight: bold;
width: 80%; text-align: center;
}
</style>
</head>
<body>

<div class="control-bar">
<div class="mode-title" id="mode-title">MODO: MONITOR</div>
<div>
<button class="btn btn-action" onclick="switchMode('monitor')">üìä MONITOR</button>
<button class="btn btn-action" onclick="switchMode('turn')">üé§ TURNOS</button>
<button class="btn btn-action" onclick="switchMode('group')">üß© GRUPOS</button>
<button class="btn btn-action" onclick="switchMode('history')">üìú HISTORIAL</button>
<button class="btn btn-danger" onclick="resetAll()" style="width: auto;">üîÑ REINICIAR</button>
</div>
</div>

<div id="monitor-view" class="dashboard-grid grid" style="padding: 20px;"></div>

<div id="turn-view" class="hidden">
<div style="text-align: center; margin-top: 30px;">
<button class="btn" onclick="nextTurn()" style="width: 300px; font-size: 24px; background: #1f6feb;">‚û°Ô∏è SIGUIENTE</button>
</div>
<div id="active-turn-card" class="current-turn-box hidden">
<p style="color: gray; text-transform: uppercase; letter-spacing: 2px;">Hablando ahora</p>
<div id="spinner-container" class="spinner-container hidden"></div>
<div id="speaker-name" class="active-speaker hidden">...</div>
</div>
</div>

<div id="group-view" class="hidden">
<div style="text-align: center; padding: 10px;">
<button class="btn btn-action" onclick="startGroupingAnimation()">‚≠ê INICIAR DISTRIBUCI√ìN</button>
</div>
<div id="grouping-canvas">
<div class="group-container group-1">
<div class="group-header">GRUPO 1</div>
<div class="names-area" id="group1-names"></div>
</div>
<div class="group-container group-2">
<div class="group-header">GRUPO 2</div>
<div class="names-area" id="group2-names"></div>
</div>
<div class="group-container group-3">
<div class="group-header">GRUPO 3</div>
<div class="names-area" id="group3-names"></div>
</div>
</div>
</div>

<div id="history-view" class="hidden" style="padding: 30px; max-width: 900px; margin: 0 auto;">
<h2 style="color: #58a6ff; margin-bottom: 30px;">üìú Historial de Respuestas</h2>
<div id="history-list"></div>
</div>

<script>
const GROUPS = {
"Fatima zahra": 1, "Hamza": 1, "Othmane": 1, "Omar": 1,
"Souhail": 2, "Zakariya": 2, "Marwa": 2, "Malak": 2,
"Hiba": 3, "Aya G.": 3, "Aya B.": 3, "Aya Z.": 3
};

let studentsData = [];
let currentSpeaker = null;
let usedStudents = [];
let lastGroup = null;
let historyData = [];

async function init() {
const res = await databases.listDocuments(CLIENT_CONFIG.databaseId, CLIENT_CONFIG.collectionId);
studentsData = res.documents;
renderMonitor();

client.subscribe(`databases.${CLIENT_CONFIG.databaseId}.collections.${CLIENT_CONFIG.collectionId}.documents`, response => {
const doc = response.payload;
const idx = studentsData.findIndex(s => s.$id === doc.$id);
if (idx !== -1) studentsData[idx] = doc;
renderMonitor();

if (currentSpeaker && currentSpeaker.$id === doc.$id && doc.transcript) {
currentSpeaker.transcript = doc.transcript;
stopSpinnerAndShow(currentSpeaker);
}
});
}
init();

function renderMonitor() {
const container = document.getElementById('monitor-view');
container.innerHTML = '';
studentsData.forEach(s => {
if (s.status !== 'online') return;
const card = document.createElement('div');
card.className = `card ${s.is_turn ? 'speaking' : ''}`;
card.innerHTML = `<h3>${s.name}</h3><p>CONECTADO</p>`;
container.appendChild(card);
});
}

async function nextTurn() {
if (currentSpeaker) {
await databases.updateDocument(CLIENT_CONFIG.databaseId, CLIENT_CONFIG.collectionId, currentSpeaker.$id, { is_turn: false });
}

document.getElementById('active-turn-card').classList.remove('hidden');
document.getElementById('speaker-name').classList.add('hidden');
document.getElementById('spinner-container').classList.remove('hidden');

const eligible = studentsData.filter(s => 
s.status === 'online' && 
!usedStudents.includes(s.$id) &&
GROUPS[s.name] !== lastGroup
);

if (eligible.length === 0) {
if (usedStudents.length === studentsData.filter(s => s.status === 'online').length) {
usedStudents = [];
lastGroup = null;
return nextTurn();
}
lastGroup = null;
return nextTurn();
}

startCasinoEffect(eligible);
}

function startCasinoEffect(candidates) {
const spinner = document.getElementById('spinner-container');
spinner.innerHTML = '<div class="spinner-name" id="spinner-text">...</div>';
const spinnerText = document.getElementById('spinner-text');

let spinCount = 0;
const spinInterval = setInterval(() => {
const randomStudent = candidates[Math.floor(Math.random() * candidates.length)];
spinnerText.innerText = randomStudent.name;
spinCount++;

if (spinCount > 20) {
clearInterval(spinInterval);
selectFinalStudent(candidates);
}
}, 100);
}

async function selectFinalStudent(candidates) {
const lucky = candidates[Math.floor(Math.random() * candidates.length)];
currentSpeaker = lucky;
usedStudents.push(lucky.$id);
lastGroup = GROUPS[lucky.name];

document.getElementById('spinner-text').innerText = lucky.name;

await databases.updateDocument(CLIENT_CONFIG.databaseId, CLIENT_CONFIG.collectionId, lucky.$id, { 
is_turn: true, 
transcript: "" 
});
}

function stopSpinnerAndShow(student) {
document.getElementById('spinner-container').classList.add('hidden');
const speakerName = document.getElementById('speaker-name');
speakerName.innerText = student.name;
speakerName.classList.remove('hidden');

historyData.push({
name: student.name,
text: student.transcript,
time: new Date().toLocaleString('es-ES')
});

renderHistory();
}

function renderHistory() {
const list = document.getElementById('history-list');
list.innerHTML = '';
historyData.reverse().forEach(item => {
const card = document.createElement('div');
card.className = 'card';
card.style.marginBottom = '15px';
card.innerHTML = `
<h3 style="color: #58a6ff; margin-bottom: 10px;">${item.name}</h3>
<p style="font-size: 18px; color: #e3b341; margin: 10px 0;">"${item.text}"</p>
<p style="font-size: 12px; color: #8b949e; margin-top: 10px;">${item.time}</p>
`;
list.appendChild(card);
});
}

function startGroupingAnimation() {
const canvas = document.getElementById('grouping-canvas');
document.querySelectorAll('.floating-name').forEach(e => e.remove());
document.querySelectorAll('.static-name').forEach(e => e.remove());

const activeStudents = studentsData.filter(s => s.status === 'online');

activeStudents.forEach(s => {
const el = document.createElement('div');
el.className = 'floating-name';
el.innerHTML = `<div class="star-icon">‚≠ê</div> ${s.name}`;
el.dataset.name = s.name;
const centerX = canvas.clientWidth / 2 - 60;
const centerY = canvas.clientHeight / 2 - 20;
el.style.left = centerX + 'px';
el.style.top = centerY + 'px';
canvas.appendChild(el);
});

setTimeout(() => {
document.querySelectorAll('.floating-name').forEach(el => {
const name = el.dataset.name;
const groupNum = GROUPS[name] || 2;
let targetX, targetY;

if (groupNum === 1) {
targetX = canvas.clientWidth * 0.16 - 60;
targetY = canvas.clientHeight * 0.5 - 20;
} else if (groupNum === 2) {
targetX = canvas.clientWidth * 0.50 - 60;
targetY = canvas.clientHeight * 0.5 - 20;
} else {
targetX = canvas.clientWidth * 0.84 - 60;
targetY = canvas.clientHeight * 0.5 - 20;
}

el.style.left = targetX + 'px';
el.style.top = targetY + 'px';
});

setTimeout(() => {
document.querySelectorAll('.floating-name').forEach(el => {
el.style.opacity = '0';
});

setTimeout(() => {
document.querySelectorAll('.floating-name').forEach(el => el.remove());
showStaticNames();
}, 500);
}, 2000);
}, 1000);
}

function showStaticNames() {
const group1 = document.getElementById('group1-names');
const group2 = document.getElementById('group2-names');
const group3 = document.getElementById('group3-names');

group1.innerHTML = '';
group2.innerHTML = '';
group3.innerHTML = '';

studentsData.filter(s => s.status === 'online').forEach(s => {
const groupNum = GROUPS[s.name] || 2;
const nameDiv = document.createElement('div');
nameDiv.className = 'static-name';
nameDiv.innerText = s.name;

if (groupNum === 1) group1.appendChild(nameDiv);
else if (groupNum === 2) group2.appendChild(nameDiv);
else group3.appendChild(nameDiv);
});
}

function switchMode(mode) {
document.getElementById('monitor-view').classList.add('hidden');
document.getElementById('turn-view').classList.add('hidden');
document.getElementById('group-view').classList.add('hidden');
document.getElementById('history-view').classList.add('hidden');

if (mode === 'monitor') {
document.getElementById('monitor-view').classList.remove('hidden');
document.getElementById('mode-title').innerText = "MODO: MONITOR";
} else if (mode === 'turn') {
document.getElementById('turn-view').classList.remove('hidden');
document.getElementById('mode-title').innerText = "MODO: TURNOS";
} else if (mode === 'group') {
document.getElementById('group-view').classList.remove('hidden');
document.getElementById('mode-title').innerText = "MODO: GRUPOS";
} else if (mode === 'history') {
document.getElementById('history-view').classList.remove('hidden');
document.getElementById('mode-title').innerText = "MODO: HISTORIAL";
renderHistory();
}
}

async function resetAll() {
if(confirm("¬øReiniciar todo el sistema?")) {
studentsData.forEach(s => {
databases.updateDocument(CLIENT_CONFIG.databaseId, CLIENT_CONFIG.collectionId, s.$id, { 
status: 'offline', 
is_turn: false, 
transcript: "" 
});
});
usedStudents = [];
lastGroup = null;
historyData = [];
location.reload();
}
}
</script>
</body>
</html>