<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Panel de Profesor</title>
<link rel="stylesheet" href="style.css">
<script src="https://cdn.jsdelivr.net/npm/appwrite@13.0.0"></script>
<script src="config.js"></script>
<style>
    /* --- 1. CONTROL BAR (NEW LAYOUT) --- */
    body { margin: 0; padding: 0; background: #0d1117; font-family: 'Courier New', monospace; overflow-x: hidden; }
    
    .navbar {
        display: flex; align-items: center; justify-content: space-between;
        background: #161b22; padding: 15px 30px; border-bottom: 2px solid #30363d;
        position: sticky; top: 0; z-index: 1000; box-shadow: 0 4px 10px rgba(0,0,0,0.5);
    }
    
    .nav-brand { color: #58a6ff; font-weight: bold; font-size: 24px; text-transform: uppercase; letter-spacing: 2px; }
    
    .nav-menu { display: flex; gap: 10px; }
    
    .nav-btn {
        background: #21262d; color: #c9d1d9; border: 1px solid #30363d;
        padding: 10px 20px; font-size: 16px; cursor: pointer; border-radius: 6px;
        transition: all 0.2s; font-weight: bold;
    }
    .nav-btn:hover { background: #30363d; color: white; }
    .nav-btn.active { background: #1f6feb; color: white; border-color: #1f6feb; }
    .nav-btn-history { border-color: #e3b341; color: #e3b341; }
    .nav-btn-history.active { background: #e3b341; color: black; }
    
    .btn-reset { background: #da3633; color: white; border: none; font-weight: bold; }
    .btn-reset:hover { background: #b62324; }

    /* --- COMMON VIEW STYLES --- */
    .view-section { padding: 40px; display: none; animation: fadeIn 0.3s; }
    .view-section.active { display: block; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    /* --- TURN VIEW --- */
    .turn-container { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 70vh; }
    .active-speaker-box { 
        border: 4px solid #58a6ff; background: #0d1117; padding: 40px; 
        border-radius: 20px; text-align: center; min-width: 60%; 
        box-shadow: 0 0 30px rgba(88, 166, 255, 0.2);
    }
    .speaker-name { font-size: 4em; color: white; margin: 20px 0; font-weight: bold; text-shadow: 0 0 10px #58a6ff; }
    .transcript-box { font-size: 2em; color: #e3b341; margin-top: 20px; min-height: 50px; }

    /* --- GROUPS VIEW --- */
    .groups-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 30px; height: 75vh; }
    .group-col { 
        background: #161b22; border: 2px solid; border-radius: 12px; 
        display: flex; flex-direction: column; overflow: hidden;
    }
    .group-header { 
        padding: 15px; text-align: center; font-size: 1.5em; font-weight: bold; 
        background: rgba(255,255,255,0.05); text-transform: uppercase; letter-spacing: 2px;
    }
    .group-body { padding: 15px; overflow-y: auto; flex-grow: 1; }
    
    .student-item { 
        background: #21262d; margin-bottom: 10px; padding: 15px; 
        border-radius: 8px; font-size: 1.2em; display: flex; 
        justify-content: space-between; align-items: center; border-left: 5px solid transparent;
    }
    .status-dot { width: 12px; height: 12px; border-radius: 50%; }
    .online { background: #238636; box-shadow: 0 0 10px #238636; }
    .offline { background: #484f58; }

    /* --- HISTORY VIEW (PAGE) --- */
    .history-container { max-width: 800px; margin: 0 auto; }
    .history-card { 
        background: #161b22; border-left: 4px solid #e3b341; 
        margin-bottom: 15px; padding: 20px; border-radius: 0 8px 8px 0;
        display: flex; flex-direction: column; gap: 10px;
    }
    .h-name { font-size: 1.4em; color: #e3b341; font-weight: bold; }
    .h-text { font-size: 1.2em; color: #c9d1d9; font-style: italic; }

    /* --- MONITOR GRID --- */
    .monitor-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 20px; }
    .monitor-card { background: #161b22; padding: 20px; border-radius: 10px; text-align: center; border: 1px solid #30363d; }
    .monitor-card.speaking { border-color: #58a6ff; box-shadow: 0 0 15px rgba(88, 166, 255, 0.3); }

    .hidden { display: none; }
</style>
</head>
<body>

<nav class="navbar">
    <div class="nav-brand" id="page-title">MONITOR</div>
    <div class="nav-menu">
        <button class="nav-btn active" onclick="switchMode('monitor')" id="btn-monitor">üìä MONITOR</button>
        <button class="nav-btn" onclick="switchMode('turn')" id="btn-turn">üé∞ RULETA</button>
        <button class="nav-btn" onclick="switchMode('group')" id="btn-group">üß© GRUPOS</button>
        <button class="nav-btn nav-btn-history" onclick="switchMode('history')" id="btn-history">üìú HISTORIAL</button>
        <button class="nav-btn btn-reset" onclick="resetAll()">üîÑ RESET</button>
    </div>
</nav>

<div id="view-monitor" class="view-section active">
    <div id="monitor-grid" class="monitor-grid"></div>
</div>

<div id="view-turn" class="view-section">
    <div class="turn-container">
        <button id="spin-btn" class="nav-btn" style="background: #1f6feb; font-size: 1.5em; padding: 20px 50px; margin-bottom: 30px;" onclick="startRoulette()">
            üé≤ GIRAR RULETA
        </button>

        <div id="active-card" class="active-speaker-box hidden">
            <div style="color: #8b949e; letter-spacing: 3px;">HABLANDO AHORA</div>
            <div id="speaker-name" class="speaker-name">...</div>
            <div id="loading-msg" class="hidden" style="color: #e3b341; font-size: 1.2em;">‚è≥ Esperando audio...</div>
            <div id="transcript-text" class="transcript-box"></div>
        </div>
    </div>
</div>

<div id="view-group" class="view-section">
    <div class="groups-grid">
        <div class="group-col" style="border-color: #d2a8ff;">
            <div class="group-header" style="color: #d2a8ff;">GRUPO 1</div>
            <div class="group-body" id="list-g1"></div>
        </div>
        <div class="group-col" style="border-color: #79c0ff;">
            <div class="group-header" style="color: #79c0ff;">GRUPO 2</div>
            <div class="group-body" id="list-g2"></div>
        </div>
        <div class="group-col" style="border-color: #56d364;">
            <div class="group-header" style="color: #56d364;">GRUPO 3</div>
            <div class="group-body" id="list-g3"></div>
        </div>
    </div>
</div>

<div id="view-history" class="view-section">
    <h2 style="text-align: center; color: #e3b341; margin-bottom: 30px;">üìú HISTORIAL DE RESPUESTAS</h2>
    <div id="history-list" class="history-container">
        <p style="text-align: center; color: #8b949e;">No hay respuestas registradas.</p>
    </div>
</div>

<script>
// --- CONFIGURATION ---
const GROUPS = {
    "Fatima zahra": 1, "Hamza": 1, "Othmane": 1, "Omar": 1,
    "Souhail": 2, "Zakariya": 2, "Marwa": 2, "Malak": 2,
    "Hiba": 3, "Aya G.": 3, "Aya B.": 3, "Aya Z.": 3
};

let studentsData = [];
let currentSpeaker = null;
let lastGroupPlayed = null;
let playedStudents = [];

// --- INITIALIZATION ---
async function init() {
    // Load initial data
    const res = await databases.listDocuments(CLIENT_CONFIG.databaseId, CLIENT_CONFIG.collectionId);
    studentsData = res.documents;
    
    refreshAllViews();

    // Subscribe to realtime updates
    client.subscribe(`databases.${CLIENT_CONFIG.databaseId}.collections.${CLIENT_CONFIG.collectionId}.documents`, response => {
        const doc = response.payload;
        const idx = studentsData.findIndex(s => s.$id === doc.$id);
        if (idx !== -1) studentsData[idx] = doc;

        // If transcript received
        if (currentSpeaker && currentSpeaker.$id === doc.$id && doc.transcript) {
            document.getElementById('loading-msg').classList.add('hidden');
            document.getElementById('transcript-text').innerText = `"${doc.transcript}"`;
            addToHistoryLocal(doc); // Add to local history list immediately
        }

        refreshAllViews();
    });
}
init();

// --- VIEW CONTROLLER ---
function switchMode(mode) {
    // Hide all views
    document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
    document.querySelectorAll('.nav-btn').forEach(el => el.classList.remove('active'));

    // Show selected view
    document.getElementById(`view-${mode}`).classList.add('active');
    document.getElementById(`btn-${mode}`).classList.add('active');

    // Update Title
    const titles = { 'monitor': 'MONITOR', 'turn': 'RULETA', 'group': 'GRUPOS', 'history': 'HISTORIAL' };
    document.getElementById('page-title').innerText = titles[mode];
}

// --- RENDER FUNCTIONS ---
function refreshAllViews() {
    renderMonitor();
    renderGroups();
    renderHistoryPage();
}

function renderMonitor() {
    const grid = document.getElementById('monitor-grid');
    grid.innerHTML = '';
    studentsData.forEach(s => {
        if (s.status !== 'online') return;
        const card = document.createElement('div');
        card.className = `monitor-card ${s.is_turn ? 'speaking' : ''}`;
        card.innerHTML = `<h2 style="color: white;">${s.name}</h2><p style="color: #238636;">CONECTADO</p>`;
        grid.appendChild(card);
    });
}

function renderGroups() {
    // Clear lists
    ['1', '2', '3'].forEach(n => document.getElementById(`list-g${n}`).innerHTML = '');

    studentsData.forEach(s => {
        const gID = GROUPS[s.name] || 1;
        const el = document.createElement('div');
        el.className = 'student-item';
        
        // Status dot logic
        const statusClass = s.status === 'online' ? 'online' : 'offline';
        const statusColor = s.status === 'online' ? '#fff' : '#8b949e';
        
        // Is speaking border
        if(s.is_turn) el.style.borderLeftColor = "#58a6ff";

        el.innerHTML = `
            <span style="color: ${statusColor}; font-weight: bold;">${s.name}</span>
            <div class="status-dot ${statusClass}"></div>
        `;
        document.getElementById(`list-g${gID}`).appendChild(el);
    });
}

function renderHistoryPage() {
    const list = document.getElementById('history-list');
    // Filter students who have spoken text
    const spoken = studentsData.filter(s => s.transcript && s.transcript.length > 0);
    
    if(spoken.length === 0) return; // Keep "No hay respuestas" if empty

    list.innerHTML = '';
    // Reverse to show newest first (optional, standard is list order)
    spoken.forEach(s => {
        const card = document.createElement('div');
        card.className = 'history-card';
        card.innerHTML = `
            <div class="h-name">${s.name}</div>
            <div class="h-text">"${s.transcript}"</div>
        `;
        list.prepend(card); // Add to top
    });
}

// Helper to update History immediately without waiting for refresh
function addToHistoryLocal(doc) {
    renderHistoryPage();
}

// --- LOGIC: ROULETTE ---
function startRoulette() {
    if (currentSpeaker) {
        databases.updateDocument(CLIENT_CONFIG.databaseId, CLIENT_CONFIG.collectionId, currentSpeaker.$id, { is_turn: false });
    }

    // Reset UI
    document.getElementById('active-card').classList.remove('hidden');
    document.getElementById('loading-msg').classList.add('hidden');
    document.getElementById('transcript-text').innerText = "";
    document.getElementById('spin-btn').disabled = true;

    // Filter Logic
    let eligible = studentsData.filter(s => s.status === 'online');
    let pool = eligible.filter(s => !playedStudents.includes(s.$id));
    if (pool.length === 0) { playedStudents = []; pool = eligible; } // Reset Cycle

    if (pool.length === 0) { alert("Nadie conectado"); document.getElementById('spin-btn').disabled = false; return; }

    // Group Logic
    let candidates = pool.filter(s => GROUPS[s.name] !== lastGroupPlayed);
    if (candidates.length === 0) candidates = pool;

    const winner = candidates[Math.floor(Math.random() * candidates.length)];

    // Animation
    const nameDisplay = document.getElementById('speaker-name');
    let count = 0;
    const interval = setInterval(() => {
        nameDisplay.innerText = eligible[Math.floor(Math.random() * eligible.length)].name;
        count++;
        if (count > 15) {
            clearInterval(interval);
            setTurn(winner);
        }
    }, 80);
}

async function setTurn(student) {
    document.getElementById('speaker-name').innerText = student.name;
    document.getElementById('spin-btn').disabled = false;
    document.getElementById('loading-msg').classList.remove('hidden');
    
    currentSpeaker = student;
    lastGroupPlayed = GROUPS[student.name];
    playedStudents.push(student.$id);

    await databases.updateDocument(CLIENT_CONFIG.databaseId, CLIENT_CONFIG.collectionId, student.$id, { is_turn: true, transcript: "" });
}

// --- LOGIC: RESET ---
async function resetAll() {
    if(confirm("¬øReiniciar todo?")) {
        studentsData.forEach(s => {
            databases.updateDocument(CLIENT_CONFIG.databaseId, CLIENT_CONFIG.collectionId, s.$id, { 
                status: 'offline', is_turn: false, transcript: "" 
            });
        });
        location.reload();
    }
}
</script>
</body>
</html>