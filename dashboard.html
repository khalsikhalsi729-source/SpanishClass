<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Panel de Control</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/appwrite@13.0.0"></script>
    <script src="config.js"></script>
    <style>
        .history-badge-alert {
            position: absolute; top: -5px; right: -5px;
            background: red; color: white; border-radius: 50%;
            width: 20px; height: 20px; font-size: 12px;
            display: flex; align-items: center; justify-content: center;
            animation: pulse 1s infinite;
        }
    </style>
</head>
<body>

    <div style="background: #161b22; padding: 15px; border-bottom: 1px solid #30363d; display: flex; justify-content: space-between; align-items: center;">
        <h2 id="mode-title" style="margin: 0; color: #58a6ff;">MODO: RULETA</h2>
        <div style="display: flex; gap: 10px; align-items: center;">
            <button class="btn btn-blue" onclick="switchMode('turn')">üé∞ RULETA</button>
            <button class="btn btn-gold" onclick="switchMode('group')">üß© GRUPOS</button>
            
            <div style="position: relative;">
                <button class="btn" style="background-color: #d29922; border: 2px solid #fff;" onclick="toggleHistory()">
                    üìú HISTORIAL
                </button>
                <div id="history-alert" class="history-badge-alert hidden">!</div>
            </div>

            <button class="btn btn-danger" onclick="resetAll()">üîÑ RESET</button>
        </div>
    </div>

    <div id="history-modal" style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 70%; max-height: 80vh; background: #161b22; border: 2px solid #d29922; border-radius: 12px; z-index: 2000; padding: 20px; overflow-y: auto; box-shadow: 0 0 100px rgba(0,0,0,0.8);">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid #30363d; padding-bottom: 10px;">
            <h2 style="color: #d29922; margin: 0;">HISTORIAL DE RESPUESTAS</h2>
            <button onclick="toggleHistory()" style="background: transparent; border: none; color: white; font-size: 20px; cursor: pointer;">‚úï</button>
        </div>
        <div id="full-history-list">
            <p style="text-align: center; color: gray;">Esperando respuestas...</p>
        </div>
    </div>

    <div id="turn-view" class="turn-container">
        <button id="next-btn" class="btn btn-blue" onclick="startRoulette()" style="font-size: 28px; padding: 20px 50px; border-radius: 50px; box-shadow: 0 10px 30px rgba(31, 111, 235, 0.3);">
            üé≤ GIRAR RULETA
        </button>

        <div id="roulette-display" class="roulette-box hidden">...</div>

        <div id="status-badge" class="status-badge hidden" style="margin-top: 30px; font-size: 1.2rem;"></div>
        
        <p id="instruction-hint" class="hidden" style="color: gray; margin-top: 20px; font-style: italic;">
            (La respuesta se guardar√° autom√°ticamente en el Historial)
        </p>
    </div>

    <div id="group-view" class="hidden">
        <div style="text-align: center; padding: 20px;">
            <button class="btn btn-action" onclick="organizeGroups()">‚≠ê DISTRIBUIR GRUPOS</button>
        </div>
        <div id="grouping-canvas">
            <div class="group-column group-1">
                <h3 style="color: #d2a8ff;">GRUPO 1</h3>
                <div id="g1-container" style="width: 100%; position: relative; flex-grow: 1;"></div>
            </div>
            <div class="group-column group-2">
                <h3 style="color: #79c0ff;">GRUPO 2</h3>
                <div id="g2-container" style="width: 100%; position: relative; flex-grow: 1;"></div>
            </div>
            <div class="group-column group-3">
                <h3 style="color: #56d364;">GRUPO 3</h3>
                <div id="g3-container" style="width: 100%; position: relative; flex-grow: 1;"></div>
            </div>
        </div>
    </div>

    <script>
        const GROUPS = {
            "Fatima zahra": 1, "Hamza": 1, "Othmane": 1, "Omar": 1,
            "Souhail": 2, "Zakariya": 2, "Marwa": 2, "Malak": 2,
            "Hiba": 3, "Aya G.": 3, "Aya B.": 3, "Aya Z.": 3
        };

        let studentsData = [];
        let currentSpeaker = null;
        let playedIDs = new Set();
        let lastGroupID = -1;
        let historyLog = [];

        async function init() {
            const res = await databases.listDocuments(CLIENT_CONFIG.databaseId, CLIENT_CONFIG.collectionId);
            studentsData = res.documents;

            client.subscribe(`databases.${CLIENT_CONFIG.databaseId}.collections.${CLIENT_CONFIG.collectionId}.documents`, response => {
                const doc = response.payload;
                const idx = studentsData.findIndex(s => s.$id === doc.$id);
                if (idx !== -1) studentsData[idx] = doc;
                
                // ‚úÖ ŸÖŸÜÿ∑ŸÇ ŸàÿµŸàŸÑ ÿßŸÑÿµŸàÿ™ (ÿ®ÿØŸàŸÜ ÿ™ŸÉÿ±ÿßÿ±)
                if (currentSpeaker && currentSpeaker.$id === doc.$id && doc.transcript && doc.transcript.length > 0) {
                    
                    const lastEntry = historyLog[0];
                    if (lastEntry && lastEntry.text === doc.transcript && lastEntry.name === doc.name) {
                        return;
                    }

                    const badge = document.getElementById('status-badge');
                    badge.className = "status-badge status-ready";
                    badge.innerText = "¬°AUDIO RECIBIDO! (Ver Historial)";
                    badge.style.background = "#238636";
                    
                    addToHistoryLog(doc);
                    document.getElementById('history-alert').classList.remove('hidden');

                    databases.updateDocument(CLIENT_CONFIG.databaseId, CLIENT_CONFIG.collectionId, currentSpeaker.$id, {
                        is_turn: false
                    });

                    document.getElementById('next-btn').disabled = false;
                }
            });
        }
        init();

        // --- 1. ROULETTE ---
        async function startRoulette() {
            const badge = document.getElementById('status-badge');
            badge.classList.add('hidden');
            badge.className = "status-badge";
            document.getElementById('instruction-hint').classList.add('hidden');
            
            // ‚úÖ ÿßŸÑŸÅŸÑÿ™ÿ±: ŸÅŸÇÿ∑ ÿßŸÑŸÖÿ™ÿµŸÑŸäŸÜ
            let candidates = studentsData.filter(s => 
                s.status === 'online' && 
                !playedIDs.has(s.$id)
            );

            if (candidates.length === 0) {
                // ÿ•ÿπÿßÿØÿ© ÿßŸÑÿ™ÿØŸàŸäÿ± ŸàŸÑŸÉŸÜ ŸÅŸÇÿ∑ ŸÑŸÑŸÖÿ™ÿµŸÑŸäŸÜ
                playedIDs.clear();
                candidates = studentsData.filter(s => s.status === 'online');
            }

            if (candidates.length === 0) { alert("¬°No hay alumnos conectados!"); return; }

            let bestCandidates = candidates.filter(s => GROUPS[s.name] !== lastGroupID);
            let finalPool = bestCandidates.length > 0 ? bestCandidates : candidates;

            const winner = finalPool[Math.floor(Math.random() * finalPool.length)];
            currentSpeaker = winner;
            lastGroupID = GROUPS[winner.name];
            playedIDs.add(winner.$id);

            const display = document.getElementById('roulette-display');
            display.classList.remove('hidden');
            document.getElementById('next-btn').disabled = true;

            let steps = 0;
            const interval = setInterval(async () => {
                // ŸÜÿÆÿ™ÿßÿ± ÿßÿ≥ŸÖ ÿπÿ¥Ÿàÿßÿ¶Ÿä ŸÖŸÜ "ÿßŸÑÿ≠ÿ∂Ÿàÿ± ŸÅŸÇÿ∑" ŸÑŸÑÿπÿ±ÿ∂
                const onlineStudents = studentsData.filter(s => s.status === 'online');
                const randomName = onlineStudents.length > 0 
                    ? onlineStudents[Math.floor(Math.random() * onlineStudents.length)].name 
                    : winner.name;
                
                display.innerText = randomName;
                steps++;

                if (steps >= 20) {
                    clearInterval(interval);
                    display.innerText = winner.name;
                    display.style.color = "#d29922";
                    display.style.transform = "scale(1.3)";
                    
                    badge.innerText = "ESPERANDO AUDIO...";
                    badge.classList.remove('hidden');
                    badge.classList.add('status-waiting');
                    badge.style.background = "#9e6a03";
                    
                    document.getElementById('instruction-hint').classList.remove('hidden');

                    await databases.updateDocument(CLIENT_CONFIG.databaseId, CLIENT_CONFIG.collectionId, winner.$id, {
                        is_turn: true,
                        transcript: "" 
                    });
                }
            }, 80);
        }

        // --- 2. HISTORIAL ---
        function addToHistoryLog(student) {
            const entry = { 
                name: student.name, 
                text: student.transcript, 
                time: new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})
            };
            historyLog.unshift(entry);
            renderHistoryLog();
        }

        function renderHistoryLog() {
            const list = document.getElementById('full-history-list');
            list.innerHTML = "";
            if (historyLog.length === 0) {
                list.innerHTML = '<p style="text-align: center; color: gray;">Esperando respuestas...</p>';
                return;
            }
            historyLog.forEach(item => {
                const div = document.createElement('div');
                div.style.background = "#0d1117";
                div.style.border = "1px solid #30363d";
                div.style.borderRadius = "8px";
                div.style.padding = "15px";
                div.style.marginBottom = "10px";
                div.innerHTML = `
                    <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                        <span style="color: #58a6ff; font-weight: bold; font-size: 1.1em;">${item.name}</span>
                        <span style="color: gray; font-size: 0.8em;">${item.time}</span>
                    </div>
                    <div style="color: #e6edf3; font-size: 1.2em;">"${item.text}"</div>
                `;
                list.appendChild(div);
            });
        }

        function toggleHistory() {
            const modal = document.getElementById('history-modal');
            if (modal.style.display === 'block') {
                modal.style.display = 'none';
            } else {
                modal.style.display = 'block';
                document.getElementById('history-alert').classList.add('hidden');
            }
        }

        // --- 3. GROUPS ---
        function organizeGroups() {
            document.querySelectorAll('.student-chip').forEach(e => e.remove());
            // ŸÅŸÇÿ∑ ÿßŸÑŸÖÿ™ÿµŸÑŸäŸÜ
            const activeStudents = studentsData.filter(s => s.status === 'online');
            
            activeStudents.forEach((s, index) => {
                const grp = GROUPS[s.name] || 2;
                const chip = document.createElement('div');
                chip.className = 'student-chip';
                chip.innerText = s.name;
                chip.style.left = "50%"; chip.style.top = "50%"; chip.style.transform = "translate(-50%, -50%) scale(0)";
                document.getElementById('grouping-canvas').appendChild(chip);

                setTimeout(() => {
                    chip.style.position = "relative";
                    chip.style.left = "auto"; chip.style.top = "auto";
                    chip.style.transform = "scale(1)"; chip.style.margin = "5px 0";
                    document.getElementById(`g${grp}-container`).appendChild(chip);
                }, 100 + (index * 100));
            });
        }

        function switchMode(mode) {
            document.getElementById('turn-view').classList.add('hidden');
            document.getElementById('group-view').classList.add('hidden');
            
            if(mode === 'turn') { 
                document.getElementById('turn-view').classList.remove('hidden'); 
                document.getElementById('mode-title').innerText = "MODO: RULETA"; 
            } else if(mode === 'group') { 
                document.getElementById('group-view').classList.remove('hidden'); 
                document.getElementById('grouping-canvas').style.display = 'block'; 
                document.getElementById('mode-title').innerText = "MODO: GRUPOS"; 
            }
        }

        async function resetAll() {
            if(confirm("¬øEst√°s seguro de reiniciar todo?")) {
                studentsData.forEach(s => databases.updateDocument(CLIENT_CONFIG.databaseId, CLIENT_CONFIG.collectionId, s.$id, { status: 'offline', cheated: false, is_turn: false, transcript: "" }));
                location.reload();
            }
        }
    </script>
</body>
</html>